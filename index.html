<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<link rel="alternate"
      type="application/rss+xml"
      href="https://magnus.therning.org/feed.xml"
      title="RSS feed for https://magnus.therning.org/">
<title>Magnus web site</title>
<meta name="author" content="Magnus Therning"><meta name="referrer" content="no-referrer"><link href= "static/style.css" rel="stylesheet" type="text/css" /><link href= "static/htmlize.css" rel="stylesheet" type="text/css" /><link href= "static/extra_style.css" rel="stylesheet" type="text/css" /></head>
<body>
<div id="preamble" class="status"><div class="nav-bar"><a class="nav-link" href="./index.html">Top</a><a class="nav-link" href="./archive.html">Archive</a><a class="nav-link align-right" href="./feed.xml"><img src="static/rss-feed-icon.png" style="height: 24px;" /></a></div></div>
<div id="content">
<header class="site-header" role="banner"><h1 class="title">Magnus web site</h1><h2 class="subtitle">Random stuff</h2></header>
<div class="post-date">25 Jan 2026</div><h1 class="post-title"><a href="https://magnus.therning.org/2026-01-25-more-on-the-switch-to-eglot.html">More on the switch to eglot</a></h1>
<p>
Since the <a href="https://magnus.therning.org/2026-01-19-trying-eglot,-again.html">switching to eglot</a> I've ended up making a few related changes.
</p>
<div id="outline-container-org8cdfce1" class="outline-2">
<h2 id="org8cdfce1">Replacing flycheck with flymake</h2>
<div class="outline-text-2" id="text-org8cdfce1">
<p>
Since <code>eglot</code> it's written to work with other packages in core, which means it
integrates with <a href="https://www.gnu.org/software/emacs/manual/html_mono/flymake.html"><code>flymake</code></a>. The switch comprised
</p>

<ul class="org-ul">
<li>Use <code>:ensure nil</code> to make sure <code>elpaca</code> knows there's nothing to download.</li>
<li>Add a call to <code>flymake-mode</code> to <code>prog-mode-hook</code>.</li>
<li>Define two functions to toggle showing a list of diagnostics for the current
buffer and the project.</li>
<li></li>

<li>Redefine the relevant keybindings.</li>
</ul>

<p>
The two functions for toggling showing diagnostics look like this
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><code><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defun</span> <span class="org-function-name">mes/toggle-flymake-buffer-diagnostics</span> <span class="org-rainbow-delimiters-depth-2">()</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">interactive</span><span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">if-let*</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-rainbow-delimiters-depth-4">(</span>window <span class="org-rainbow-delimiters-depth-5">(</span>get-buffer-window <span class="org-rainbow-delimiters-depth-6">(</span>flymake--diagnostics-buffer-name<span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>
      <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-keyword">save-selected-window</span> <span class="org-rainbow-delimiters-depth-4">(</span>quit-window nil window<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>
    <span class="org-rainbow-delimiters-depth-3">(</span>flymake-show-buffer-diagnostics<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defun</span> <span class="org-function-name">mes/toggle-flymake-project-diagnostics</span> <span class="org-rainbow-delimiters-depth-2">()</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">interactive</span><span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">if-let*</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-rainbow-delimiters-depth-4">(</span>window <span class="org-rainbow-delimiters-depth-5">(</span>get-buffer-window <span class="org-rainbow-delimiters-depth-6">(</span>flymake--project-diagnostics-buffer <span class="org-rainbow-delimiters-depth-7">(</span>projectile-project-root<span class="org-rainbow-delimiters-depth-7">)</span><span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>
      <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-keyword">save-selected-window</span> <span class="org-rainbow-delimiters-depth-4">(</span>quit-window nil window<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>
    <span class="org-rainbow-delimiters-depth-3">(</span>flymake-show-project-diagnostics<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</code></pre>
</div>

<p>
And the changed keybindings are
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">flycheck</th>
<th scope="col" class="org-left">flymake</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">flycheck-next-error</td>
<td class="org-left">flymake-goto-next-error</td>
</tr>

<tr>
<td class="org-left">flycheck-previous-error</td>
<td class="org-left">flymake-goto-prev-error</td>
</tr>

<tr>
<td class="org-left">mes/toggle-flycheck-error-list</td>
<td class="org-left">mes/toggle-flymake-buffer-diagnostics</td>
</tr>

<tr>
<td class="org-left">mes/toggle-flycheck-projectile-error-list</td>
<td class="org-left">mes/toggle-flymake-project-diagnostics</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="outline-container-orgadc4f2e" class="outline-2">
<h2 id="orgadc4f2e">Using <code>with-eval-after-load</code> instead of <code>:after eglot</code></h2>
<div class="outline-text-2" id="text-orgadc4f2e">
<p>
When it comes to <code>use-package</code> I keep on being surprised, and after the switch
to <code>elpaca</code> I've found some new surprises. One of them was that using <code>:after
eglot</code> like this
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><code><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">use-package</span> haskell-ng-mode
  <span class="org-builtin">:afer</span> eglot
  <span class="org-builtin">:ensure</span> <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-builtin">:type</span> git
           <span class="org-builtin">:repo</span> <span class="org-string">"git@gitlab.com:magus/haskell-ng-mode.git"</span>
           <span class="org-builtin">:branch</span> <span class="org-string">"main"</span><span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-builtin">:init</span>
  <span class="org-rainbow-delimiters-depth-2">(</span>add-to-list 'major-mode-remap-alist '<span class="org-rainbow-delimiters-depth-3">(</span>haskell-mode . haskell-ng-mode<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">(</span>add-to-list 'eglot-server-programs '<span class="org-rainbow-delimiters-depth-3">(</span>haskell-ng-mode <span class="org-string">"haskell-language-server-wrapper"</span> <span class="org-string">"--lsp"</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">setq-default</span> eglot-workspace-configuration
                <span class="org-rainbow-delimiters-depth-3">(</span>plist-put eglot-workspace-configuration
                           <span class="org-builtin">:haskell</span>
                           '<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-builtin">:formattingProvider</span> <span class="org-string">"fourmolu"</span>
                             <span class="org-builtin">:plugin</span> <span class="org-rainbow-delimiters-depth-5">(</span><span class="org-builtin">:stan</span> <span class="org-rainbow-delimiters-depth-6">(</span><span class="org-builtin">:global-on</span> <span class="org-builtin">:json-false</span><span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>
  ...
  <span class="org-builtin">:hook</span>
  <span class="org-rainbow-delimiters-depth-2">(</span>haskell-ng-mode . eglot-ensure<span class="org-rainbow-delimiters-depth-2">)</span>
  ...<span class="org-rainbow-delimiters-depth-1">)</span>
</code></pre>
</div>

<p>
would delay initialisation until after <code>eglot</code> had been loaded. However, it
turned out that nothing in <code>:init ...</code> seemed to run and upon opening a haskell file
no mode was loaded.
</p>

<p>
After a bit of thinking and tinkering I got it working by removing <code>:after
eglot</code> and using <code>with-eval-after-load</code>
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><code><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">use-package</span> haskell-ng-mode
  <span class="org-builtin">:ensure</span> <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-builtin">:type</span> git
           <span class="org-builtin">:repo</span> <span class="org-string">"git@gitlab.com:magus/haskell-ng-mode.git"</span>
           <span class="org-builtin">:branch</span> <span class="org-string">"main"</span><span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-builtin">:init</span>
  <span class="org-rainbow-delimiters-depth-2">(</span>add-to-list 'major-mode-remap-alist '<span class="org-rainbow-delimiters-depth-3">(</span>haskell-mode . haskell-ng-mode<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">with-eval-after-load</span> 'eglot
    <span class="org-rainbow-delimiters-depth-3">(</span>add-to-list 'eglot-server-programs '<span class="org-rainbow-delimiters-depth-4">(</span>haskell-ng-mode <span class="org-string">"haskell-language-server-wrapper"</span> <span class="org-string">"--lsp"</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>
    <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-keyword">setq-default</span> eglot-workspace-configuration
                  <span class="org-rainbow-delimiters-depth-4">(</span>plist-put eglot-workspace-configuration
                             <span class="org-builtin">:haskell</span>
                             '<span class="org-rainbow-delimiters-depth-5">(</span><span class="org-builtin">:formattingProvider</span> <span class="org-string">"fourmolu"</span>
                               <span class="org-builtin">:plugin</span> <span class="org-rainbow-delimiters-depth-6">(</span><span class="org-builtin">:stan</span> <span class="org-rainbow-delimiters-depth-7">(</span><span class="org-builtin">:global-on</span> <span class="org-builtin">:json-false</span><span class="org-rainbow-delimiters-depth-7">)</span><span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>
  ...
  <span class="org-builtin">:hook</span>
  <span class="org-rainbow-delimiters-depth-2">(</span>haskell-ng-mode . eglot-ensure<span class="org-rainbow-delimiters-depth-2">)</span>
  ...<span class="org-rainbow-delimiters-depth-1">)</span>
</code></pre>
</div>

<p>
That change worked for haskell, and it seemed to work for python too, but after
a little while I realised that python needed a bit more attention.
</p>
</div>
</div>
<div id="outline-container-orgc610d55" class="outline-2">
<h2 id="orgc610d55">Getting the configuration for Python to work properly</h2>
<div class="outline-text-2" id="text-orgc610d55">
<p>
The python setup looked like this
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><code><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">use-package</span> python
  <span class="org-builtin">:init</span>
  <span class="org-rainbow-delimiters-depth-2">(</span>add-to-list 'major-mode-remap-alist '<span class="org-rainbow-delimiters-depth-3">(</span>python-mode . python-ts-mode<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">with-eval-after-load</span> 'eglot
    <span class="org-rainbow-delimiters-depth-3">(</span>assoc-delete-all '<span class="org-rainbow-delimiters-depth-4">(</span>python-mode python-ts-mode<span class="org-rainbow-delimiters-depth-4">)</span> eglot-server-programs<span class="org-rainbow-delimiters-depth-3">)</span>
    <span class="org-rainbow-delimiters-depth-3">(</span>add-to-list 'eglot-server-programs
                 `<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-rainbow-delimiters-depth-5">(</span>python-mode python-ts-mode<span class="org-rainbow-delimiters-depth-5">)</span> . ,<span class="org-rainbow-delimiters-depth-5">(</span>eglot-alternatives
                                                    '<span class="org-rainbow-delimiters-depth-6">(</span><span class="org-rainbow-delimiters-depth-7">(</span><span class="org-string">"rass"</span> <span class="org-string">"python"</span><span class="org-rainbow-delimiters-depth-7">)</span> <span class="org-string">"pylsp"</span><span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>
  ...
  <span class="org-builtin">:hook</span> <span class="org-rainbow-delimiters-depth-2">(</span>python-ts-mode . eglot-ensure<span class="org-rainbow-delimiters-depth-2">)</span>
  ...<span class="org-rainbow-delimiters-depth-1">)</span>
</code></pre>
</div>

<p>
and it worked all right, but then I visited the package (using <code>elpaca-visit</code>)
and realised that the downloaded package was all of emacs. That's a bit of
overkill, I'd say.
</p>

<p>
However, adding <code>:ensure nil</code> didn't have the expected effect of just using the
version that's in core. Instead the whole configuration seemed to never take
effect and again I was back to the situation where I had to jump to
<code>python-ts-mode</code> manually.
</p>

<p>
The documentation for <code>use-package</code> says that <code>:init</code> is for
</p>

<blockquote>
<p>
Code to run before PACKAGE-NAME has been loaded.
</p>
</blockquote>

<p>
but I'm guessing "before" isn't quite before enough. Then I noticed <code>:preface</code>
with the description
</p>

<blockquote>
<p>
Code to be run before everything except <code>:disabled</code>; this can be used to define
functions for use in <code>:if</code>, or that should be seen by the byte-compiler.
</p>
</blockquote>

<p>
and yes, "before everything" is early enough. The final python configuration
looks like this
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><code><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">use-package</span> python
  <span class="org-builtin">:ensure</span> nil
  <span class="org-builtin">:preface</span>
  <span class="org-rainbow-delimiters-depth-2">(</span>add-to-list 'major-mode-remap-alist '<span class="org-rainbow-delimiters-depth-3">(</span>python-mode . python-ts-mode<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-builtin">:init</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">with-eval-after-load</span> 'eglot
    <span class="org-rainbow-delimiters-depth-3">(</span>assoc-delete-all '<span class="org-rainbow-delimiters-depth-4">(</span>python-mode python-ts-mode<span class="org-rainbow-delimiters-depth-4">)</span> eglot-server-programs<span class="org-rainbow-delimiters-depth-3">)</span>
    <span class="org-rainbow-delimiters-depth-3">(</span>add-to-list 'eglot-server-programs
                 `<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-rainbow-delimiters-depth-5">(</span>python-mode python-ts-mode<span class="org-rainbow-delimiters-depth-5">)</span> . ,<span class="org-rainbow-delimiters-depth-5">(</span>eglot-alternatives
                                                    '<span class="org-rainbow-delimiters-depth-6">(</span><span class="org-rainbow-delimiters-depth-7">(</span><span class="org-string">"rass"</span> <span class="org-string">"python"</span><span class="org-rainbow-delimiters-depth-7">)</span> <span class="org-string">"pylsp"</span><span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>
  ...
  <span class="org-builtin">:hook</span> <span class="org-rainbow-delimiters-depth-2">(</span>python-ts-mode . eglot-ensure<span class="org-rainbow-delimiters-depth-2">)</span>
  ...<span class="org-rainbow-delimiters-depth-1">)</span>
</code></pre>
</div>
</div>
</div>
<div id="outline-container-orgc2d0d13" class="outline-2">
<h2 id="orgc2d0d13">Closing remark</h2>
<div class="outline-text-2" id="text-orgc2d0d13">
<p>
I'm still not sure I have the correct intuition about how to use <code>use-package</code>,
but hopefully it's <i>more</i> correct now than before. I have a growing suspicion
that <code>use-package</code> changes behaviour based on the package manager I use. Or
maybe it's just that some package managers make <code>use-package</code> more forgiving of
bad use.
</p>
</div>
</div>
<div class="taglist"><a href="https://magnus.therning.org/tags.html">Tags</a>: <a href="https://magnus.therning.org/tag-eglot.html">eglot</a> <a href="https://magnus.therning.org/tag-emacs.html">emacs</a> </div>

<div class="post-date">19 Jan 2026</div><h1 class="post-title"><a href="https://magnus.therning.org/2026-01-19-trying-eglot,-again.html">Trying eglot, again</a></h1>
<p>
I've been using <a href="https://emacs-lsp.github.io/lsp-mode/">lsp-mode</a> since I switched to Emacs several years ago. When <a href="https://github.com/joaotavora/eglot">eglot</a>
made into Emacs core I used it very briefly but quickly switched back. Mainly I
found eglot a bit too bare-bones; I liked some of the bells and whistles of
<code>lsp-ui</code>. Fast-forward a few years and I've grown a bit tired of those bells and
whistles. Specifically that it's difficult to make <code>lsp-ui-sideline</code> and
<code>lsp-ui-doc</code> work well together. <code>lsp-ui-sidedline</code> is shown on the right side,
which is good, but combining it with <code>lsp-ui-doc</code> leads to situations where the
popup covers the sideline. What I've done so far is centre the line to bring the
sideline text out. I was playing a little bit with making the setting of
<code>lsp-ui-doc-position</code> change depending on the location of the current position.
It didn't work that well though so I decided to try to find a simpler setup.
Instead of simplifying the setup of <code>lsp-config</code> I thought I'd give <code>eglot</code>
another shot.
</p>
<div id="outline-container-orgb1f7433" class="outline-2">
<h2 id="orgb1f7433">Basic setup</h2>
<div class="outline-text-2" id="text-orgb1f7433">
<p>
I removed the statements pulling in <code>lsp-mode</code>, <code>lsp-ui</code>, and all
language-specific packages like <code>lsp-haskell</code>. Then I added this to configure
<code>eglot</code>
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><code><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">use-package</span> eglot
  <span class="org-builtin">:ensure</span> nil
  <span class="org-builtin">:custom</span>
  <span class="org-rainbow-delimiters-depth-2">(</span>eglot-autoshutdown t<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">(</span>eglot-confirm-server-edits '<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-rainbow-delimiters-depth-4">(</span>eglot-rename . nil<span class="org-rainbow-delimiters-depth-4">)</span>
                                <span class="org-rainbow-delimiters-depth-4">(</span>t . diff<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</code></pre>
</div>

<p>
The rest was mainly just switching <code>lsp-mode</code> functions for <code>eglot</code> functions.
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">lsp-mode function</th>
<th scope="col" class="org-left">eglot function</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>lsp-deferred</code></td>
<td class="org-left"><code>eglot-ensure</code></td>
</tr>

<tr>
<td class="org-left"><code>lsp-describe-thing-at-point</code></td>
<td class="org-left"><code>eldoc</code></td>
</tr>

<tr>
<td class="org-left"><code>lsp-execute-code-action</code></td>
<td class="org-left"><code>eglot-code-actions</code></td>
</tr>

<tr>
<td class="org-left"><code>lsp-find-type-definition</code></td>
<td class="org-left"><code>eglot-find-typeDefinition</code></td>
</tr>

<tr>
<td class="org-left"><code>lsp-format-buffer</code></td>
<td class="org-left"><code>eglot-format-buffer</code></td>
</tr>

<tr>
<td class="org-left"><code>lsp-format-region</code></td>
<td class="org-left"><code>eglot-format</code></td>
</tr>

<tr>
<td class="org-left"><code>lsp-organize-imports</code></td>
<td class="org-left"><code>eglot-code-action-organize-imports</code></td>
</tr>

<tr>
<td class="org-left"><code>lsp-rename</code></td>
<td class="org-left"><code>eglot-rename</code></td>
</tr>

<tr>
<td class="org-left"><code>lsp-workspace-restart</code></td>
<td class="org-left"><code>eglot-reconnect</code></td>
</tr>

<tr>
<td class="org-left"><code>lsp-workspace-shutdown</code></td>
<td class="org-left"><code>eglot-shutdown</code></td>
</tr>
</tbody>
</table>

<p>
I haven't verified that the list is fully correct yet, but it looks good so far.
</p>

<p>
The one thing I might miss is lenses, and using <code>lsp-avy-lens</code>. However,
everything that I use lenses for can be done using actions, and to be honest I
don't think I'll miss the huge lens texts from missing type annotations in
Haskell.
</p>
</div>
</div>
<div id="outline-container-orgd8ac829" class="outline-2">
<h2 id="orgd8ac829">Configuration</h2>
<div class="outline-text-2" id="text-orgd8ac829">
<p>
One good thing about <code>lsp-mode</code>'s use of language-specific packages is that
configuration of the various servers is performed through functions. This makes
it easy to discover what options are available, though it also means not all
options may be available. In <code>eglot</code> configuration is less organised, I have to
know about the options for each language server and put the options into
<code>eglot-workspace-configuration</code> myself. It's not always easy to track down what
options are available, and I've found no easy way to verify the settings. For
instance, with <code>lsp-mode</code> I configures <a href="https://github.com/haskell/haskell-language-server">HLS</a> like this
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><code><span class="org-rainbow-delimiters-depth-1">(</span>lsp-haskell-formatting-provider <span class="org-string">"fourmolu"</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span>lsp-haskell-plugin-stan-global-on nil<span class="org-rainbow-delimiters-depth-1">)</span>
</code></pre>
</div>

<p>
which translates to this for <code>eglot</code>
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><code><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">setq-default</span> eglot-workspace-configuration
              <span class="org-rainbow-delimiters-depth-2">(</span>plist-put eglot-workspace-configuration
                         <span class="org-builtin">:haskell</span>
                         '<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-builtin">:formattingProvider</span> <span class="org-string">"fourmolu"</span>
                           <span class="org-builtin">:plugin</span> <span class="org-rainbow-delimiters-depth-4">(</span><span class="org-builtin">:stan</span> <span class="org-rainbow-delimiters-depth-5">(</span><span class="org-builtin">:global-on</span> <span class="org-builtin">:json-false</span><span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</code></pre>
</div>

<p>
and I can verify that this configuration has taken effect because I know enough
about the Haskell tools.
</p>

<p>
I do some development in Python and I used to configure <a href="https://pypi.org/project/python-lsp-server/">pylsp</a> like this
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><code><span class="org-rainbow-delimiters-depth-1">(</span>lsp-pylsp-plugins-mypy-enabled t<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span>lsp-pylsp-plugins-ruff-enabled t<span class="org-rainbow-delimiters-depth-1">)</span>
</code></pre>
</div>

<p>
which I <i>think</i> translates to this for <code>eglot</code>
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><code><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">setq-default</span> eglot-workspace-configuration
              <span class="org-rainbow-delimiters-depth-2">(</span>plist-put eglot-workspace-configuration
                         <span class="org-builtin">:pylsp</span>
                         '<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-builtin">:plugins</span> <span class="org-rainbow-delimiters-depth-4">(</span><span class="org-builtin">:ruff</span> <span class="org-rainbow-delimiters-depth-5">(</span><span class="org-builtin">:enabled</span> t<span class="org-rainbow-delimiters-depth-5">)</span>
                                     <span class="org-builtin">:mypy</span> <span class="org-rainbow-delimiters-depth-5">(</span><span class="org-builtin">:enabled</span> t<span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</code></pre>
</div>

<p>
but I don't know any convenient way of verifying these settings. I'm simply not
familiar enough with the Python tools. I can check the value of
<code>eglot-workspace-configuration</code> by inspecting it or calling
<code>eglot-show-workspace-configuration</code> but is there really no way of asking the
language server for its active configuration?
</p>
</div>
</div>
<div id="outline-container-org3d20108" class="outline-2">
<h2 id="org3d20108">Closing remark</h2>
<div class="outline-text-2" id="text-org3d20108">
<p>
The last time I gave up on <code>eglot</code> very quickly, probably too quickly to be
honest. I made these changes to my configuration over the weekend, so the real
test of <code>eglot</code> starts when I'm back in the office. I have a feeling I'll stick
to it longer this time.
</p>
</div>
</div>
<div class="taglist"><a href="https://magnus.therning.org/tags.html">Tags</a>: <a href="https://magnus.therning.org/tag-eglot.html">eglot</a> <a href="https://magnus.therning.org/tag-emacs.html">emacs</a> <a href="https://magnus.therning.org/tag-lsp-mode.html">lsp-mode</a> </div>

<div class="post-date">04 Jan 2026</div><h1 class="post-title"><a href="https://magnus.therning.org/2026-01-04-validation-of-data-in-a-servant-server.html">Validation of data in a servant server</a></h1>
<p>
I've been playing around with adding more validation of data received by an HTTP
endpoint in a <a href="https://hackage.haskell.org/package/servant">servant</a> server. Defining a type with a <code>FromJSON</code> instance is very
easy, just derive a <code>Generic</code> instance and it just works. Here's a simple
example
</p>

<div class="org-src-container">
<pre class="src src-haskell"><code><span class="org-keyword">data</span> Person = Person
    { name :: <span class="org-type">Text</span>
    , age :: <span class="org-type">Int</span>
    , occupation :: <span class="org-type">Occupation</span>
    }
    <span class="org-keyword">deriving</span> (Generic, Show)
    <span class="org-keyword">deriving</span> (FromJSON, ToJSON) via <span class="org-type">(Generically Person)</span>

<span class="org-keyword">data</span> Occupation = UnderAge | Student | Unemployed | SelfEmployed | Retired | Occupation <span class="org-type">Text</span>
    <span class="org-keyword">deriving</span> (Eq, Generic, Ord, Show)
    <span class="org-keyword">deriving</span> (FromJSON, ToJSON) via <span class="org-type">(Generically Occupation)</span>
</code></pre>
</div>

<p>
However, the validation is rather limited, basically it's just checking that
each field is present and of the correct type. For the type above I'd like to
enforce some constraints for the combination of <code>age</code> and <code>occupation</code>.
</p>

<p>
The steps I thought of are
</p>

<ol class="org-ol">
<li>Hide the default constructor and define a <a href="https://wiki.haskell.org/Smart_constructors">smart</a> one. (This is the standard
suggestion for placing extra constraints values.)</li>
<li>Manually define the <code>FromJSON</code> instance using the <code>Generic</code> instance to limit
the amount of code and the smart constructor.</li>
</ol>
<div id="outline-container-org8b6637c" class="outline-2">
<h2 id="org8b6637c">The smart constructor</h2>
<div class="outline-text-2" id="text-org8b6637c">
<p>
I give the constructor the result type <code>Either String Person</code> to make sure it
can both be usable in code and when defining <code>parseJSON</code>.
</p>

<div class="org-src-container">
<pre class="src src-haskell"><code><span class="org-function-name">mkPerson</span> :: <span class="org-type">Text</span> <span class="org-operator">-&gt;</span> <span class="org-type">Int</span> <span class="org-operator">-&gt;</span> <span class="org-type">Occupation</span> <span class="org-operator">-&gt;</span> <span class="org-type">Either String Person</span>
<span class="org-function-name">mkPerson</span> name age occupation = <span class="org-keyword">do</span>
    guardE mustBeUnderAge
    guardE notUnderAge
    guardE tooOldToBeStudent
    guardE mustBeRetired
    pure <span class="org-operator">$</span> Person name age occupation
  <span class="org-keyword">where</span>
    <span class="org-function-name">guardE</span> (pred, err) = when pred <span class="org-operator">$</span> Left err
    <span class="org-function-name">mustBeUnderAge</span> = (age <span class="org-operator">&lt;</span> <span class="org-number">8</span> <span class="org-operator">&amp;&amp;</span> occupation <span class="org-operator">&gt;</span> UnderAge, <span class="org-string">"too young for occupation"</span>)
    <span class="org-function-name">notUnderAge</span> = (age <span class="org-operator">&gt;</span> <span class="org-number">15</span> <span class="org-operator">&amp;&amp;</span> occupation <span class="org-operator">==</span> UnderAge, <span class="org-string">"too old to be under age"</span>)
    <span class="org-function-name">tooOldToBeStudent</span> = (age <span class="org-operator">&gt;</span> <span class="org-number">45</span> <span class="org-operator">&amp;&amp;</span> occupation <span class="org-operator">==</span> Student, <span class="org-string">"too old to be a student"</span>)
    <span class="org-function-name">mustBeRetired</span> = (age <span class="org-operator">&gt;</span> <span class="org-number">65</span> <span class="org-operator">&amp;&amp;</span> occupation <span class="org-operator">/=</span> Retired, <span class="org-string">"too old to not be retired"</span>)
</code></pre>
</div>

<p>
Here I'm making use of <code>Either e</code> being a <code>Monad</code> and use <code>when</code> to apply the
constraints and ensure the reason for failure is given to the caller.
</p>
</div>
</div>
<div id="outline-container-org323ebdf" class="outline-2">
<h2 id="org323ebdf">The <code>FromJSON</code> instance</h2>
<div class="outline-text-2" id="text-org323ebdf">
<p>
When defining the instance I take advantage of the <code>Generic</code> instance to make
the implementation short and simple.
</p>

<div class="org-src-container">
<pre class="src src-haskell"><code><span class="org-keyword">instance</span> FromJSON <span class="org-type">Person</span> <span class="org-keyword">where</span>
    <span class="org-function-name">parseJSON</span> v = <span class="org-keyword">do</span>
        Person{name, age, occupation} &lt;- genericParseJSON defaultOptions v
        either fail pure <span class="org-operator">$</span> mkPerson name age occupation
</code></pre>
</div>

<p>
If there are many more fields in the type I'd consider using <a href="https://downloads.haskell.org/ghc/latest/docs/users_guide/exts/record_wildcards.html"><code>RecordWildCards</code></a>.
</p>
</div>
</div>
<div id="outline-container-orgb6bf602" class="outline-2">
<h2 id="orgb6bf602">Conclusion</h2>
<div class="outline-text-2" id="text-orgb6bf602">
<p>
No, it's nothing ground-breaking but I think it's a fairly nice example of how
things can fit together in Haskell.
</p>
</div>
</div>
<div class="taglist"><a href="https://magnus.therning.org/tags.html">Tags</a>: <a href="https://magnus.therning.org/tag-haskell.html">haskell</a> <a href="https://magnus.therning.org/tag-servant.html">servant</a> </div>

<div class="post-date">08 Nov 2025</div><h1 class="post-title"><a href="https://magnus.therning.org/2025-11-08-making-a-theme-based-on-modus.html">Making a theme based on modus</a></h1>
<p>
In <code>modus-theme</code> 5.0.0 Prot introduced a structured way to build a theme based
on modus. Just a few days ago he released version 5.1.0 with some improvements
in this area.
</p>

<p>
The official documentation of how to <a href="https://protesilaos.com/emacs/modus-themes#h:86eb375b-9be4-43ce-879a-0686a524a63b">build on top of the Modus themes</a> is very
good. It's focused on how to make sure your theme fits in with the rest of the
"modus universe". However, after reading it I still didn't have a good idea of
how to get started with my own theme. In case others feel the same way I thought
I'd write down how I ended up getting started.
</p>

<p>
The resulting theme, <code>modus-catppuccin</code>, can be found <a href="https://gitlab.com/magus/modus-catppuccin">here</a>.
</p>
<div id="outline-container-org4839f2f" class="outline-2">
<h2 id="org4839f2f">A little background</h2>
<div class="outline-text-2" id="text-org4839f2f">
<p>
I read about how to <a href="https://www.rahuljuliato.com/posts/modus-catppuccin">create a catppuccin-mocha theme using modus-vivendi</a> through
modus' mechanism of overrides. On Reddit someone pointed out that Prot had been
working on basing themes on modus and when I checked the state of it he'd just
released version 5.0.0. Since I'm using catppuccin themes for pretty much all
software with a GUI I thought it could be interesting to see if I could make a
modus-based catppuccin theme to replace my use of <a href="https://github.com/catppuccin/emacs"><code>catppuccin-theme</code></a>.
</p>

<p>
I'm writing the rest as if it was a straight and easy journey. It wasn't! I made
a few false starts, each time realising something new about the structure and
starting over with a better idea.
</p>
</div>
</div>
<div id="outline-container-org61bc0bd" class="outline-2">
<h2 id="org61bc0bd">Finding a starting point</h2>
<div class="outline-text-2" id="text-org61bc0bd">
<p>
When reading what Prot had written about <code>modus-themes</code> in general, and about
how to create themes based on it, in particular, I found that he's ported both
<a href="https://github.com/protesilaos/standard-themes"><code>standard-themes</code></a> and <a href="https://github.com/protesilaos/ef-themes"><code>ef-themes</code></a> so they now are based on modus. Instead of
just using them for inspiration I decided that since <code>standard-themes</code> is so
small I might as well use it as my starting point.
</p>
</div>
</div>
<div id="outline-container-org8f0c803" class="outline-2">
<h2 id="org8f0c803">Starting</h2>
<div class="outline-text-2" id="text-org8f0c803">
<p>
I copied all files of <code>standard-themes</code> to an empty git repository, then I
</p>

<ul class="org-ul">
<li>deleted all but one of the theme file</li>
<li>copied the remaining theme file so I had four in total (one for each of the
<a href="https://catppuccin.com/palette/">catppuccin flavours</a>)</li>
<li>renamed constants, variables, and functions so they would match the
theme and its flavours</li>
<li>put the colours into each <code>catppuccin-&lt;flavour&gt;-palette</code></li>
<li>emptied the common palette, <code>modus-catppuccin-common-palette-mappings</code></li>
<li>made sure that my use of <code>modus-themes-theme</code> was reasonable, in particular
the base palette (I based the light flavour on <code>modus-operandi</code> and the three
dark flavours on <code>modus-vivendi</code>)</li>
</ul>

<p>
The result can be seen <a href="https://gitlab.com/magus/modus-catppuccin/-/tree/c86e17d29e0fc8f0d4a6a2e94a475f32037d2851">here</a>.
</p>

<p>
At this point the three theme flavours contained no relevant mappings of their
own, so what I had was in practice <code>modus-operandi</code> under a new name and
<code>modus-vivendi</code> under three new names.
</p>
</div>
</div>
<div id="outline-container-org28309d9" class="outline-2">
<h2 id="org28309d9">Adding mappings for catppuccin</h2>
<div class="outline-text-2" id="text-org28309d9">
<p>
By organising the theme flavours the way outlined above I only need to add
mappings to <code>modus-catppuccin-common-palette-mappings</code> because
</p>

<ol class="org-ol">
<li>each flavour-specific mapping adds its colour palette using the same name
(that's how catppuccin organises its colors too, <a href="https://catppuccin.com/palette/">as seen here</a>)</li>
<li>each flavour-specific mapping is combined with the common one</li>
<li>any missing mapping is picked up by the underlying theme, <code>modus-operandi</code> or
<code>modus-vivendi</code>, so there will be (somewhat) nice colours for everything</li>
</ol>

<p>
I started out with the mappings in the <a href="https://github.com/protesilaos/standard-themes/blob/main/standard-dark-theme.el">dark standard theme</a> but then I realised
that's not the complete list of available mappings and I started looking at the
themes in <code>modus-themes</code> itself.
</p>
</div>
</div>
<div id="outline-container-orgeb19297" class="outline-2">
<h2 id="orgeb19297">Current state of <code>modus-catppuccin</code></h2>
<div class="outline-text-2" id="text-orgeb19297">
<p>
I've so far defined enough mappings to make it look enough like catppuccin for
my use. There are a lot of possible mappings so my plan is to add them over time
and use <a href="https://github.com/catppuccin/emacs"><code>catppuccin-theme</code></a> for inspiration.
</p>
</div>
</div>
<div class="taglist"><a href="https://magnus.therning.org/tags.html">Tags</a>: <a href="https://magnus.therning.org/tag-emacs.html">emacs</a> </div>

<div class="post-date">16 Sep 2025</div><h1 class="post-title"><a href="https://magnus.therning.org/2025-09-16-listing-buffers-by-tab-using-consult-and-bufferlo.html">Listing buffers by tab using consult and bufferlo</a></h1>
<p>
I've gotten into the habit of using tabs, via <code>tab-bar</code>, to organise my buffers
when I have multiple projects open at once. Each project has its own tab.
There's nothing fancy here (yet), I simply open a new tab manually before
opening a new project.
</p>

<p>
A while ago I added <a href="https://github.com/florommel/bufferlo">bufferlo</a> to my config to help with getting <code>consult-buffer</code>
to organise buffers (somewhat) by tab. I copied the configuration from <a href="https://github.com/florommel/bufferlo?tab=readme-ov-file#consult">the
bufferlo README</a> and started using it. It took me a little while to notice that
the behaviour wasn't quite what I wanted. It seemed like one buffer "leaked"
from another tab.
</p>


<figure id="org1786323">
<img src="static/2025-09-16-buffer-leakage.png" alt="2025-09-16-buffer-leakage.png">

<figcaption><span class="figure-number">Figure 1: </span>Example of buffer leakage</figcaption>
</figure>

<p>
In the image above all files in <code>~/.emacs.d</code> should be listed under <i>Other
Buffers</i>, but one has been brought over into the tab for the Sider project.
</p>

<p>
After a bit of experimenting I realised that
</p>

<ol class="org-ol">
<li>the buffer that leaks is the one I'm in when creating the new tab, and</li>
<li>my function for creating a new tab doesn't work the way I thought.</li>
</ol>

<p>
My function for creating a new tab looked like this
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><code><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">lambda</span> <span class="org-rainbow-delimiters-depth-2">()</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">interactive</span><span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">(</span>tab-new<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">(</span>dashboard-open<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</code></pre>
</div>

<p>
and it turns out that <code>tab-new</code> shows the current buffer in the new tab which in
turn caused bufferlo to associate it to the wrong tab. From what I can see
there's no way to tell <code>tab-new</code> to open a specific buffer in the newly created
tab. I tried the following
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><code><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">lambda</span> <span class="org-rainbow-delimiters-depth-2">()</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">interactive</span><span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">with-current-buffer</span> dashboard-buffer-name
    <span class="org-rainbow-delimiters-depth-3">(</span>tab-new<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</code></pre>
</div>

<p>
hoping that the dashboard would open in the new tab. It didn't, it was still the
active buffer that popped up in the new tab.
</p>

<p>
In the end I resorted to use <code>bufferlo-remove</code> to simply remove the current
buffer from the new tab.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><code><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">lambda</span> <span class="org-rainbow-delimiters-depth-2">()</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">interactive</span><span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">(</span>tab-new<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">(</span>bufferlo-remove <span class="org-rainbow-delimiters-depth-3">(</span>current-buffer<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">(</span>dashboard-open<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</code></pre>
</div>

<p>
No more leakage and <code>consult-buffer</code> works like I wanted it to.
</p>
<div class="taglist"><a href="https://magnus.therning.org/tags.html">Tags</a>: <a href="https://magnus.therning.org/tag-emacs.html">emacs</a> </div>
<div id="archive">
<a href="https://magnus.therning.org/archive.html">Other posts</a>
</div>
</div>
<div id="postamble" class="status"><!-- org-static-blog-page-postamble --></div>
</body>
</html>
