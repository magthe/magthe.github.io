<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<link rel="alternate"
      type="application/rss+xml"
      href="https://magnus.therning.org/feed.xml"
      title="RSS feed for https://magnus.therning.org/">
<title>Magnus web site</title>
<meta name="author" content="Magnus Therning"><meta name="referrer" content="no-referrer"><link href= "static/style.css" rel="stylesheet" type="text/css" /><link href= "static/htmlize.css" rel="stylesheet" type="text/css" /><link href= "static/extra_style.css" rel="stylesheet" type="text/css" /></head>
<body>
<div id="preamble" class="status"><div class="nav-bar"><a class="nav-link" href="./index.html">Top</a><a class="nav-link" href="./archive.html">Archive</a><a class="nav-link align-right" href="./feed.xml"><img src="static/rss-feed-icon.png" style="height: 24px;" /></a></div></div>
<div id="content">
<h1 class="title">Posts tagged "emacs":</h1>
<div class="post-date">04 May 2024</div><h1 class="post-title"><a href="https://magnus.therning.org/2024-05-04-orderless-completion-in-lsp-mode.html">Orderless completion in lsp-mode</a></h1>
<p>
If you, like me, are using <a href="https://github.com/minad/corfu"><i>corfu</i></a> to get in-buffer completion and extend it
with <a href="https://github.com/oantolin/orderless"><i>orderless</i></a> to make it even more powerful, you might have noticed that you
lose the orderless style as soon as you enter <a href="https://emacs-lsp.github.io/lsp-mode/"><i>lsp-mode</i></a>.
</p>

<p>
My setup of <i>orderless</i> looks like this
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">use-package</span> <span class="org-constant">orderless</span>
  <span class="org-builtin">:custom</span>
  <span class="org-rainbow-delimiters-depth-2">(</span>orderless-matching-styles '<span class="org-rainbow-delimiters-depth-3">(</span>orderless-literal orderless-regexp orderless-flex<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">(</span>completion-styles '<span class="org-rainbow-delimiters-depth-3">(</span>orderless partial-completion basic<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">(</span>completion-category-defaults nil<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">(</span>completion-category-overrides '<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-rainbow-delimiters-depth-4">(</span>file <span class="org-rainbow-delimiters-depth-5">(</span>styles partial-completion<span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<p>
which basically turns on orderless style for all things except when completing
filenames.
</p>

<p>
It turns out that <i>lsp-mode</i> messes around with <code>completion-category-defaults</code>
and when entering <code>lsp-mode</code> <a href="https://github.com/emacs-lsp/lsp-mode/blob/b27d9db1e75d40ea5e1362386e9a6e66fa3b1bae/lsp-completion.el#L790">this code here</a> adds a setting for <code>'lsp-capf</code>.
Unfortunately there seems to be no way to prevent <i>lsp-mode</i> from doing this so
the only option is to fix it up afterwards. Luckily there's a hook for running
code after the completion for <i>lsp-mode</i> is set up, <code>lsp-completion-mode-hook</code>.
Adding the following function to it makes sure I now get to enjoy <i>orderless</i>
also when writing code.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">lambda</span> <span class="org-rainbow-delimiters-depth-2">()</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">setq-local</span> completion-category-defaults
              <span class="org-rainbow-delimiters-depth-3">(</span>assoc-delete-all 'lsp-capf completion-category-defaults<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>
<div class="taglist"><a href="https://magnus.therning.org/tags.html">Tags</a>: <a href="https://magnus.therning.org/tag-emacs.html">emacs</a> <a href="https://magnus.therning.org/tag-lsp.html">lsp</a> </div>

<div class="post-date">19 Nov 2023</div><h1 class="post-title"><a href="https://magnus.therning.org/2023-11-19-making-emacs-without-terminal-emulator-a-little-more-usable.html">Making Emacs without terminal emulator a little more usable</a></h1>
<p>
After reading Andrey Listopadov's <a href="https://andreyor.st/posts/2023-10-27-you-dont-need-a-terminal-emulator/">You don't need a terminal emulator</a> (mentioned
at <a href="https://irreal.org/blog/?p=11746">Irreal</a> too) I decided to give up on using Emacs as a terminal for my shell.
In <i>my experience</i> Emacs simply isn't a very good terminal to run a shell in
anyway. I removed the almost completely unused <a href="https://github.com/kyagi/shell-pop-el">shell-pop</a> from my configuration
and the keybinding with a binding to <code>async-shell-command</code>. I'm keeping
<a href="https://github.com/davidshepherd7/terminal-here">terminal-here</a> in my config for the time being though.
</p>

<p>
I realised <a href="https://github.com/bbatsov/projectile">projectile</a> didn't have a function for running it in the root of a
project, so I wrote one heavily based on <code>project-async-shell-command</code>.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defun</span> <span class="org-function-name">mep-projectile-async-shell-command</span> <span class="org-rainbow-delimiters-depth-2">()</span>
  <span class="org-doc">"Run `</span><span class="org-doc"><span class="org-constant">async-shell-command</span></span><span class="org-doc">' in the current project's root directory."</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">declare</span> <span class="org-rainbow-delimiters-depth-3">(</span>interactive-only async-shell-command<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">interactive</span><span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">let</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-rainbow-delimiters-depth-4">(</span>default-directory <span class="org-rainbow-delimiters-depth-5">(</span>projectile-project-root<span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>
    <span class="org-rainbow-delimiters-depth-3">(</span>call-interactively #'async-shell-command<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<p>
I quickly found that the completion offered by Emacs for <code>shell-command</code> and
<code>async-shell-command</code> is far from as sophisticated as what I'm used to from Z
shell. After a bit of searching I found <a href="https://github.com/szermatt/emacs-bash-completion">emacs-bash-completion</a>. Bash isn't my
shell of choice, partly because I've found the completion to not be as good as
in Z shell, but it's an improvement over what stock Emacs offers. The
instructions in the repo was good, but had to be adjusted slightly:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">use-package</span> <span class="org-constant">bash-completion</span>
  <span class="org-builtin">:straight</span> <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-builtin">:host</span> github
             <span class="org-builtin">:repo</span> <span class="org-string">"szermatt/emacs-bash-completion"</span><span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-builtin">:config</span>
  <span class="org-rainbow-delimiters-depth-2">(</span>add-hook 'shell-dynamic-complete-functions 'bash-completion-dynamic-complete<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<p>
I just wish I'll find a package offering completions reaching Z shell levels.
</p>
<div class="taglist"><a href="https://magnus.therning.org/tags.html">Tags</a>: <a href="https://magnus.therning.org/tag-emacs.html">emacs</a> </div>

<div class="post-date">16 Nov 2023</div><h1 class="post-title"><a href="https://magnus.therning.org/2023-11-16-using-the-golang-mode-shipped-with-emacs.html">Using the golang mode shipped with Emacs</a></h1>
<p>
A few weeks ago I wanted to try out tree-sitter and switched a few of the modes
I use for coding to their <code>-ts-mode</code> variants. Based on the excellent <a href="https://www.masteringemacs.org/article/how-to-get-started-tree-sitter">How to Get
Started with Tree-Sitter</a> I added bits like this to the setup I have for coding
modes:<sup><a id="fnr.1" class="footref" href="#fn.1" role="doc-backlink">1</a></sup>
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">use-package</span> <span class="org-constant">X-mode</span>
  <span class="org-builtin">:init</span>
  <span class="org-rainbow-delimiters-depth-2">(</span>add-to-list 'treesit-language-source-alist '<span class="org-rainbow-delimiters-depth-3">(</span>X <span class="org-string">"https://github.com/tree-sitter/tree-sitter-X"</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-comment-delimiter">;; </span><span class="org-comment">(treesit-install-language-grammar 'X)</span>
  <span class="org-rainbow-delimiters-depth-2">(</span>add-to-list 'major-mode-remap-alist '<span class="org-rainbow-delimiters-depth-3">(</span>X-mode . X-ts-mode<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-comment-delimiter">;; </span><span class="org-comment">...</span>
  <span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<p>
I then manually evaluated the expression that's commented out to download and
compile the tree-sitter grammar. It's a rather small change, it works, and I can
switch over language by language. I swapped a couple of languages to the
tree-sitter modes like this, including golang. The only mode that I noticed
changes in was golang, in particular my adding of <code>gofmt-before-save</code> to
<code>before-save-hook</code> had stopped having any effect.
</p>

<p>
What I hadn't realised was that the <a href="https://github.com/dominikh/go-mode.el"><code>go-mode</code> I was using</a> didn't ship with Emacs
and that when I switched to <code>go-ts-mode</code> I switched to one that was. It turns
out that <code>gofmt-before-save</code> is hard-wired to work only in <code>go-mode</code>,
something others have <a href="https://github.com/dominikh/go-mode.el/issues/396#issuecomment-1366716882">noticed</a>.
</p>

<p>
I don't feel like waiting for <code>go-mode</code> to fix that though, especially not when
there's a perfectly fine golang mode shipping with Emacs now, and not when
<a href="https://github.com/purcell/emacs-reformatter">emacs-reformatter</a> make it so easy to define formatters (as I've <a href="https://magnus.therning.org/2023-09-24-defining-a-formatter-for-cabal-files.html">written about
before</a>).
</p>

<p>
My golang setup, sans keybindings, now looks like this:<sup><a id="fnr.2" class="footref" href="#fn.2" role="doc-backlink">2</a></sup>
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">use-package</span> <span class="org-constant">go-ts-mode</span>
  <span class="org-builtin">:hook</span>
  <span class="org-rainbow-delimiters-depth-2">(</span>go-ts-mode . lsp-deferred<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">(</span>go-ts-mode . go-format-on-save-mode<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-builtin">:init</span>
  <span class="org-rainbow-delimiters-depth-2">(</span>add-to-list 'treesit-language-source-alist '<span class="org-rainbow-delimiters-depth-3">(</span>go <span class="org-string">"https://github.com/tree-sitter/tree-sitter-go"</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">(</span>add-to-list 'treesit-language-source-alist '<span class="org-rainbow-delimiters-depth-3">(</span>gomod <span class="org-string">"https://github.com/camdencheek/tree-sitter-go-mod"</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-comment-delimiter">;; </span><span class="org-comment">(dolist (lang '(go gomod)) (treesit-install-language-grammar lang))</span>
  <span class="org-rainbow-delimiters-depth-2">(</span>add-to-list 'auto-mode-alist '<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"\\.go\\'"</span> . go-ts-mode<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">(</span>add-to-list 'auto-mode-alist '<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"/go\\.mod\\'"</span> . go-mod-ts-mode<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-builtin">:config</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">reformatter-define</span> go-format
    <span class="org-builtin">:program</span> <span class="org-string">"goimports"</span>
    <span class="org-builtin">:args</span> '<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"/dev/stdin"</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-builtin">:general</span>
  <span class="org-comment-delimiter">;; </span><span class="org-comment">...</span>
  <span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<p>
So far I'm happy with the built-in <code>go-ts-mode</code> and I've got to say that using a
minor mode for the format-on-save functionality is more elegant than adding a
function to <code>before-save-hook</code> (something that <code>go-mode</code> may get through this
<a href="https://github.com/dominikh/go-mode.el/pull/426">PR</a>).
</p>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" class="footnum" href="#fnr.1" role="doc-backlink">1</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
There were a few more things that I needed to modify. As the tree-sitter
modes are completely separate from the non-tree-sitter modes things like hooks
and keybindings in the modes' keymaps.
</p></div></div>

<div class="footdef"><sup><a id="fn.2" class="footnum" href="#fnr.2" role="doc-backlink">2</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
The full file is <a href="https://gitlab.com/magus/mes/-/blob/main/lisp/mes-dev-go.el">here</a>.
</p></div></div>


</div>
</div><div class="taglist"><a href="https://magnus.therning.org/tags.html">Tags</a>: <a href="https://magnus.therning.org/tag-emacs.html">emacs</a> <a href="https://magnus.therning.org/tag-tree-sitter.html">tree-sitter</a> </div>

<div class="post-date">01 Oct 2023</div><h1 class="post-title"><a href="https://magnus.therning.org/2023-10-01-how-i-use-emacs.html">How I use Emacs</a></h1>
<p>
I've recently written <a href="https://magnus.therning.org/2023-09-10-using-emacs-for-the-scrollback-in-terminal-multiplexers.html">two</a> <a href="https://magnus.therning.org/2023-09-30-using-emacs-as-$editor.html">posts</a> about my attempts to use a slimmed down Emacs
setup for some very specific use cases. I'be put both posts on Reddit, <a href="https://www.reddit.com/r/emacs/comments/16f7rbn/using_emacs_for_the_scrollback_in_terminal/">here</a> and
<a href="https://www.reddit.com/r/emacs/comments/16w9bvh/using_emacs_as_editor/">here</a>, and in both cases the majority of comments have been telling me that I
should use <code>emacsclient</code>. I know they have good intentions &#x2013; they want to share
insight they've gained and benefit from on a daily basis. However, no matter how
many Emacs devotees point out the benefits of <code>emacsclient</code> I'm not about to
start using it. This post is an attempt to answer why that is.
</p>

<p>
Up front I want to clarify a few things:
</p>

<ol class="org-ol">
<li>Yes, I know how to use <code>emacsclient</code>, and</li>
<li>yes, I know it is a good way to, in a way, improve Emacs startup time,<sup><a id="fnr.1" class="footref" href="#fn.1" role="doc-backlink">1</a></sup> and</li>
<li>yes, I know how to turn on <code>server-mode</code> in Emacs, and finally</li>
<li>yes, I know how to run Emacs using a user unit for SystemD.</li>
</ol>

<p>
With that out of the way, here are the two ways I use Emacs
</p>

<ol class="org-ol">
<li>As my starting point for work, i.e. writing code, keeping notes, tracking
time, and writing my daily work journal.</li>
<li>As my editor of ephemeral files.<sup><a id="fnr.2" class="footref" href="#fn.2" role="doc-backlink">2</a></sup></li>
</ol>

<p>
The next two sections explain more about these two distinct ways I use Emacs
</p>
<div id="outline-container-org06ef619" class="outline-2">
<h2 id="org06ef619">As my starting point for work</h2>
<div class="outline-text-2" id="text-org06ef619">
<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-left">Number of packages</td>
<td class="org-left">162</td>
</tr>

<tr>
<td class="org-left">Init time (<code>emacs-init-time</code>)</td>
<td class="org-left">1.883483s</td>
</tr>

<tr>
<td class="org-left">Config size (by <code>du -bch</code>)</td>
<td class="org-left">68K</td>
</tr>
</tbody>
</table>

<p>
Much of what I do on a daily basis starts in Emacs. I typically have one
instance of Emacs open and I always keep it on the second virtual desktop. I
always run it in the GUI. When I write code I start with opening a new tab, then
I open a <code>dired</code> buffer in the project's folder (by using <code>consult-projectile</code>).
When I need a terminal I open it from Emacs using on of
<code>terminal-here-project-launch</code> or <code>terminal-here</code>. Occasionally I open a shell
prompt inside Emacs using <code>shell-pop</code>.
</p>

<p>
Back when I used Vim as my main editor I <i>always</i> started a terminal first and
then opened files from there. Since switching to Emacs I've completely stopped
doing that. Over the last 8 or so years of Emacs usage there's only been a
handful of times when I've wanted to open a file from the terminal and I've run
<code>M-x server-start</code> and used <code>emacsclient</code>. The last time was more than a year
ago.
</p>

<p>
As I typically keep exactly one Emacs open, and I start it soon after logging
in, I'm not too concerned with startup time. I think under 2s is more than fast
enough given the functionality I have in my setup.
</p>

<p>
This setup I use for taking notes and writing my daily work journal, as well as
reading email, and programming in a half-dozen languages. I have a large-ish set
of keybindings that I've set up using <a href="https://github.com/noctuid/general.el">general.el</a>, inspired by Spacemacs at first
but by now it's started to gain its own character.
</p>
</div>
</div>
<div id="outline-container-org9ecf44f" class="outline-2">
<h2 id="org9ecf44f">As my editor of ephemeral files (<code>$EDITOR</code>)</h2>
<div class="outline-text-2" id="text-org9ecf44f">
<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-left">Number of packages</td>
<td class="org-left">22</td>
</tr>

<tr>
<td class="org-left">Init time (<code>emacs-init-time</code>)</td>
<td class="org-left">0.209298s</td>
</tr>

<tr>
<td class="org-left">Config size (by <code>du -bch</code>)</td>
<td class="org-left">6.7K</td>
</tr>
</tbody>
</table>

<p>
Ephemeral files are files I tend to edit for less than 30 seconds, maybe a
minute at most. There are three main use cases for ephemeral files:
</p>

<ol class="org-ol">
<li>Searching the scrollback buffer in <a href="https://zellij.dev/">zellij</a>, and copying bits to the clipboard
for various uses.</li>
<li>Editing files when running <code>git</code> from the command line. It's not something I
do very often, but it happens.</li>
<li>Editing shell commands. When they get a little too large to handle
conveniently using ZSH directly I invoke <code>edit-command-line</code>.</li>
</ol>

<p>
For a few reasons I decided to make a second, completely separate configuration
just to handle ephemeral files.
</p>

<ul class="org-ul">
<li>It will only be used in a terminal.</li>
<li>I want to be able to have some special keybindings that suit a specific use,
e.g. for the scrollback buffer I've bound `SPC Y` to copy the selected text to
the clipboard and then exit Emacs. It's a thing that I use all the time with
the scrollback buffer, but never otherwise.</li>
<li>I have no need, nor any desire, to switch from editing a commit message, or
searching a scrollback buffer, to reading email or editing an org-mode file.
The complete separation is a feature.</li>
</ul>

<p>
With a startup time of less than a quarter of a second it is well within the
acceptable, and there is absolutely no need to use <code>emacsclient</code> just to speed
things up. Given my desire for separation, I wouldn't want to use my main Emacs
instance as a server and edit ephemeral files anyway.
</p>
</div>
</div>
<div id="outline-container-orgcadf982" class="outline-2">
<h2 id="orgcadf982">Conclusion</h2>
<div class="outline-text-2" id="text-orgcadf982">
<p>
I've found a setup that seems to work really well and tick all the requirements
I have when it comes to separation between use cases and ability to have custom
keybindings for them. Also, Emacs is starting up <i>very</i> fast with my slimmed
down configuration. If starting Emacs with the slimmed configuration starts
taking too long I'm more likely to go back to using Neovim than complicate
things with <code>emacsclient</code>.
</p>

<p>
So no, I am not going to start using <code>emacsclient</code> any time soon.
</p>
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" class="footnum" href="#fnr.1" role="doc-backlink">1</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
I write "in a way" as it actually does nothing for Emacs startup time, it
just shifts it to a point in time so you don't have to sit and wait for it to
start.
</p></div></div>

<div class="footdef"><sup><a id="fn.2" class="footnum" href="#fnr.2" role="doc-backlink">2</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
I used to use <a href="https://neovim.io/">Neovim</a>, without any config, for most of this until recently.
</p></div></div>


</div>
</div><div class="taglist"><a href="https://magnus.therning.org/tags.html">Tags</a>: <a href="https://magnus.therning.org/tag-emacs.html">emacs</a> </div>

<div class="post-date">30 Sep 2023</div><h1 class="post-title"><a href="https://magnus.therning.org/2023-09-30-using-emacs-as-$editor.html">Using Emacs as $EDITOR</a></h1>
<p>
Continuing on from my experiment with <a href="https://magnus.therning.org/2023-09-10-using-emacs-for-the-scrollback-in-terminal-multiplexers.html">using Emacs as for scrollback in my
terminal multiplexer</a> I thought I'd try to use it as my <code>$EDITOR</code> as well.
</p>

<p>
The two main cases where I use <code>$EDITOR</code> is
</p>

<ol class="org-ol">
<li>The occasional use of <code>git</code> on the command line, rebasing or writing a commit
message, and</li>
<li>Use of ZSH's <code>edit-command-line</code> functionality.</li>
</ol>

<p>
To make sure Emacs is starting up quickly enough I'm using the same small setup
I created for the scrollback editing, so I'm now setting <code>EDITOR</code> like this
</p>

<div class="org-src-container">
<pre class="src src-shell"><span class="org-builtin">export</span> <span class="org-variable-name">EDITOR</span>=<span class="org-string">"emacs -nw --init-directory ~/.se.d"</span>
</pre>
</div>

<p>
Now that I want to use the same setup for editing I can't really jump into
<code>view-mode</code> every time Emacs starts so I have to be a bit more clever. The
following bit won't do
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span>add-hook 'find-file-hook #'view-mode<span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<p>
I need to somehow find out what starts Emacs and then only modify the hook when
needed. Unfortunately I haven't found anything that reveals that Emacs is
started by <a href="https://zellij.dev/">zellij</a>. Creating a separate little script that <span class="underline">zellij</span> uses would be
an option, of course, but for now I've opted to make it the default and instead
refrain from adding the hook in the other two use cases.
</p>

<p>
ZSH doesn't make it easy to find out that it's <code>edit-command-line</code> either, but
as I've observed that the command line sometimes doesn't look right after
leaving the editor I wanted to call <code>redisplay</code> to fix it up. That means I need
to have a function anyway, so using an environment variable becomes an easy way
to check if Emacs is being used to edit the command line.
</p>

<div class="org-src-container">
<pre class="src src-shell"><span class="org-keyword">function</span> <span class="org-function-name">se-edit-command-line</span><span class="org-rainbow-delimiters-depth-1">()</span> <span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-builtin">export</span> <span class="org-variable-name">SE_SKIP_VIEW</span>=y
    zle edit-command-line
    <span class="org-builtin">unset</span> SE_SKIP_VIEW
    zle redisplay
<span class="org-rainbow-delimiters-depth-1">}</span>
zle -N se-edit-command-line

<span class="org-builtin">bindkey</span> -M vicmd <span class="org-string">'^V'</span> se-edit-command-line
<span class="org-builtin">bindkey</span> -M viins <span class="org-string">'^V'</span> se-edit-command-line
</pre>
</div>

<p>
Unfortunately is seems <code>zle edit-command-line</code> doesn't pass on non-exported
environment variables, hence the explicit <code>export</code> and <code>unset</code>.
</p>

<p>
When <span class="underline">git</span> starts an editor it sets a few environment variables so it was easy
to just pick one that is set in both cases I care about. I picked
<code>GIT_EXEC_PATH</code>.
</p>

<p>
With these things in place I changed the slim setup to only add the hook when
neither of the environment variables are present
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">unless</span> <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">or</span> <span class="org-rainbow-delimiters-depth-3">(</span>getenv <span class="org-string">"SE_SKIP_VIEW"</span><span class="org-rainbow-delimiters-depth-3">)</span>
            <span class="org-rainbow-delimiters-depth-3">(</span>getenv <span class="org-string">"GIT_EXEC_PATH"</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">(</span>add-hook 'find-file-hook #'view-mode<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<p>
Hopefully this works out well enough that I won't feel a need to go back to
using <a href="https://neovim.io/">Neovim</a> as my <code>$EDITOR</code>.
</p>
<div class="taglist"><a href="https://magnus.therning.org/tags.html">Tags</a>: <a href="https://magnus.therning.org/tag-emacs.html">emacs</a> <a href="https://magnus.therning.org/tag-zsh.html">zsh</a> </div>

<div class="post-date">24 Sep 2023</div><h1 class="post-title"><a href="https://magnus.therning.org/2023-09-24-defining-a-formatter-for-cabal-files.html">Defining a formatter for Cabal files</a></h1>
<p>
For Haskell code I can use <code>lsp-format-buffer</code> and <code>lsp-format-region</code> to keep
my file looking nice, but I've never found a function for doing the same for
Cabal files. There's a nice command line tool, <code>cabal-fmt</code>, for doing it, but it
means having to jump to a terminal. It would of course be nicer to satisfy my
needs for aesthetics directly from Emacs. A few times I've thought of writing
the function myself, I mean how hard can it be? But then I've forgotten about it
until then next time I'm editing a Cabal file.
</p>

<p>
A few days ago I noticed <a href="https://github.com/purcell/emacs-reformatter">emacs-reformatter</a> popping up in my feeds. That
removed all reasons to procrastinate. It turned out to be very easy to set up.
</p>

<p>
The package doesn't have a recipe for <a href="https://github.com/radian-software/straight.el">straight.el</a> so it needs a <code>:straight</code>
section. Also, the naming of the file in the package doesn't fit the package
name, hence the slightly different name in the <code>use-package</code> declaration:<sup><a id="fnr.1" class="footref" href="#fn.1" role="doc-backlink">1</a></sup>
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">use-package</span> <span class="org-constant">reformatter</span>
  <span class="org-builtin">:straight</span> <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-builtin">:host</span> github
             <span class="org-builtin">:repo</span> <span class="org-string">"purcell/emacs-reformatter"</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<p>
Now the formatter can be defined
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">reformatter-define</span> cabal-format
  <span class="org-builtin">:program</span> <span class="org-string">"cabal-fmt"</span>
  <span class="org-builtin">:args</span> '<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"/dev/stdin"</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<p>
in order to create functions for formatting, <code>cabal-format-buffer</code> and
<code>cabal-format-region</code>, as well as a minor mode for formatting on saving a Cabal
file.
</p>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" class="footnum" href="#fnr.1" role="doc-backlink">1</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
I'm sure it's possible to use <code>:files</code> to deal with this, but I'm not sure
how and my naive guess failed. It's OK to be like this until I figure it out
properly.
</p></div></div>


</div>
</div><div class="taglist"><a href="https://magnus.therning.org/tags.html">Tags</a>: <a href="https://magnus.therning.org/tag-emacs.html">emacs</a> <a href="https://magnus.therning.org/tag-haskell.html">haskell</a> </div>

<div class="post-date">16 Sep 2023</div><h1 class="post-title"><a href="https://magnus.therning.org/2023-09-16-setting-up-emacs-openai-chatgpt.html">Setting up emacs-openai/chatgpt</a></h1>
<p>
Yesterday I decided to try to make more use of the ChatGPT account I have. What
prompted it mostly was that I recalled that my employer has a paid subscription
and that if we use it enough they'll get us access to ChatGPT4.
</p>

<p>
After a bit of research<sup><a id="fnr.1" class="footref" href="#fn.1" role="doc-backlink">1</a></sup> I decided to start with <a href="https://github.com/emacs-openai/chatgpt">emacs-open/chatgpg</a>. However,
as I found the instructions slightly lacking I'm sharing my setup.
</p>

<p>
The instructions for <code>straight.el</code> fail to mention that one needs the <a href="https://github.com/emacs-openai/openai">openai</a>
package too.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">use-package</span> <span class="org-constant">openai</span>
  <span class="org-builtin">:straight</span> <span class="org-rainbow-delimiters-depth-2">(</span>openai <span class="org-builtin">:type</span> git <span class="org-builtin">:host</span> github <span class="org-builtin">:repo</span> <span class="org-string">"emacs-openai/openai"</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<p>
The complete declaration for <code>use-package</code> ended up looking like this:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">use-package</span> <span class="org-constant">chatgpt</span>
  <span class="org-builtin">:straight</span> <span class="org-rainbow-delimiters-depth-2">(</span>chatgpt <span class="org-builtin">:type</span> git <span class="org-builtin">:host</span> github <span class="org-builtin">:repo</span> <span class="org-string">"emacs-openai/chatgpt"</span><span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-builtin">:requires</span> openai
  <span class="org-builtin">:config</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">setq</span> openai-key #'openai-key-auth-source<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<p>
Oh, and don't forget to put an entry into `~/.authinfo.gpg`. Something like this should do it
</p>

<pre class="example" id="org5080c7e">
machine api.openai.com login &lt;anything&gt; password &lt;your key&gt;
</pre>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" class="footnum" href="#fnr.1" role="doc-backlink">1</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
I found <a href="https://notes.alexkehayias.com/using-chatgpt-with-emacs/">Alex Kehayias' note</a> to be a good starting point.
</p></div></div>


</div>
</div><div class="taglist"><a href="https://magnus.therning.org/tags.html">Tags</a>: <a href="https://magnus.therning.org/tag-emacs.html">emacs</a> <a href="https://magnus.therning.org/tag-openai.html">openai</a> <a href="https://magnus.therning.org/tag-chatgpt.html">chatgpt</a> </div>

<div class="post-date">10 Sep 2023</div><h1 class="post-title"><a href="https://magnus.therning.org/2023-09-10-using-emacs-for-the-scrollback-in-terminal-multiplexers.html">Using emacs for the scrollback in terminal multiplexers</a></h1>
<p>
I should start with saying that I still don't really know if this is a good idea
or not, but it feels like it's worth trying out at least.
</p>
<div id="outline-container-org1ca78e4" class="outline-2">
<h2 id="org1ca78e4">An irritating limitation in <a href="https://zellij.dev/">Zellij</a>, and a possible solution</h2>
<div class="outline-text-2" id="text-org1ca78e4">
<p>
After seeing it mentioned in an online community I thought it might be worth
trying out. I'm not really disappointed with <a href="https://github.com/tmux/tmux">tmux</a>, I've been using it for years
but I actually only use a small part of what it can do. I create tabs, sometimes
create panes, and I regularly use the scollback functionality to copy output of
commands I've run earlier.
</p>

<p>
Unfortunately, as is reported in a <a href="https://github.com/zellij-org/zellij/issues/947">ticket</a>, Zellij can't select and copy using
the keyboard. From the discussion in that ticket it seems unlikely it ever will
be able to. After finding that out I resigned to staying with Tmux &#x2013; I'm not
ready to go back to using a pointing device to select and copy text in my
terminal!
</p>

<p>
When I was biking to the pool yesterday I realised a thing though: I'm already
using a tool that is <i>very</i> good at manipulating text using the keyboard. Of
course I'm talking about Emacs! So if I can just make Emacs start up quickly
enough I ought to be able to use it for searching, selecting and copying from
the scrollback buffer. I haven't found a way to do this in Tmu= yet, but
Zellij has <a href="https://zellij.dev/documentation/keybindings-possible-actions#editscrollback">EditScrollBack</a> so I can at least try it out.
</p>

<p>
A nice benefit is that I can cut back on the number of different shortcuts I use
daily.
</p>
</div>
</div>
<div id="outline-container-org728fd4c" class="outline-2">
<h2 id="org728fd4c">My slimmed down Emacs config</h2>
<div class="outline-text-2" id="text-org728fd4c">
<p>
My current <a href="https://gitlab.com/magus/mes">Emacs config</a> starts up in less than 2s, which is good enough as I
normally start Emacs at most a few times per day. However, if I have to wait 2s
to open the scrollback buffer I suspect I'll tire very quickly and abandon the
experiment. So I took my ordinary config and slimmed it down. Cutting away
things that weren't related to navigation and searching.
</p>

<p>
The list of packages is not very long:
</p>

<ul class="org-ul">
<li><code>straight</code></li>
<li><code>use-package</code></li>
<li><code>evil</code></li>
<li><code>general</code></li>
<li><code>which-key</code></li>
<li><code>vertico</code></li>
<li><code>orderless</code></li>
<li><code>marginalia</code></li>
<li><code>consult</code></li>
</ul>

<p>
The first 5 are for usability in general, and the last 4 are bring in the
functions I use for searching through text.
</p>

<p>
The resulting config starts in less than ¼s. That's more than acceptable, I find.
</p>
</div>
</div>
<div id="outline-container-org44d7ad0" class="outline-2">
<h2 id="org44d7ad0">Copying to the Wayland clipboard</h2>
<div class="outline-text-2" id="text-org44d7ad0">
<p>
It turns out that copying with `y` in <code>evil</code> does the right thing by default and
the copied text ends up in the clipboard without any special configuration.
</p>

<p>
From Tmux I'm used to being thrown out of copy-mode after copying something.
While that's sometimes irritating, it's at other times exactly what I want.
Given that <code>evil-yank</code> does the right thing it was easy to write a function for
it:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defun</span> <span class="org-function-name">se/yank-n-kill</span> <span class="org-rainbow-delimiters-depth-2">(</span>beg end<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">interactive</span> <span class="org-string">"r"</span><span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">(</span>evil-yank beg end<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">(</span>kill-emacs<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org9e880a9" class="outline-2">
<h2 id="org9e880a9">The config files</h2>
<div class="outline-text-2" id="text-org9e880a9">
<p>
I'm keeping my dot-files in a private repo, but I put a snapshot of the Emacs
and Zellij config in a <a href="https://gitlab.com/-/snippets/3595805">snippet</a>.
</p>
</div>
</div>
<div class="taglist"><a href="https://magnus.therning.org/tags.html">Tags</a>: <a href="https://magnus.therning.org/tag-emacs.html">emacs</a> <a href="https://magnus.therning.org/tag-tmux.html">tmux</a> <a href="https://magnus.therning.org/tag-zellij.html">zellij</a> </div>

<div class="post-date">26 Jul 2023</div><h1 class="post-title"><a href="https://magnus.therning.org/2023-07-26-making-keymaps-prettier-with-general.el.html">Making keymaps prettier with general.el</a></h1>
<p>
After my previous post on <a href="https://magnus.therning.org/2023-07-09-general.el-and-two-ways-to-define-keybindings.html">defining keymaps using general.el</a> I revisited some of
my setup in order to make some package keymaps prettier when displayed by
<a href="https://github.com/justbur/emacs-which-key">which-key</a>. The keymaps defined by packages are typically don't contain any
description of the bindings, so <code>which-key</code> ends up displaying the name of the
function bound to the key. It's not always easy to remember what a function does
based just on its name, and sometimes the names are so long that <code>which-key</code>
cuts the name short and all you see is a bunch of keybindings for seemingly the
same function.
</p>

<p>
The only remedy I've found is to re-define the keybindings decorating them with
descriptions that (hopefully) are easier to understand than the function name.
(At least, this way I only have myself to blame if it's a bad description.)
</p>

<p>
One such keymap that I use somewhat frequently, and where the function names
often confuse me is <code>evil-mc-key-map</code> from <a href="https://github.com/gabesoft/evil-mc">evil-mc</a>. The keymap is bound at <code>g .</code>
in evil's normal and visual modes, and it also contains a few bindings using
control (<code>C-</code>) and meta (<code>M-</code>) which I think would be better placed under
sub-keymaps.
</p>

<p>
I decided to group the "make and go" functions under <code>g . m</code> and the "skip and
go" function under <code>g . s</code>. The rest I'm just giving descriptions. <code>general.el</code>
makes it easy both to overwrite already existing bindings, but adding
descriptions, and to add new ones, all in one call to <code>general-def</code>:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">general-def</span> evil-mc-key-map
  <span class="org-builtin">:states</span> '<span class="org-rainbow-delimiters-depth-2">(</span>normal visual<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-string">"g.A"</span> '<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"make end sel"</span> . evil-mc-make-cursor-in-visual-selection-end<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-string">"g.I"</span> '<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"make beg sel"</span> . evil-mc-make-cursor-in-visual-selection-beg<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-string">"g.a"</span> '<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"make all"</span> . evil-mc-make-all-cursors<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-string">"g.q"</span> '<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"undo all"</span> . evil-mc-undo-all-cursors<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-string">"g.u"</span> '<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"undo last"</span> . evil-mc-undo-last-added-cursor<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-string">"g. RET"</span> '<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"make here"</span> . evil-mc-make-cursor-here<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-string">"g.p"</span> '<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"pause"</span> . evil-mc-pause-cursors<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-string">"g.r"</span> '<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"resume"</span> . evil-mc-resume-cursors<span class="org-rainbow-delimiters-depth-2">)</span>

  <span class="org-string">"g.m"</span> '<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-builtin">:ignore</span> t <span class="org-builtin">:wk</span> <span class="org-string">"make &amp; go"</span><span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-string">"g.m$"</span> '<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"to last cur"</span> . evil-mc-make-and-goto-last-cursor<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-string">"g.m0"</span> '<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"to first cur"</span> . evil-mc-make-and-goto-first-cursor<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-string">"g.mC"</span> '<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"to prev cur"</span> . evil-mc-make-and-goto-prev-cursor<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-string">"g.mc"</span> '<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"to next cur"</span> . evil-mc-make-and-goto-next-cursor<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-string">"g.mh"</span> '<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"to prev match"</span> . evil-mc-make-and-goto-prev-match<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-string">"g.mj"</span> '<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"to next line"</span> . evil-mc-make-cursor-move-next-line<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-string">"g.mk"</span> '<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"to prev line"</span> . evil-mc-make-cursor-move-prev-line<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-string">"g.ml"</span> '<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"to next match"</span> . evil-mc-make-and-goto-next-match<span class="org-rainbow-delimiters-depth-2">)</span>

  <span class="org-string">"g.s"</span> '<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-builtin">:ignore</span> t <span class="org-builtin">:wk</span> <span class="org-string">"skip &amp; go"</span><span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-string">"g.sC"</span> '<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"to prev cur"</span> . evil-mc-skip-and-goto-prev-cursor<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-string">"g.sc"</span> '<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"to next cur"</span> . evil-mc-skip-and-goto-next-cursor<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-string">"g.sh"</span> '<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"to prev match"</span> . evil-mc-skip-and-goto-prev-match<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-string">"g.sl"</span> '<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"to next match"</span> . evil-mc-skip-and-goto-next-match<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<p>
Finally I want to remove the bindings that weren't overwritten. <code>general.el</code>
makes that easy too with <code>general-undbind</code>:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">general-unbind</span> '<span class="org-rainbow-delimiters-depth-2">(</span>normal visual<span class="org-rainbow-delimiters-depth-2">)</span> evil-mc-key-map
  <span class="org-string">"g.$"</span> <span class="org-string">"g.0"</span>
  <span class="org-string">"g. C-n"</span> <span class="org-string">"g. C-S-n"</span>
  <span class="org-string">"g. C-u"</span> <span class="org-string">"g. C-S-u"</span>
  <span class="org-string">"g. C-p"</span> <span class="org-string">"g. C-r"</span>
  <span class="org-string">"g. M-N"</span> <span class="org-string">"g. M-n"</span>
  <span class="org-string">"g.N"</span> <span class="org-string">"g.O"</span> <span class="org-string">"g.n"</span> <span class="org-string">"g.o"</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<p>
Yes, this is a bit of work, and so far I've only done this for a few keymaps
(those containing bindings I use frequently and/or find difficult to remember).
So far I've found it worth the cost.
</p>
<div class="taglist"><a href="https://magnus.therning.org/tags.html">Tags</a>: <a href="https://magnus.therning.org/tag-emacs.html">emacs</a> <a href="https://magnus.therning.org/tag-general.el.html">general.el</a> </div>

<div class="post-date">09 Jul 2023</div><h1 class="post-title"><a href="https://magnus.therning.org/2023-07-09-general.el-and-two-ways-to-define-keybindings.html">general.el and two ways to define keybindings</a></h1>
<p>
When I abandoned <a href="https://www.spacemacs.org/">spacemacs</a> I really wanted to duplicate its keybindings using
<code>SPC</code> as leader key and per-mode bindings available by pressing <code>,</code>. I found a
nice setup using <a href="https://github.com/noctuid/general.el">general.el</a> in <a href="https://github.com/tshu-w/.emacs.d/">Tianshu Wang's Emacs config</a>. I made only minor
modification and ended up with the following setup.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">use-package</span> <span class="org-constant">general</span>
  <span class="org-builtin">:after</span> <span class="org-rainbow-delimiters-depth-2">(</span>evil evil-easymotion<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-builtin">:config</span>
  <span class="org-rainbow-delimiters-depth-2">(</span>general-evil-setup<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">(</span>general-auto-unbind-keys<span class="org-rainbow-delimiters-depth-2">)</span>

  <span class="org-rainbow-delimiters-depth-2">(</span>general-define-key
   <span class="org-builtin">:states</span> '<span class="org-rainbow-delimiters-depth-3">(</span>normal insert motion visual emacs<span class="org-rainbow-delimiters-depth-3">)</span>
   <span class="org-builtin">:keymaps</span> 'override
   <span class="org-builtin">:prefix-map</span> 'tyrant-map
   <span class="org-builtin">:prefix</span> <span class="org-string">"SPC"</span>
   <span class="org-builtin">:non-normal-prefix</span> <span class="org-string">"M-SPC"</span><span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">general-create-definer</span> mes/tyrant-def <span class="org-builtin">:keymaps</span> 'tyrant-map<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">mes/tyrant-def</span> <span class="org-string">""</span> nil<span class="org-rainbow-delimiters-depth-2">)</span>

  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">general-create-definer</span> mes/despot-def
    <span class="org-builtin">:states</span> '<span class="org-rainbow-delimiters-depth-3">(</span>normal insert motion visual emacs<span class="org-rainbow-delimiters-depth-3">)</span>
    <span class="org-builtin">:keymaps</span> 'override
    <span class="org-builtin">:major-modes</span> t
    <span class="org-builtin">:prefix</span> <span class="org-string">","</span>
    <span class="org-builtin">:non-normal-prefix</span> <span class="org-string">"M-,"</span><span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">mes/despot-def</span> <span class="org-string">""</span> nil<span class="org-rainbow-delimiters-depth-2">)</span>

  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">general-def</span> universal-argument-map
    <span class="org-string">"SPC u"</span> 'universal-argument-more<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<p>
One slightly surprising thing I found out is that two different ways to define
keybindings can be used, one seems to work on both top and mode level, the other
only on mode level.
</p>

<div id="outline-container-orgca8de18" class="outline-2">
<h2 id="orgca8de18">Top-level keybindings (<code>SPC</code>)</h2>
<div class="outline-text-2" id="text-orgca8de18">
<p>
At the top-level, i.e. when using <code>mes/tyrant-def</code>, I need to use a <code>cons</code> based
configuration. This is part of my top-level keybindings:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">mes/tyrant-def</span>
  <span class="org-string">"SPC"</span> '<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"M-x"</span> . execute-extended-command<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-string">"TAB"</span> '<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"latest buffer"</span> . mode-line-other-buffer<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-string">"!"</span> 'shell-command
  <span class="org-string">"/"</span> '<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"search"</span> . consult-ripgrep<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-string">"u"</span> 'universal-argument

  <span class="org-string">"b"</span> <span class="org-rainbow-delimiters-depth-2">(</span>cons <span class="org-string">"bufs"</span> <span class="org-rainbow-delimiters-depth-3">(</span>make-sparse-keymap<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-string">"bb"</span> '<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"switch"</span> . consult-buffer<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-string">"bc"</span> '<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"close"</span> . kill-this-buffer<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-string">"be"</span> '<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"erase"</span> . erase-buffer<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-string">"bs"</span> '<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"scratch"</span> . scratch-buffer<span class="org-rainbow-delimiters-depth-2">)</span>

  <span class="org-comment-delimiter">;; </span><span class="org-comment">....</span>
  <span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<p>
When it's done this way <a href="https://github.com/justbur/emacs-which-key">which-key</a> picks up the descriptive strings.
</p>

<p>
It did take me a while to figure out that this config style was necessary. Again
<a href="https://github.com/tshu-w/.emacs.d/">Tianshu Wang's Emacs config</a> was what led me right.
</p>
</div>
</div>

<div id="outline-container-org80efaa0" class="outline-2">
<h2 id="org80efaa0">Mode-level keybindings (<code>,</code>)</h2>
<div class="outline-text-2" id="text-org80efaa0">
<p>
At the mode-level, i.e. using <code>mes/despot-def</code>, I've found that I can, almost
always, define keybindings following the documentation of <a href="https://github.com/noctuid/general.el">general.el</a>. Here's the
keybindings I have for <code>nix-mode</code>:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">mes/despot-def</span> nix-mode-map
  <span class="org-string">"="</span> '<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-builtin">:ignore</span> t <span class="org-builtin">:wk</span> <span class="org-string">"format"</span><span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-string">"=b"</span> '<span class="org-rainbow-delimiters-depth-2">(</span>nix-format-buffer <span class="org-builtin">:wk</span> <span class="org-string">"buffer"</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<p>
Just the other day I found that AUCTeX must be doing something with it's keymaps
and I have to use the <code>cons</code>-based configuration style for its keymaps.
</p>
</div>
</div>
<div class="taglist"><a href="https://magnus.therning.org/tags.html">Tags</a>: <a href="https://magnus.therning.org/tag-emacs.html">emacs</a> <a href="https://magnus.therning.org/tag-general.el.html">general.el</a> </div>

<div class="post-date">30 Mar 2023</div><h1 class="post-title"><a href="https://magnus.therning.org/2023-03-30-more-on-tree-sitter-and-consult.html">More on tree-sitter and consult</a></h1>
<p>
Here's a few things that I've gotten help with figuring out during the last few
days. Both things are related to my playing with tree-sitter that I've written
about earlier, <a href="https://magnus.therning.org/2023-03-22-making-an-emacs-major-mode-for-cabal-using-tree-sitter.html">here</a> and <a href="https://magnus.therning.org/2023-03-27-cabal,-tree-sitter,-and-consult.html">here</a>.
</p>

<p>
You might also be interested in the two repositories where the full code
is. (I've linked to the specific commits as of this writing.)
</p>

<ul class="org-ul">
<li><a href="https://gitlab.com/magus/my-emacs-pkgs/-/tree/e739d1035f3d505f2495309126d891ca6b18cab8/my-cabal-mode">My Cabal mode</a></li>
<li><a href="https://gitlab.com/magus/tree-sitter-cabal/-/tree/7d5fa6887ae05a0b06d046f1e754c197c8ad869b">tree-sitter-cabal</a></li>
</ul>

<div id="outline-container-org49f0058" class="outline-2">
<h2 id="org49f0058">Anonymous nodes and matching in tree-sitter</h2>
<div class="outline-text-2" id="text-org49f0058">
<p>
In the grammar for Cabal I have a rule for sections that like this
</p>

<div class="org-src-container">
<pre class="src src-javascript">sections: $ =&gt; repeat1<span class="org-rainbow-delimiters-depth-1">(</span>choice<span class="org-rainbow-delimiters-depth-2">(</span>
    $.benchmark,
    $.common,
    $.executable,
    $.flag,
    $.library,
    $.source_repository,
    $.test_suite,
<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>,
</pre>
</div>

<p>
where each section followed this pattern
</p>

<div class="org-src-container">
<pre class="src src-javascript">benchmark: $ =&gt; seq<span class="org-rainbow-delimiters-depth-1">(</span>
    repeat<span class="org-rainbow-delimiters-depth-2">(</span>$.comment<span class="org-rainbow-delimiters-depth-2">)</span>,
    <span class="org-string">'benchmark'</span>,
    field<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">'name'</span>, $.section_name<span class="org-rainbow-delimiters-depth-2">)</span>,
    field<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">'properties'</span>, $.property_block<span class="org-rainbow-delimiters-depth-2">)</span>,
<span class="org-rainbow-delimiters-depth-1">)</span>,
</pre>
</div>

<p>
This made it a little bit difficult to capture the relevant parts of each
section to implement <code>consult-cabal</code>. I thought a pattern like this ought to
work
</p>

<div class="org-src-container">
<pre class="src src-lisp"><span class="org-rainbow-delimiters-depth-1">(</span>cabal
 <span class="org-rainbow-delimiters-depth-2">(</span>sections
  <span class="org-rainbow-delimiters-depth-3">(</span>_ _ @type
     name: <span class="org-rainbow-delimiters-depth-4">(</span>section_name<span class="org-rainbow-delimiters-depth-4">)</span>? @name<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<p>
but it didn't; I got way too many things captured in <code>type</code>. Clearly I had
misunderstood something about the wildcards, or the query syntax. I attempted to
add a field name to the anonymous node, i.e. change the sections rules like this
</p>

<div class="org-src-container">
<pre class="src src-javascript">benchmark: $ =&gt; seq<span class="org-rainbow-delimiters-depth-1">(</span>
    repeat<span class="org-rainbow-delimiters-depth-2">(</span>$.comment<span class="org-rainbow-delimiters-depth-2">)</span>,
    field<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">'type'</span>, <span class="org-string">'benchmark'</span><span class="org-rainbow-delimiters-depth-2">)</span>,
    field<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">'name'</span>, $.section_name<span class="org-rainbow-delimiters-depth-2">)</span>,
    field<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">'properties'</span>, $.property_block<span class="org-rainbow-delimiters-depth-2">)</span>,
<span class="org-rainbow-delimiters-depth-1">)</span>,
</pre>
</div>

<p>
It was accepted by <code>tree-sitter generate</code>, but the field <code>type</code> was nowhere to
be found in the parse tree.
</p>

<p>
Then I changed the query to list the anonymous nodes explicitly, like this
</p>

<div class="org-src-container">
<pre class="src src-lisp"><span class="org-rainbow-delimiters-depth-1">(</span>cabal
 <span class="org-rainbow-delimiters-depth-2">(</span>sections
  <span class="org-rainbow-delimiters-depth-3">(</span>_ [<span class="org-string">"benchmark"</span> <span class="org-string">"common"</span> <span class="org-string">"executable"</span> ...] @type
     name: <span class="org-rainbow-delimiters-depth-4">(</span>section_name<span class="org-rainbow-delimiters-depth-4">)</span>? @name<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<p>
That worked, but listing all the sections like that in the query didn't sit
right with me.
</p>

<p>
Luckily there's a <a href="https://github.com/tree-sitter/tree-sitter/discussions">discussions area in tree-sitters GitHub</a> so a <a href="https://github.com/tree-sitter/tree-sitter/discussions/2161">fairly short
discussion</a> later I had answers to why my query behaved like it did and a
solution that would allow me to not list all the section types in the query. The
trick is to wrap the string in a call to <code>alias</code> to make it a named node. After
that it works to add a field name to it as well, of course. The section rules
now look like this
</p>

<div class="org-src-container">
<pre class="src src-javascript">benchmark: $ =&gt; seq<span class="org-rainbow-delimiters-depth-1">(</span>
    repeat<span class="org-rainbow-delimiters-depth-2">(</span>$.comment<span class="org-rainbow-delimiters-depth-2">)</span>,
    field<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">'type'</span>, alias<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">'benchmark'</span>, $.section_type<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>,
    field<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">'name'</span>, $.section_name<span class="org-rainbow-delimiters-depth-2">)</span>,
    field<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">'properties'</span>, $.property_block<span class="org-rainbow-delimiters-depth-2">)</span>,
<span class="org-rainbow-delimiters-depth-1">)</span>,
</pre>
</div>

<p>
and the final query looks like this
</p>

<div class="org-src-container">
<pre class="src src-lisp"><span class="org-rainbow-delimiters-depth-1">(</span>cabal
 <span class="org-rainbow-delimiters-depth-2">(</span>sections
  <span class="org-rainbow-delimiters-depth-3">(</span>_
   type: <span class="org-rainbow-delimiters-depth-4">(</span>section_type<span class="org-rainbow-delimiters-depth-4">)</span> @type
   name: <span class="org-rainbow-delimiters-depth-4">(</span>section_name<span class="org-rainbow-delimiters-depth-4">)</span>? @name<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<p>
With that in place I could improve on the function that collects all the items
for <code>consult-cabal</code> so it now show the section's type and name instead of the
string representation of the tree-sitter node.
</p>
</div>
</div>

<div id="outline-container-orgb7b6c84" class="outline-2">
<h2 id="orgb7b6c84">State in a <code>consult</code> source for preview of lines in a buffer</h2>
<div class="outline-text-2" id="text-orgb7b6c84">
<p>
I was struggling with figuring out how to make a good <i>state</i> function in order
to preview the items in <code>consult-cabal</code>. The <a href="https://github.com/minad/consult">GitHub repo for <code>consult</code></a> doesn't
have discussions enabled, but after a <a href="https://github.com/minad/consult/issues/780">discussion in an issue</a> I'd arrived at a
<i>state</i> function that works very well.
</p>

<p>
The state function makes use of functions in <code>consult</code> and looks like this
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defun</span> <span class="org-function-name">consult-cabal--state</span> <span class="org-rainbow-delimiters-depth-2">()</span>
  <span class="org-doc">"Create a state function for previewing sections."</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">let</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-rainbow-delimiters-depth-4">(</span>state <span class="org-rainbow-delimiters-depth-5">(</span>consult--jump-state<span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>
    <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-keyword">lambda</span> <span class="org-rainbow-delimiters-depth-4">(</span>action cand<span class="org-rainbow-delimiters-depth-4">)</span>
      <span class="org-rainbow-delimiters-depth-4">(</span><span class="org-keyword">when</span> cand
        <span class="org-rainbow-delimiters-depth-5">(</span><span class="org-keyword">let</span> <span class="org-rainbow-delimiters-depth-6">(</span><span class="org-rainbow-delimiters-depth-7">(</span>pos <span class="org-rainbow-delimiters-depth-8">(</span>get-text-property 0 'section-pos cand<span class="org-rainbow-delimiters-depth-8">)</span><span class="org-rainbow-delimiters-depth-7">)</span><span class="org-rainbow-delimiters-depth-6">)</span>
          <span class="org-rainbow-delimiters-depth-6">(</span>funcall state action pos<span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<p>
The trick here was to figure out how the function returned by
<code>consult--jump-state</code> actually works. On the surface it looks like it takes an
<i>action</i> and a <i>candidate</i>, <code>(lambda (action cand) ...)</code>. However, the argument
<code>cand</code> shouldn't be the currently selected item, but rather a postion (ideally a
<code>marker</code>), so I had to attach another text property on the items (<code>section-pos</code>,
which is fetched in the inner lambda). This position is then what's passed to
the function returned by <code>consult--jump-state</code>.
</p>

<p>
In hindsight it seems so easy, but I was struggling with this for an entire
evening before finally asking the question the morning after.
</p>
</div>
</div>
<div class="taglist"><a href="https://magnus.therning.org/tags.html">Tags</a>: <a href="https://magnus.therning.org/tag-consult.html">consult</a> <a href="https://magnus.therning.org/tag-emacs.html">emacs</a> <a href="https://magnus.therning.org/tag-tree-sitter.html">tree-sitter</a> </div>

<div class="post-date">27 Mar 2023</div><h1 class="post-title"><a href="https://magnus.therning.org/2023-03-27-cabal,-tree-sitter,-and-consult.html">Cabal, tree-sitter, and consult</a></h1>
<p>
After my <a href="https://magnus.therning.org/2023-03-22-making-an-emacs-major-mode-for-cabal-using-tree-sitter.html">last post</a> I thought I'd move on to implement the rest of the functions
in <a href="https://github.com/haskell/haskell-mode">haskell-mode</a>'s major mode for Cabal, functions like
<code>haskell-cabal-goto-library-section</code> and
<code>haskell-cabal-goto-executable-section</code>.  Then I realised that what <i>I</i> really
want is a way to quickly jump to any section, that is, I want <code>consult-cabal</code>!
</p>

<p>
What follows is very much a work-in-progress, but hopefully it'll show enough
promise.
</p>

<div id="outline-container-org31e7014" class="outline-2">
<h2 id="org31e7014">Listing the sections</h2>
<div class="outline-text-2" id="text-org31e7014">
<p>
As I have a <code>tree-sitter</code> parse tree to hand it is fairly easy to fetch all the
nodes corresponding to sections.  Since the <a href="https://magnus.therning.org/2023-03-22-making-an-emacs-major-mode-for-cabal-using-tree-sitter.html">last post</a> I've made some
improvements to the parser and now the parse tree looks like this (I can
recommend the function <code>treesit-explore-mode</code> to expore the parse tree, I've
found it invaluable ever since I realised it existed)
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span>cabal
 ...
 <span class="org-rainbow-delimiters-depth-2">(</span>properties ...<span class="org-rainbow-delimiters-depth-2">)</span>
 <span class="org-rainbow-delimiters-depth-2">(</span>sections
  <span class="org-rainbow-delimiters-depth-3">(</span>common common <span class="org-rainbow-delimiters-depth-4">(</span>section_name<span class="org-rainbow-delimiters-depth-4">)</span> ...<span class="org-rainbow-delimiters-depth-3">)</span>
  <span class="org-rainbow-delimiters-depth-3">(</span>library library ...<span class="org-rainbow-delimiters-depth-3">)</span>
  <span class="org-rainbow-delimiters-depth-3">(</span>executable executable <span class="org-rainbow-delimiters-depth-4">(</span>section_name<span class="org-rainbow-delimiters-depth-4">)</span> ...<span class="org-rainbow-delimiters-depth-3">)</span>
  ...<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<p>
That is, all the <i>sections</i> are children of the node called <code>sections</code>.
</p>

<p>
The function to use for fetching all the nodes is <code>treesit-query-capture</code>, it
needs a node to start on, which this case should be the full parse tree,
i.e. <code>(treesit-buffer-root-node 'cabal)</code> and a query string.  Given the
structure of the parse tree, and that I want to capture all children of
<code>sections</code>, a query string like this one works
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-string">"(cabal (sections (_)* @section))"</span>
</pre>
</div>

<p>
Finally, by default <code>treesit-query-capture</code> returns a list of tuples of the form
<code>(&lt;capture&gt; . &lt;node&gt;)</code>, but in this case I only want the list of nodes, so the
full call will look like this
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span>treesit-query-capture <span class="org-rainbow-delimiters-depth-2">(</span>treesit-buffer-root-node 'cabal<span class="org-rainbow-delimiters-depth-2">)</span>
                       <span class="org-string">"(cabal (sections (_)* @section))"</span>
                       nil nil t<span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgcead32c" class="outline-2">
<h2 id="orgcead32c">Hooking it up to consult</h2>
<div class="outline-text-2" id="text-orgcead32c">
<p>
As I envision adding more things to jump to in the future, I decided to make use
of <code>consult--multi</code>. That in turn means I need to define a "source" for the
sections. After a bit of digging and rummaging in the <a href="https://github.com/minad/consult/">consult source</a> I put
together this
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defvar</span> <span class="org-variable-name">consult-cabal--source-section</span>
  `<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-builtin">:name</span> <span class="org-string">"Sections"</span>
    <span class="org-builtin">:category</span> location
    <span class="org-builtin">:action</span> ,#'consult-cabal--section-action
    <span class="org-builtin">:items</span> ,#'consult-cabal--section-items<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-doc">"Definition of source for Cabal sections."</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<p>
which means I need two functions, <code>consult-cabal--section-action</code> and
<code>consult-cabal--section-items</code>. I started with the latter.
</p>
</div>

<div id="outline-container-org72b3791" class="outline-3">
<h3 id="org72b3791">Getting section nodes as items for consult</h3>
<div class="outline-text-3" id="text-org72b3791">
<p>
It took me a while to work understand how this would ever be able to work. The
function that <code>:items</code> point to must return a list of strings, but how would I
ever be able to use just a string to jump to the correct location?
</p>

<p>
The solution is in a comment in the documentation of <code>consult--multi</code>:
</p>

<blockquote>
<p>
:items - List of strings to select from or function returning
 list of strings.  Note that the strings can use text properties
 to carry metadata, which is then available to the :annotate,
 :action and :state functions.
</p>
</blockquote>

<p>
I'd never come across <i>text properties</i> in Emacs before, so at first I
completely missed those two words. Once I'd looked up the concept in the
documentation everything fell into place. The function
<code>consult-cabal--section-items</code> would simply attach the relevant node as a text
property to the strings in the list.
</p>

<p>
My current version, obviously a work-in-progress, takes a list of nodes and
turns them naïvely into a string and attaches the node. I split it into two functions, like this
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defun</span> <span class="org-function-name">consult-cabal--section-to-string</span> <span class="org-rainbow-delimiters-depth-2">(</span>section<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-doc">"Convert a single SECTION node to a string."</span>
  <span class="org-rainbow-delimiters-depth-2">(</span>propertize <span class="org-rainbow-delimiters-depth-3">(</span>format <span class="org-string">"%S"</span> section<span class="org-rainbow-delimiters-depth-3">)</span>
              <span class="org-builtin">:treesit-node</span> section<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defun</span> <span class="org-function-name">consult-cabal--section-items</span> <span class="org-rainbow-delimiters-depth-2">()</span>
  <span class="org-doc">"Fetch all sections as a list of strings ."</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">let</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-rainbow-delimiters-depth-4">(</span>section-nodes <span class="org-rainbow-delimiters-depth-5">(</span>treesit-query-capture <span class="org-rainbow-delimiters-depth-6">(</span>treesit-buffer-root-node 'cabal<span class="org-rainbow-delimiters-depth-6">)</span>
                                              <span class="org-string">"(cabal (sections (_)* @section))"</span>
                                              nil nil t<span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>
    <span class="org-rainbow-delimiters-depth-3">(</span>mapcar #'consult-cabal--section-to-string section-nodes<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org83dad10" class="outline-3">
<h3 id="org83dad10">Implementing the action</h3>
<div class="outline-text-3" id="text-org83dad10">
<p>
The action function is called with the selected item, i.e. with the string and
its properties. That means, to jump to the selected section the function needs
to extract the node property, <code>:treesit-node</code>, and jump to the start of it. the
function to use is <code>get-text-property</code>, and as all characters in the string will
have to property I just picked the first one. The jumping itself I copied from
the navigation functions I'd written before.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defun</span> <span class="org-function-name">consult-cabal--section-action</span> <span class="org-rainbow-delimiters-depth-2">(</span>item<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-doc">"Go to the section referenced by ITEM."</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">when-let*</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-rainbow-delimiters-depth-4">(</span>node <span class="org-rainbow-delimiters-depth-5">(</span>get-text-property 0 <span class="org-builtin">:treesit-node</span> item<span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span>
              <span class="org-rainbow-delimiters-depth-4">(</span>new-pos <span class="org-rainbow-delimiters-depth-5">(</span>treesit-node-start node<span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>
    <span class="org-rainbow-delimiters-depth-3">(</span>goto-char new-pos<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb0e4e64" class="outline-3">
<h3 id="orgb0e4e64">Tying it together with <code>consult--multi</code></h3>
<div class="outline-text-3" id="text-orgb0e4e64">
<p>
The final function, <code>consult-cabal</code>, looks like this
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defun</span> <span class="org-function-name">consult-cabal</span> <span class="org-rainbow-delimiters-depth-2">()</span>
  <span class="org-doc">"Choose a Cabal construct and jump to it."</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">interactive</span><span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">(</span>consult--multi '<span class="org-rainbow-delimiters-depth-3">(</span>consult-cabal--source-section<span class="org-rainbow-delimiters-depth-3">)</span>
                  <span class="org-builtin">:sort</span> nil<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org8f2653b" class="outline-2">
<h2 id="org8f2653b">Conclusions and where to find the code</h2>
<div class="outline-text-2" id="text-org8f2653b">
<p>
The end result works as intended, but it's very rough. I'll try to improve it a
bit more. In particular I want
</p>

<ol class="org-ol">
<li>better strings - <code>(format "%S" node)</code> is all right to start with, but in the
long run I want strings that describe the sections, and</li>
<li>preview as I navigate between items - AFAIU this is what the <code>:state</code> field
is for, but I still haven't looked into how it works.</li>
</ol>

<p>
The source can be found <a href="https://gitlab.com/magus/my-emacs-pkgs/-/blob/main/my-cabal-mode/consult-cabal.el">here</a>.
</p>
</div>
</div>
<div class="taglist"><a href="https://magnus.therning.org/tags.html">Tags</a>: <a href="https://magnus.therning.org/tag-cabal.html">cabal</a> <a href="https://magnus.therning.org/tag-consult.html">consult</a> <a href="https://magnus.therning.org/tag-emacs.html">emacs</a> <a href="https://magnus.therning.org/tag-tree-sitter.html">tree-sitter</a> </div>

<div class="post-date">22 Mar 2023</div><h1 class="post-title"><a href="https://magnus.therning.org/2023-03-22-making-an-emacs-major-mode-for-cabal-using-tree-sitter.html">Making an Emacs major mode for Cabal using tree-sitter</a></h1>
<p>
A few days ago I <a href="https://www.reddit.com/r/haskell/comments/11uvhsk/cabal_grammar_for_treesitter_at_least_the/">posted on r/haskell</a> that I'm attempting to put together a <a href="https://cabal.readthedocs.io/en/stable/index.html">Cabal</a>
grammar for <a href="https://tree-sitter.github.io/tree-sitter/">tree-sitter</a>.  Some things are still missing, but it covers enough to
start doing what I initially intended: experiment with writing an alternative
Emacs major mode for Cabal.
</p>

<p>
The documentation for the tree-sitter integration is very nice, and several of
the major modes already have tree-sitter variants, called <code>X-ts-mode</code> where <code>X</code>
is e.g. <code>python</code>, so putting together the beginning of a major mode wasn't too
much work.
</p>

<div id="outline-container-orgaa93cd2" class="outline-2">
<h2 id="orgaa93cd2">Configuring Emacs</h2>
<div class="outline-text-2" id="text-orgaa93cd2">
<p>
First off I had to make sure the parser for Cabal was installed. The snippet for
that looks like this<sup><a id="fnr.1" class="footref" href="#fn.1" role="doc-backlink">1</a></sup>
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">use-package</span> <span class="org-constant">treesit</span>
  <span class="org-builtin">:straight</span> nil
  <span class="org-builtin">:ensure</span> nil
  <span class="org-builtin">:commands</span> <span class="org-rainbow-delimiters-depth-2">(</span>treesit-install-language-grammar<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-builtin">:init</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">setq</span> treesit-language-source-alist
        '<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-rainbow-delimiters-depth-4">(</span>cabal . <span class="org-rainbow-delimiters-depth-5">(</span><span class="org-string">"https://gitlab.com/magus/tree-sitter-cabal.git"</span><span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<p>
With that in place the parser is installed using <code>M-x
treesit-install-language-grammar</code> and choosing <code>cabal</code>.
</p>

<p>
After that I removed my configuration for <code>haskell-mode</code> and added the following
snippet to get my own major mode into my setup.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">use-package</span> <span class="org-constant">my-cabal-mode</span>
  <span class="org-builtin">:straight</span> <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-builtin">:type</span> git
             <span class="org-builtin">:repo</span> <span class="org-string">"git@gitlab.com:magus/my-emacs-pkgs.git"</span>
             <span class="org-builtin">:branch</span> <span class="org-string">"main"</span>
             <span class="org-builtin">:files</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-builtin">:defaults</span> <span class="org-string">"my-cabal-mode/*el"</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orge3a4a9a" class="outline-2">
<h2 id="orge3a4a9a">The major mode and font-locking</h2>
<div class="outline-text-2" id="text-orge3a4a9a">
<p>
The built-in elisp documentation actually has a section on writing a major mode
with tree-sitter, so it was easy to get started. Setting up the font-locking
took a bit of trial-and-error, but once I had comments looking the way I wanted
it was easy to add to the setup. Oh, and yes, there's a section on font-locking
with tree-sitter in the documentation too. At the moment it looks like this
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defvar</span> <span class="org-variable-name">cabal--treesit-font-lock-setting</span>
  <span class="org-rainbow-delimiters-depth-2">(</span>treesit-font-lock-rules
   <span class="org-builtin">:feature</span> 'comment
   <span class="org-builtin">:language</span> 'cabal
   '<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-rainbow-delimiters-depth-4">(</span>comment<span class="org-rainbow-delimiters-depth-4">)</span> @font-lock-comment-face<span class="org-rainbow-delimiters-depth-3">)</span>

   <span class="org-builtin">:feature</span> 'cabal-version
   <span class="org-builtin">:language</span> 'cabal
   '<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-rainbow-delimiters-depth-4">(</span>cabal_version _<span class="org-rainbow-delimiters-depth-4">)</span> @font-lock-constant-face<span class="org-rainbow-delimiters-depth-3">)</span>

   <span class="org-builtin">:feature</span> 'field-name
   <span class="org-builtin">:language</span> 'cabal
   '<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-rainbow-delimiters-depth-4">(</span>field_name<span class="org-rainbow-delimiters-depth-4">)</span> @font-lock-keyword-face<span class="org-rainbow-delimiters-depth-3">)</span>

   <span class="org-builtin">:feature</span> 'section-name
   <span class="org-builtin">:language</span> 'cabal
   '<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-rainbow-delimiters-depth-4">(</span>section_name<span class="org-rainbow-delimiters-depth-4">)</span> @font-lock-variable-name-face<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-doc">"Tree-sitter font-lock settings."</span><span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-comment-delimiter">;;;</span><span class="org-comment">###</span><span class="org-comment"><span class="org-warning">autoload</span></span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">define-derived-mode</span> <span class="org-function-name">my-cabal-mode</span> fundamental-mode <span class="org-string">"My Cabal"</span>
  <span class="org-doc">"My mode for Cabal files"</span>

  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">when</span> <span class="org-rainbow-delimiters-depth-3">(</span>treesit-ready-p 'cabal<span class="org-rainbow-delimiters-depth-3">)</span>
    <span class="org-rainbow-delimiters-depth-3">(</span>treesit-parser-create 'cabal<span class="org-rainbow-delimiters-depth-3">)</span>
    <span class="org-comment-delimiter">;; </span><span class="org-comment">set up treesit</span>
    <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-keyword">setq-local</span> treesit-font-lock-feature-list
                '<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-rainbow-delimiters-depth-5">(</span>comment field-name section-name<span class="org-rainbow-delimiters-depth-5">)</span>
                  <span class="org-rainbow-delimiters-depth-5">(</span>cabal-version<span class="org-rainbow-delimiters-depth-5">)</span>
                  <span class="org-rainbow-delimiters-depth-5">()</span> <span class="org-rainbow-delimiters-depth-5">()</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>
    <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-keyword">setq-local</span> treesit-font-lock-settings cabal--treesit-font-lock-setting<span class="org-rainbow-delimiters-depth-3">)</span>
    <span class="org-rainbow-delimiters-depth-3">(</span>treesit-major-mode-setup<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-comment-delimiter">;;;</span><span class="org-comment">###</span><span class="org-comment"><span class="org-warning">autoload</span></span>
<span class="org-rainbow-delimiters-depth-1">(</span>add-to-list 'auto-mode-alist '<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\\.cabal\\'"</span> . my-cabal-mode<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org5251e68" class="outline-2">
<h2 id="org5251e68">Navigation</h2>
<div class="outline-text-2" id="text-org5251e68">
<p>
One of the reasons I want to experiment with tree-sitter is to use it for code
navigation. My first attempt is to translate <code>haskell-cabal-section-beginning</code>
(in <code>haskell-mode</code>, <a href="https://github.com/haskell/haskell-mode/blob/master/haskell-cabal.el#L395">the source</a>) to using tree-sitter. First a convenience
function to recognise if a node is a section or not
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defun</span> <span class="org-function-name">cabal--node-is-section-p</span> <span class="org-rainbow-delimiters-depth-2">(</span>n<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-doc">"Predicate to check if treesit node N is a Cabal section."</span>
  <span class="org-rainbow-delimiters-depth-2">(</span>member <span class="org-rainbow-delimiters-depth-3">(</span>treesit-node-type n<span class="org-rainbow-delimiters-depth-3">)</span>
          '<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"benchmark"</span> <span class="org-string">"common"</span> <span class="org-string">"executable"</span> <span class="org-string">"flag"</span> <span class="org-string">"library"</span> <span class="org-string">"test_suite"</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<p>
That makes it possible to use <code>treesit-parent-until</code> to traverse the nodes until
hitting a section node
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defun</span> <span class="org-function-name">cabal-goto-beginning-of-section</span> <span class="org-rainbow-delimiters-depth-2">()</span>
  <span class="org-doc">"Go to the beginning of the current section."</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">interactive</span><span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">when-let*</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-rainbow-delimiters-depth-4">(</span>node-at-point <span class="org-rainbow-delimiters-depth-5">(</span>treesit-node-at <span class="org-rainbow-delimiters-depth-6">(</span>point<span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span>
              <span class="org-rainbow-delimiters-depth-4">(</span>section-node <span class="org-rainbow-delimiters-depth-5">(</span>treesit-parent-until node-at-point #'cabal--node-is-section-p<span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span>
              <span class="org-rainbow-delimiters-depth-4">(</span>start-pos <span class="org-rainbow-delimiters-depth-5">(</span>treesit-node-start section-node<span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>
    <span class="org-rainbow-delimiters-depth-3">(</span>goto-char start-pos<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<p>
And the companion function, to go to the end of a section is very similar
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defun</span> <span class="org-function-name">cabal-goto-end-of-section</span> <span class="org-rainbow-delimiters-depth-2">()</span>
  <span class="org-doc">"Go to the end of the current section."</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">interactive</span><span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">when-let*</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-rainbow-delimiters-depth-4">(</span>node-at-point <span class="org-rainbow-delimiters-depth-5">(</span>treesit-node-at <span class="org-rainbow-delimiters-depth-6">(</span>point<span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span>
              <span class="org-rainbow-delimiters-depth-4">(</span>section-node <span class="org-rainbow-delimiters-depth-5">(</span>treesit-parent-until node-at-point #'cabal--node-is-section-p<span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span>
              <span class="org-rainbow-delimiters-depth-4">(</span>end-pos <span class="org-rainbow-delimiters-depth-5">(</span>treesit-node-end section-node<span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>
    <span class="org-rainbow-delimiters-depth-3">(</span>goto-char end-pos<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" class="footnum" href="#fnr.1" role="doc-backlink">1</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
I'm using <a href="https://github.com/radian-software/straight.el">straight.el</a> and <code>use-package</code> in my setup, but hopefully the
snippets can easily be converted to other ways of configuring Emacs.
</p></div></div>


</div>
</div><div class="taglist"><a href="https://magnus.therning.org/tags.html">Tags</a>: <a href="https://magnus.therning.org/tag-cabal.html">cabal</a> <a href="https://magnus.therning.org/tag-emacs.html">emacs</a> <a href="https://magnus.therning.org/tag-haskell.html">haskell</a> <a href="https://magnus.therning.org/tag-tree-sitter.html">tree-sitter</a> </div>

<div class="post-date">03 Mar 2023</div><h1 class="post-title"><a href="https://magnus.therning.org/2023-03-03-per-project-xref-history-in-emacs.html">Per-project xref history in Emacs</a></h1>
<p>
When I write code I jump around in the code quite a bit, as I'm sure many other
developers do. The ability to jump to the definition of a function, or a type,
is invaluable when trying to understand code. In Emacs the built-in <a href="https://www.gnu.org/software/emacs/manual/html_node/emacs/Xref.html">xref package</a>
provides the basic functionality for this, with many other packages providing
their custom functions for looking up identifiers. This works beautifully except
for one thing, there's only one global stack for keeping track of how you've
jumped around.
</p>

<p>
Well, that used to be the case.
</p>

<p>
As I tend to have multiple projects open at a time I used to find it very
confusing when I pop positions off the <code>xref</code> stack and all of a sudden find
myself in another project. It would be so much nicer to have a per-project
stack.
</p>

<p>
I've only known of one solution for this, the <a href="https://github.com/nex3/perspective-el">perspective package</a>, but as I've
been building <a href="https://magnus.therning.org/2022-07-09-playing-with-setting-up-emacs.html">my own Emacs config</a> I wanted to see if there were other options.
It turns out there is one (almost) built into Emacs 29.
</p>

<p>
In Emacs 29 there's built-in support for having per-window <code>xref</code> stacks, and
the way that's done allows one to extend it further. There's now a variable,
<code>xref-history-storage</code>, that controls access to the <code>xref</code> stack. The default is
still a global stack (when the variable is set to <code>#'xref-global-history</code>), but
to get per-window stacks one sets it to <code>#'xref-window-local-history</code>.
</p>

<p>
After finding this out I thought I'd try to write my own, implementing
per-project <code>xref</code> stacks (for <a href="https://github.com/bbatsov/projectile">projectile</a>).
</p>

<p>
The function should take one optional argument, <code>new-value</code>, if it's provided
the stack should be updated and if not, it should be returned. That is,
something like this
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defun</span> <span class="org-function-name">projectile-param-xref-history</span> <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">&amp;optional</span> new-value<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-doc">"Return project-local xref history for the current projectile.</span>

<span class="org-doc">Override existing value with NEW-VALUE if it's set."</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">if</span> new-value
      <span class="org-rainbow-delimiters-depth-3">(</span>projectile-param-set-parameter 'xref--history new-value<span class="org-rainbow-delimiters-depth-3">)</span>
    <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-keyword">or</span> <span class="org-rainbow-delimiters-depth-4">(</span>projectile-param-get-parameter 'xref--history<span class="org-rainbow-delimiters-depth-4">)</span>
        <span class="org-rainbow-delimiters-depth-4">(</span>projectile-param-set-parameter 'xref--history <span class="org-rainbow-delimiters-depth-5">(</span>xref--make-xref-history<span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<p>
Now I only had to write the two functions <code>projectile-param-get-parameter</code> and
<code>projectile-param-set-parameter</code>. I thought a rather straight forward option
would be to use a hashtable and store values under a tuple comprising the
project name and the parameter passed in.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defvar</span> <span class="org-variable-name">projectile-params--store</span> <span class="org-rainbow-delimiters-depth-2">(</span>make-hash-table <span class="org-builtin">:test</span> 'equal<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-doc">"The store of project parameters."</span><span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defun</span> <span class="org-function-name">projectile-param-get-parameter</span> <span class="org-rainbow-delimiters-depth-2">(</span>param<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-doc">"Return project parameter PARAM, or nil if unset."</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">let</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-rainbow-delimiters-depth-4">(</span>key <span class="org-rainbow-delimiters-depth-5">(</span>cons <span class="org-rainbow-delimiters-depth-6">(</span>projectile-project-name<span class="org-rainbow-delimiters-depth-6">)</span> param<span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>
    <span class="org-rainbow-delimiters-depth-3">(</span>gethash key projectile-params--store nil<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defun</span> <span class="org-function-name">projectile-param-set-parameter</span> <span class="org-rainbow-delimiters-depth-2">(</span>param value<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-doc">"Set the project parameter PARAM to VALUE."</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">let</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-rainbow-delimiters-depth-4">(</span>key <span class="org-rainbow-delimiters-depth-5">(</span>cons <span class="org-rainbow-delimiters-depth-6">(</span>projectile-project-name<span class="org-rainbow-delimiters-depth-6">)</span> param<span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>
    <span class="org-rainbow-delimiters-depth-3">(</span>puthash key value projectile-params--store<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>
  value<span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<p>
Then I tried it out by setting <code>xref-history-storage</code>
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">setq</span> xref-history-storage #'projectile-param-xref-history<span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<p>
and so far it's been working well.
</p>

<p>
The full code is <a href="https://gitlab.com/magus/my-emacs-pkgs/-/blob/main/my-projectile-params/my-projectile-params.el">here</a>.
</p>
<div class="taglist"><a href="https://magnus.therning.org/tags.html">Tags</a>: <a href="https://magnus.therning.org/tag-emacs.html">emacs</a> <a href="https://magnus.therning.org/tag-xref.html">xref</a> <a href="https://magnus.therning.org/tag-projectile.html">projectile</a> </div>

<div class="post-date">24 Sep 2022</div><h1 class="post-title"><a href="https://magnus.therning.org/2022-09-24-annotate-projects-in-emacs.html">Annotate projects in Emacs</a></h1>
<p>
Every now and then I've wished to write comments on files in a project, but I've
never found a good way to do that. <a href="https://www.emacswiki.org/emacs/Annotate">annotate.el</a> and <a href="https://www.emacswiki.org/emacs/OrgAnnotateFile">org-annotate-file</a> both
collect annotations in a central place (in my <code>$HOME</code>), while <a href="https://www.emacswiki.org/emacs/Marginalia">marginalia</a> puts
annotations in files next to the source files but in a format that's rather
cryptic and tends to be messed up when attached to multiple lines. None of them
is ideal, I'd like the format to be org-mode, but not in a central file. At the
same time having one annotation file per source file is simply too much.
</p>

<p>
I tried wrapping <code>org-annotate-file</code>, setting <code>org-annotate-file-storage-file</code>
and taking advantage of elisp's dynamic binding. However, it opens the
annotation file in the current window, and I'd really like to split the window
and open the annotations the right. Rather than trying to sort of "work it out
backwards" I decided to write a small package and use as much of the
functionality in <code>org-annotate-file.el</code> as possible.
</p>

<p>
First off I decided that I want the annotation file to be called
<code>projectile-annotations.org</code>.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defvar</span> <span class="org-variable-name">org-projectile-annotate-file-name</span> <span class="org-string">"projectile-annotations.org"</span>
  <span class="org-doc">"The name of the file to store project annotations."</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<p>
Then I wanted a slightly modified version of <code>org-annotate-file-show-section</code>, I
wanted it to respect the root of the project.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defun</span> <span class="org-function-name">org-projectile-annotate--file-show-section</span> <span class="org-rainbow-delimiters-depth-2">(</span>storage-file<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-doc">"Add or show annotation entry in STORAGE-FILE and return the buffer."</span>
  <span class="org-comment-delimiter">;; </span><span class="org-comment">modified version of org-annotate-file-show-section</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">let*</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-rainbow-delimiters-depth-4">(</span>proj-root <span class="org-rainbow-delimiters-depth-5">(</span>projectile-project-root<span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span>
         <span class="org-rainbow-delimiters-depth-4">(</span>filename <span class="org-rainbow-delimiters-depth-5">(</span>file-relative-name buffer-file-name proj-root<span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span>
         <span class="org-rainbow-delimiters-depth-4">(</span>line <span class="org-rainbow-delimiters-depth-5">(</span>buffer-substring-no-properties <span class="org-rainbow-delimiters-depth-6">(</span>point-at-bol<span class="org-rainbow-delimiters-depth-6">)</span> <span class="org-rainbow-delimiters-depth-6">(</span>point-at-eol<span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span>
         <span class="org-rainbow-delimiters-depth-4">(</span>annotation-buffer <span class="org-rainbow-delimiters-depth-5">(</span>find-file-noselect storage-file<span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>
    <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-keyword">with-current-buffer</span> annotation-buffer
      <span class="org-rainbow-delimiters-depth-4">(</span>org-annotate-file-annotate filename line<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>
    annotation-buffer<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<p>
The main function can then simply work out where the file with annotations
should be located and call <code>org-projectile-annotate--file-show-section</code>.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defun</span> <span class="org-function-name">org-projectile-annotate</span> <span class="org-rainbow-delimiters-depth-2">()</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">interactive</span><span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">let</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-rainbow-delimiters-depth-4">(</span>annot-fn <span class="org-rainbow-delimiters-depth-5">(</span>file-name-concat <span class="org-rainbow-delimiters-depth-6">(</span>projectile-project-root<span class="org-rainbow-delimiters-depth-6">)</span>
                                    org-projectile-annotate-file-name<span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>
    <span class="org-rainbow-delimiters-depth-3">(</span>set-window-buffer <span class="org-rainbow-delimiters-depth-4">(</span>split-window-right<span class="org-rainbow-delimiters-depth-4">)</span>
                       <span class="org-rainbow-delimiters-depth-4">(</span>org-projectile-annotate--file-show-section annot-fn<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<p>
When testing it all out I noticed that <code>org-store-link</code> makes a link with a
search text. In my case it would be much better to have links with line numbers.
I found there's a hook to modify the behaviour of <code>org-store-link</code>,
<code>org-create-file-search-functions</code>. So I wrote a function to get the kind of
links I want, but only when the project annotation file is open in a buffer.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defun</span> <span class="org-function-name">org-projectile-annotate-file-search-func</span> <span class="org-rainbow-delimiters-depth-2">()</span>
  <span class="org-doc">"A function returning the current line number when called in a</span>
<span class="org-doc">project while the project annotation file is open.</span>

<span class="org-doc">This function is designed for use in the hook</span>
<span class="org-doc">'</span><span class="org-doc"><span class="org-constant">org-create-file-search-functions</span></span><span class="org-doc">'. It changes the behaviour of</span>
<span class="org-doc">'</span><span class="org-doc"><span class="org-constant">org-store-link</span></span><span class="org-doc">' so it constructs a link with a line number</span>
<span class="org-doc">instead of a search string."</span>
  <span class="org-comment-delimiter">;; </span><span class="org-comment"><span class="custom">TODO:</span></span><span class="org-comment"> find a way to make the link description nicer</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">when</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-keyword">and</span> <span class="org-rainbow-delimiters-depth-4">(</span>projectile-project-p<span class="org-rainbow-delimiters-depth-4">)</span>
             <span class="org-rainbow-delimiters-depth-4">(</span>get-buffer-window org-projectile-annotate-file-name<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>
    <span class="org-rainbow-delimiters-depth-3">(</span>number-to-string <span class="org-rainbow-delimiters-depth-4">(</span>line-number-at-pos<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<p>
That's it, now I only have to wait until the next time I want to comment on a
project to see if it improves my way of working.
</p>
<div class="taglist"><a href="https://magnus.therning.org/tags.html">Tags</a>: <a href="https://magnus.therning.org/tag-emacs.html">emacs</a> <a href="https://magnus.therning.org/tag-org-mode.html">org-mode</a> </div>

<div class="post-date">09 Jul 2022</div><h1 class="post-title"><a href="https://magnus.therning.org/2022-07-09-playing-with-setting-up-emacs.html">Playing with setting up Emacs</a></h1>
<p>
TL;DR: I've put together a small-ish Emacs configuration that I call <a href="https://gitlab.com/magus/mes">MES</a>.
Hopefully it can be of use to someone out there.
</p>

<div id="outline-container-org34c29d2" class="outline-2">
<h2 id="org34c29d2">My Emacs Setup - MES</h2>
<div class="outline-text-2" id="text-org34c29d2">
<p>
The other day I started watching some videos in the <a href="https://www.youtube.com/watch?v=74zOY-vgkyw&amp;list=PLEoMzSkcN8oPH1au7H6B7bBJ4ZO7BXjSZ">Emacs From Scratch</a> series
from <a href="https://github.com/SystemCrafters">System Crafters</a>. It looked like something that could be fun to play with so
over the last couple of days I've been tinkering with putting together the
beginnings of a configuration.
</p>

<p>
During the process I realised just how much work it'd be to put together
something that comes close to the polish of <a href="http://spacemacs.org/">Spacemacs</a>, so I've currently no
intention of actually using <i>MES</i> myself. It was fun though, and maybe it can
serve as inspiration (or as a deterrent) for someone else.
</p>

<p>
The major parts are
</p>

<ul class="org-ul">
<li><a href="https://github.com/emacs-evil/evil">evil</a></li>
<li><a href="https://github.com/minad/vertico">vertico</a>/<a href="https://github.com/minad/consult">consult</a>/&#x2026;</li>
<li><a href="https://github.com/noctuid/general.el">general.el</a></li>
<li><a href="https://magit.vc/">magit</a></li>
<li><a href="https://github.com/mclear-tools/tabspaces">tabspaces</a> (minimal config so I'm not sure it's useful)</li>
<li><a href="https://orgmode.org/">orgmode</a> (only the very basics)</li>
</ul>
</div>
</div>
<div class="taglist"><a href="https://magnus.therning.org/tags.html">Tags</a>: <a href="https://magnus.therning.org/tag-emacs.html">emacs</a> </div>

<div class="post-date">15 Jun 2022</div><h1 class="post-title"><a href="https://magnus.therning.org/2022-06-15-power-mode-in-spacemacs.html">Power-mode in Spacemacs</a></h1>
<p>
I just found the <a href="https://github.com/elizagamedev/power-mode.el">Power Mode</a> for Emacs. If you want to try it out in Spacemacs
you can make sure that your <code>~/.spacemacs</code> contains the following
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">dotspacemacs-additional-packages
'<span class="org-rainbow-delimiters-depth-1">(</span>
  ...
  <span class="org-rainbow-delimiters-depth-2">(</span>power-mode <span class="org-builtin">:location</span> <span class="org-rainbow-delimiters-depth-3">(</span>recipe
                         <span class="org-builtin">:fetcher</span> github
                         <span class="org-builtin">:repo</span> <span class="org-string">"elizagamedev/power-mode.el"</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<p>
After a restart Power Mode can be turned on using <code>SPC SPC power-mode</code>.
</p>

<p>
Unfortunately I found that it slows down rendering so badly that Emacs isn't
keeping up with my typing. Even though I removed it right away again it was fun
to try it out, and I did learn how to add package to Spacemacs that aren't on
MELPA.
</p>

<p>
A useful resource is this <a href="https://github.com/melpa/melpa#recipe-format">reference on the recipe format</a>.
</p>
<div class="taglist"><a href="https://magnus.therning.org/tags.html">Tags</a>: <a href="https://magnus.therning.org/tag-emacs.html">emacs</a> <a href="https://magnus.therning.org/tag-spacemacs.html">spacemacs</a> </div>

<div class="post-date">09 May 2022</div><h1 class="post-title"><a href="https://magnus.therning.org/2022-05-09-comments-and-org-static-blog.html">Comments and org-static-blog</a></h1>
<p>
I'm using <a href="https://github.com/bastibe/org-static-blog">org-static-blog</a> to generate the contents of this site. So far I'm very
happy with it, but I've gotten a few emails from readers who've wanted to
comment on something I've written and they always point out that it's not easy
to do. It's actually not a coincidence that it's a bit difficult!
</p>

<p>
Yesterday I came up with a way that might make is slightly easier without
involving JavaScript from a 3rd party. By making use of the built-in support for
adding HTML code for comments. One slight limitation is that it's a single
variable holding the code, and I'd really like to allow for both
</p>

<ul class="org-ul">
<li>using a link to a discussion site, e.g. <a href="https://www.reddit.com/">reddit</a>, as well as</li>
<li>my email address</li>
</ul>


<p>
As the comment support in org-static-blog comes in the form of a single variable
this seems a bit difficult to accomplish. However, it isn't difficult at all to
do in elisp due to the power of <code>advice-add</code>.
</p>

<p>
By using the following advice on <code>org-static-blog-publish-file</code>
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span>advice-add 'org-static-blog-publish-file <span class="org-builtin">:around</span>
            <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">lambda</span> <span class="org-rainbow-delimiters-depth-3">(</span>orig-fn filename <span class="org-type">&amp;rest</span> args<span class="org-rainbow-delimiters-depth-3">)</span>
              <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-keyword">let*</span>  <span class="org-rainbow-delimiters-depth-4">(</span><span class="org-rainbow-delimiters-depth-5">(</span>comments-url <span class="org-rainbow-delimiters-depth-6">(</span><span class="org-keyword">with-temp-buffer</span>
                                      <span class="org-rainbow-delimiters-depth-7">(</span>insert-file-contents filename<span class="org-rainbow-delimiters-depth-7">)</span>
                                      <span class="org-rainbow-delimiters-depth-7">(</span><span class="org-keyword">or</span> <span class="org-rainbow-delimiters-depth-8">(</span>cadar <span class="org-rainbow-delimiters-depth-9">(</span>org-collect-keywords '<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"commentsurl"</span><span class="org-rainbow-delimiters-depth-1">)</span><span class="org-rainbow-delimiters-depth-9">)</span><span class="org-rainbow-delimiters-depth-8">)</span>
                                          my-blog-default-comments-url<span class="org-rainbow-delimiters-depth-7">)</span><span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span>
                      <span class="org-rainbow-delimiters-depth-5">(</span>org-static-blog-post-comments <span class="org-rainbow-delimiters-depth-6">(</span>concat <span class="org-string">"Comment &lt;a href="</span> comments-url <span class="org-string">"&gt;here&lt;/a&gt;."</span><span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span>
                <span class="org-rainbow-delimiters-depth-4">(</span>apply orig-fn filename args<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<p>
and defining <code>my-blog-default-comments-url</code> to a <code>mailto:...</code> URL I get a link
to use for commenting by either
</p>

<ol class="org-ol">
<li>set <code>commentsurl</code> to point to discussion about the post on reddit, or</li>
<li>not set <code>commentsurl</code> at all and get the <code>mailto:...</code> URL.</li>
</ol>


<p>
If you look at <a href="https://magnus.therning.org/2022-05-08-a-little-haskell:-epoch-timestamp.html">my previous post</a> you see the result of the former, and if you
look below you see the result of the latter.
</p>
<div class="taglist"><a href="https://magnus.therning.org/tags.html">Tags</a>: <a href="https://magnus.therning.org/tag-emacs.html">emacs</a> <a href="https://magnus.therning.org/tag-org-mode.html">org-mode</a> </div>

<div class="post-date">30 Jan 2022</div><h1 class="post-title"><a href="https://magnus.therning.org/2022-01-30-keeping-projectile's-cache-tidy.html">Keeping Projectile's cache tidy</a></h1>
<p>
A while back I added a function to find all projects recursively from a
directory and add them to Projectile's cache (see the <a href="2019-11-05-000-populating-projectile-s-cache.html">Populating Projectile's
cache</a>). Since then I've just made a tiny change to also include containing a
<code>.projectile</code> file.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defun</span> <span class="org-function-name">projectile-extra-add-projects-in-subfolders</span> <span class="org-rainbow-delimiters-depth-2">(</span>projects-root<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">interactive</span> <span class="org-rainbow-delimiters-depth-3">(</span>list <span class="org-rainbow-delimiters-depth-4">(</span>read-directory-name <span class="org-string">"Add to known projects: "</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">(</span>message <span class="org-string">"Searching for projects in %s..."</span> projects-root<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">let*</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-rainbow-delimiters-depth-4">(</span>proj-rx <span class="org-rainbow-delimiters-depth-5">(</span><span class="org-keyword">rx</span> <span class="org-rainbow-delimiters-depth-6">(</span><span class="org-keyword">and</span> line-start ?. <span class="org-rainbow-delimiters-depth-7">(</span><span class="org-keyword">or</span> <span class="org-string">"projectile"</span> <span class="org-string">"git"</span><span class="org-rainbow-delimiters-depth-7">)</span> line-end<span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span>
         <span class="org-rainbow-delimiters-depth-4">(</span>dirs <span class="org-rainbow-delimiters-depth-5">(</span>seq-map
                'file-name-directory
                <span class="org-rainbow-delimiters-depth-6">(</span>directory-files-recursively projects-root
                                             proj-rx
                                             t<span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>
    <span class="org-rainbow-delimiters-depth-3">(</span>seq-do 'projectile-add-known-project dirs<span class="org-rainbow-delimiters-depth-3">)</span>
    <span class="org-rainbow-delimiters-depth-3">(</span>message <span class="org-string">"Added %d projects"</span> <span class="org-rainbow-delimiters-depth-4">(</span>length dirs<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<p>
Since then I've also found a need for tidying the cache, in my casse that means
removing entries in the cache that no longer exist on disk. I didn't find a
function for it, so I wrote one.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defun</span> <span class="org-function-name">projectile-extra-tidy-projects</span> <span class="org-rainbow-delimiters-depth-2">()</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">interactive</span><span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">let</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-rainbow-delimiters-depth-4">(</span>missing-dirs <span class="org-rainbow-delimiters-depth-5">(</span>seq-remove 'file-directory-p projectile-known-projects<span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>
    <span class="org-rainbow-delimiters-depth-3">(</span>seq-do 'projectile-remove-known-project missing-dirs<span class="org-rainbow-delimiters-depth-3">)</span>
    <span class="org-rainbow-delimiters-depth-3">(</span>message <span class="org-string">"Tidied %d projects"</span> <span class="org-rainbow-delimiters-depth-4">(</span>length missing-dirs<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>
<div class="taglist"><a href="https://magnus.therning.org/tags.html">Tags</a>: <a href="https://magnus.therning.org/tag-emacs.html">emacs</a> <a href="https://magnus.therning.org/tag-elisp.html">elisp</a> <a href="https://magnus.therning.org/tag-projectile.html">projectile</a> </div>
<div class="post-date">01 Jan 2022</div><h1 class="post-title"><a href="https://magnus.therning.org/2022-01-01-trimming-newline-on-code-block-variable.html">Trimming newline on code block variable</a></h1>
<p>
Today I found <a href="https://github.com/zweifisch/ob-http">ob-http</a> and decided to try it out a little. I quickly ran into a
problem of a trailing newline. Basically I tried to do something like this:
</p>

<div class="org-src-container">
<pre class="src src-org"><span class="org-org-meta-line">#+name: id</span>
<span class="org-org-block-begin-line">#+begin_src http :select .id :cache yes</span>
<span class="org-org-block"><span class="org-constant">POST</span></span><span class="org-org-block"> </span><span class="org-org-block"><span class="org-function-name">/foo</span></span>
<span class="org-org-block"><span class="org-variable-name">Content-Type</span></span><span class="org-org-block"><span class="org-comment">:</span></span><span class="org-org-block"> </span><span class="org-org-block"><span class="org-string">application/json</span></span>

<span class="org-org-block"><span class="org-comment">{</span></span>
<span class="org-org-block">  </span><span class="org-org-block"><span class="org-string">"foo"</span></span><span class="org-org-block"><span class="org-comment">:</span></span><span class="org-org-block"> </span><span class="org-org-block"><span class="org-string">"toto"</span></span><span class="org-org-block"><span class="org-comment">,</span></span>
<span class="org-org-block">  </span><span class="org-org-block"><span class="org-string">"bar"</span></span><span class="org-org-block"><span class="org-comment">:</span></span><span class="org-org-block"> </span><span class="org-org-block"><span class="org-string">"tata"</span></span>
<span class="org-org-block"><span class="org-comment">}</span></span>
<span class="org-org-block-end-line">#+end_src</span>

<span class="org-org-meta-line">#+RESULTS[c5fd99206822a2109d7ac1d140185e6ec3f4f1d9]: id</span>
<span class="org-org-block-begin-line">#+begin_example</span>
<span class="custom">48722051-f81b-433f-acb4-a65d961ec841</span>
<span class="org-org-block-end-line">#+end_example</span>

<span class="org-org-meta-line">#+header: :var id=id</span>
<span class="org-org-block-begin-line">#+begin_src http</span>
<span class="org-org-block"><span class="org-constant">POST</span></span><span class="org-org-block"> </span><span class="org-org-block"><span class="org-function-name">/foo/${id}/fix</span></span>
<span class="org-org-block-end-line">#+end_src</span>
</pre>
</div>

<p>
The trailing newline messes up the URL though, and the second code block fails.
</p>

<p>
I found two ways to deal with it, using a table and using <code>org-sbe</code>
</p>

<div id="outline-container-org3ef143c" class="outline-2">
<h2 id="org3ef143c">Using a table</h2>
<div class="outline-text-2" id="text-org3ef143c">
<div class="org-src-container">
<pre class="src src-org"><span class="org-org-meta-line">#+name: id</span>
<span class="org-org-block-begin-line">#+begin_src http :select .id :cache yes :results table</span>
<span class="org-org-block"><span class="org-constant">POST</span></span><span class="org-org-block"> </span><span class="org-org-block"><span class="org-function-name">/foo</span></span>
<span class="org-org-block"><span class="org-variable-name">Content-Type</span></span><span class="org-org-block"><span class="org-comment">:</span></span><span class="org-org-block"> </span><span class="org-org-block"><span class="org-string">application/json</span></span>

<span class="org-org-block"><span class="org-comment">{</span></span>
<span class="org-org-block">  </span><span class="org-org-block"><span class="org-string">"foo"</span></span><span class="org-org-block"><span class="org-comment">:</span></span><span class="org-org-block"> </span><span class="org-org-block"><span class="org-string">"toto"</span></span><span class="org-org-block"><span class="org-comment">,</span></span>
<span class="org-org-block">  </span><span class="org-org-block"><span class="org-string">"bar"</span></span><span class="org-org-block"><span class="org-comment">:</span></span><span class="org-org-block"> </span><span class="org-org-block"><span class="org-string">"tata"</span></span>
<span class="org-org-block"><span class="org-comment">}</span></span>
<span class="org-org-block-end-line">#+end_src</span>

<span class="org-org-meta-line">#+RESULTS[c5fd99206822a2109d7ac1d140185e6ec3f4f1d9]: id</span>
<span class="org-org-block-begin-line">#+begin_example</span>
<span class="custom">| 48722051-f81b-433f-acb4-a65d961ec841 |</span>
<span class="org-org-block-end-line">#+end_example</span>

<span class="org-org-meta-line">#+header: :var id=id[0,0]</span>
<span class="org-org-block-begin-line">#+begin_src http</span>
<span class="org-org-block"><span class="org-constant">POST</span></span><span class="org-org-block"> </span><span class="org-org-block"><span class="org-function-name">/foo/${id}/fix</span></span>
<span class="org-org-block-end-line">#+end_src</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org33493ca" class="outline-2">
<h2 id="org33493ca">Using <code>org-sbe</code></h2>
<div class="outline-text-2" id="text-org33493ca">
<div class="org-src-container">
<pre class="src src-org"><span class="org-org-meta-line">#+name: id</span>
<span class="org-org-block-begin-line">#+begin_src http :select .id :cache yes</span>
<span class="org-org-block"><span class="org-constant">POST</span></span><span class="org-org-block"> </span><span class="org-org-block"><span class="org-function-name">/foo</span></span>
<span class="org-org-block"><span class="org-variable-name">Content-Type</span></span><span class="org-org-block"><span class="org-comment">:</span></span><span class="org-org-block"> </span><span class="org-org-block"><span class="org-string">application/json</span></span>

<span class="org-org-block"><span class="org-comment">{</span></span>
<span class="org-org-block">  </span><span class="org-org-block"><span class="org-string">"foo"</span></span><span class="org-org-block"><span class="org-comment">:</span></span><span class="org-org-block"> </span><span class="org-org-block"><span class="org-string">"toto"</span></span><span class="org-org-block"><span class="org-comment">,</span></span>
<span class="org-org-block">  </span><span class="org-org-block"><span class="org-string">"bar"</span></span><span class="org-org-block"><span class="org-comment">:</span></span><span class="org-org-block"> </span><span class="org-org-block"><span class="org-string">"tata"</span></span>
<span class="org-org-block"><span class="org-comment">}</span></span>
<span class="org-org-block-end-line">#+end_src</span>

<span class="org-org-meta-line">#+RESULTS[c5fd99206822a2109d7ac1d140185e6ec3f4f1d9]: id</span>
<span class="org-org-block-begin-line">#+begin_example</span>
<span class="custom">48722051-f81b-433f-acb4-a65d961ec841</span>
<span class="org-org-block-end-line">#+end_example</span>

<span class="org-org-meta-line">#+header: :var id=(org-sbe id)</span>
<span class="org-org-block-begin-line">#+begin_src http</span>
<span class="org-org-block"><span class="org-constant">POST</span></span><span class="org-org-block"> </span><span class="org-org-block"><span class="org-function-name">/foo/${id}/fix</span></span>
<span class="org-org-block-end-line">#+end_src</span>
</pre>
</div>
</div>
</div>
<div class="taglist"><a href="https://magnus.therning.org/tags.html">Tags</a>: <a href="https://magnus.therning.org/tag-emacs.html">emacs</a> <a href="https://magnus.therning.org/tag-org-mode.html">org-mode</a> </div>
<div class="post-date">08 Dec 2021</div><h1 class="post-title"><a href="https://magnus.therning.org/2021-12-08-magit_forge-and-self-hosted-gitlab.html">Magit/forge and self-hosted GitLab</a></h1>
<p>
As I found the documentation for adding a self-hosted instance of GitLab to to
magit/forge a bit difficult, I thought I'd write a note for my future self (and
anyone else who might find it useful).
</p>

<p>
First put the following in `~/.gitconfig`
</p>

<div class="org-src-container">
<pre class="src src-gitconfig">[<span class="org-type">gitlab</span> <span class="org-function-name">"gitlab.private.com/api/v4"</span>]
  <span class="org-variable-name">user</span> = my.username
</pre>
</div>

<p>
Then create an access token on GitLab. I ticked <code>api</code> and <code>write_repository</code>,
which seems to work fine so far. Put the token in <code>~/.authinfo.gpg</code>
</p>

<div class="org-src-container">
<pre class="src src-authinfo"><span class="org-variable-name">machine</span> <span class="org-builtin">gitlab.private.com/api/v4</span> <span class="org-comment-delimiter">login</span> <span class="org-keyword">my.user^forge</span> <span class="org-comment-delimiter">password</span> <span class="org-doc">&lt;token&gt;</span>
</pre>
</div>

<p>
(Remember that a newline is needed at the end of the file.)
</p>

<p>
Finally, add the GitLab instance to <code>'forge-alist</code>
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">setq</span>
 forge-alist
 '<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"gitlab.private.com"</span> <span class="org-string">"gitlab.private.com/api/v4"</span> <span class="org-string">"gitlab.private.com"</span> forge-gitlab-repository<span class="org-rainbow-delimiters-depth-3">)</span>
   <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"github.com"</span> <span class="org-string">"api.github.com"</span> <span class="org-string">"github.com"</span> forge-github-repository<span class="org-rainbow-delimiters-depth-3">)</span>
   <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"gitlab.com"</span> <span class="org-string">"gitlab.com/api/v4"</span> <span class="org-string">"gitlab.com"</span> forge-gitlab-repository<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>
 <span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<p>
That's it!
</p>
<div class="taglist"><a href="https://magnus.therning.org/tags.html">Tags</a>: <a href="https://magnus.therning.org/tag-emacs.html">emacs</a> <a href="https://magnus.therning.org/tag-git.html">git</a> <a href="https://magnus.therning.org/tag-magit.html">magit</a> </div>
<div class="post-date">23 Jul 2021</div><h1 class="post-title"><a href="https://magnus.therning.org/2021-07-23-keeping-todo-items-in-org-roam-v2.html">Keeping todo items in org-roam v2</a></h1>
<p>
Org-roam v2 has been <a href="https://blog.jethro.dev/posts/org_roam_v2/">released</a> and yes, it broke my config a bit. Unfortunately
the v1-to-v2 upgrade wizard didn't work for me. I realized later that it might
have been due to the roam-related functions I'd hooked into `'before-save-hook`.
I didn't think about it until I'd already manually touched up almost all my
files (there aren't that many) so I can't say anything for sure. However, I
think it might be a good idea to keep hooks in mind if one runs into issues with
upgrading.
</p>

<p>
The majority of the time I didn't spend on my notes though, but on the setup
I've written about in an earlier post, <a href="https://magnus.therning.org/2021-03-14-keeping-todo-items-in-org-roam.html">Keeping todo items in org-roam</a>. Due to
some of the changes in v2, changes that I think make org-roam slightly more
"org-y", that setup needed a bit of love.
</p>

<p>
The basis is still the same 4 functions I described in that post, only the
details had to be changed.
</p>

<p>
I hope the following is useful, and as always I'm always happy to receive
commends and suggestions for improvements.
</p>

<div id="outline-container-org2ca70ee" class="outline-2">
<h2 id="org2ca70ee">Some tag helpers</h2>
<div class="outline-text-2" id="text-org2ca70ee">
<p>
The very handy functions for extracting tags as lists seem to be gone, in their
place I found <code>org-roam-{get,set}-keyword</code>. Using these I wrote three wrappers
that allow slightly nicer handling of tags.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defun</span> <span class="org-function-name">roam-extra:get-filetags</span> <span class="org-rainbow-delimiters-depth-2">()</span>
  <span class="org-rainbow-delimiters-depth-2">(</span>split-string <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-keyword">or</span> <span class="org-rainbow-delimiters-depth-4">(</span>org-roam-get-keyword <span class="org-string">"filetags"</span><span class="org-rainbow-delimiters-depth-4">)</span> <span class="org-string">""</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defun</span> <span class="org-function-name">roam-extra:add-filetag</span> <span class="org-rainbow-delimiters-depth-2">(</span>tag<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">let*</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-rainbow-delimiters-depth-4">(</span>new-tags <span class="org-rainbow-delimiters-depth-5">(</span>cons tag <span class="org-rainbow-delimiters-depth-6">(</span>roam-extra:get-filetags<span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span>
         <span class="org-rainbow-delimiters-depth-4">(</span>new-tags-str <span class="org-rainbow-delimiters-depth-5">(</span>combine-and-quote-strings new-tags<span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>
    <span class="org-rainbow-delimiters-depth-3">(</span>org-roam-set-keyword <span class="org-string">"filetags"</span> new-tags-str<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defun</span> <span class="org-function-name">roam-extra:del-filetag</span> <span class="org-rainbow-delimiters-depth-2">(</span>tag<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">let*</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-rainbow-delimiters-depth-4">(</span>new-tags <span class="org-rainbow-delimiters-depth-5">(</span>seq-difference <span class="org-rainbow-delimiters-depth-6">(</span>roam-extra:get-filetags<span class="org-rainbow-delimiters-depth-6">)</span> `<span class="org-rainbow-delimiters-depth-6">(</span>,tag<span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span>
         <span class="org-rainbow-delimiters-depth-4">(</span>new-tags-str <span class="org-rainbow-delimiters-depth-5">(</span>combine-and-quote-strings new-tags<span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>
    <span class="org-rainbow-delimiters-depth-3">(</span>org-roam-set-keyword <span class="org-string">"filetags"</span> new-tags-str<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc4e90df" class="outline-2">
<h2 id="orgc4e90df">The layer</h2>
<div class="outline-text-2" id="text-orgc4e90df">
<p>
<code>roam-extra:todo-p</code> needed no changes at all. I'm including it here only for
easy reference.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defun</span> <span class="org-function-name">roam-extra:todo-p</span> <span class="org-rainbow-delimiters-depth-2">()</span>
  <span class="org-doc">"Return non-nil if current buffer has any </span><span class="org-doc"><span class="custom">TODO</span></span><span class="org-doc"> entry.</span>

<span class="org-doc"><span class="custom">TODO</span></span><span class="org-doc"> entries marked as done are ignored, meaning the this</span>
<span class="org-doc">function returns nil if current buffer contains only completed</span>
<span class="org-doc">tasks."</span>
  <span class="org-rainbow-delimiters-depth-2">(</span>org-element-map
      <span class="org-rainbow-delimiters-depth-3">(</span>org-element-parse-buffer 'headline<span class="org-rainbow-delimiters-depth-3">)</span>
      'headline
    <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-keyword">lambda</span> <span class="org-rainbow-delimiters-depth-4">(</span>h<span class="org-rainbow-delimiters-depth-4">)</span>
      <span class="org-rainbow-delimiters-depth-4">(</span>eq <span class="org-rainbow-delimiters-depth-5">(</span>org-element-property <span class="org-builtin">:todo-type</span> h<span class="org-rainbow-delimiters-depth-5">)</span>
          'todo<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>
    nil 'first-match<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<p>
As pretty much all functions I used in the old version of
<code>roam-extra:update-todo-tag</code> are gone I took the opportunity to rework it
completely. I think it ended up being slightly simpler. I suspect the the use of
<code>org-with-point-at 1 ...</code> is unnecessary, but I haven't tested it yet so I'm
leaving it in for now.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defun</span> <span class="org-function-name">roam-extra:update-todo-tag</span> <span class="org-rainbow-delimiters-depth-2">()</span>
  <span class="org-doc">"Update </span><span class="org-doc"><span class="custom">TODO</span></span><span class="org-doc"> tag in the current buffer."</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">when</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-keyword">and</span> <span class="org-rainbow-delimiters-depth-4">(</span>not <span class="org-rainbow-delimiters-depth-5">(</span>active-minibuffer-window<span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span>
             <span class="org-rainbow-delimiters-depth-4">(</span>org-roam-file-p<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>
    <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-keyword">org-with-point-at</span> <span class="org-highlight-numbers-number">1</span>
      <span class="org-rainbow-delimiters-depth-4">(</span><span class="org-keyword">let*</span> <span class="org-rainbow-delimiters-depth-5">(</span><span class="org-rainbow-delimiters-depth-6">(</span>tags <span class="org-rainbow-delimiters-depth-7">(</span>roam-extra:get-filetags<span class="org-rainbow-delimiters-depth-7">)</span><span class="org-rainbow-delimiters-depth-6">)</span>
             <span class="org-rainbow-delimiters-depth-6">(</span>is-todo <span class="org-rainbow-delimiters-depth-7">(</span>roam-extra:todo-p<span class="org-rainbow-delimiters-depth-7">)</span><span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span>
        <span class="org-rainbow-delimiters-depth-5">(</span><span class="org-keyword">cond</span> <span class="org-rainbow-delimiters-depth-6">(</span><span class="org-rainbow-delimiters-depth-7">(</span><span class="org-keyword">and</span> is-todo <span class="org-rainbow-delimiters-depth-8">(</span>not <span class="org-rainbow-delimiters-depth-9">(</span>seq-contains-p tags <span class="org-string">"</span><span class="org-string"><span class="custom">todo</span></span><span class="org-string">"</span><span class="org-rainbow-delimiters-depth-9">)</span><span class="org-rainbow-delimiters-depth-8">)</span><span class="org-rainbow-delimiters-depth-7">)</span>
               <span class="org-rainbow-delimiters-depth-7">(</span>roam-extra:add-filetag <span class="org-string">"</span><span class="org-string"><span class="custom">todo</span></span><span class="org-string">"</span><span class="org-rainbow-delimiters-depth-7">)</span><span class="org-rainbow-delimiters-depth-6">)</span>
              <span class="org-rainbow-delimiters-depth-6">(</span><span class="org-rainbow-delimiters-depth-7">(</span><span class="org-keyword">and</span> <span class="org-rainbow-delimiters-depth-8">(</span>not is-todo<span class="org-rainbow-delimiters-depth-8">)</span> <span class="org-rainbow-delimiters-depth-8">(</span>seq-contains-p tags <span class="org-string">"</span><span class="org-string"><span class="custom">todo</span></span><span class="org-string">"</span><span class="org-rainbow-delimiters-depth-8">)</span><span class="org-rainbow-delimiters-depth-7">)</span>
               <span class="org-rainbow-delimiters-depth-7">(</span>roam-extra:del-filetag <span class="org-string">"</span><span class="org-string"><span class="custom">todo</span></span><span class="org-string">"</span><span class="org-rainbow-delimiters-depth-7">)</span><span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<p>
In the previous version <code>roam-extra:todo-files</code> was built using an SQL query.
That felt a little brittle to me, so despite that my <a href="https://d12frosted.io/posts/2021-01-16-task-management-with-roam-vol5.html">original inspiration</a>
contains an updated SQL query I decided to go the route of using the org-roam
API instead. The function <code>org-roam-node-list</code> makes it easy to get all nodes
and then finding the files is just a matter of using <code>seq-filter</code> and <code>seq-map</code>.
Now that headings may be nodes, and that heading-based nodes seem to inherit the
top-level tags, a file may appear more than once, hence the call to <code>seq-unique</code>
at the end.
</p>

<p>
Based on what I've seen V2 appears less eager to sync the DB, so to make sure
all nodes are up-to-date it's best to start off with forcing a sync.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defun</span> <span class="org-function-name">roam-extra:todo-files</span> <span class="org-rainbow-delimiters-depth-2">()</span>
  <span class="org-doc">"Return a list of roam files containing </span><span class="org-doc"><span class="custom">todo</span></span><span class="org-doc"> tag."</span>
  <span class="org-rainbow-delimiters-depth-2">(</span>org-roam-db-sync<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">let</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-rainbow-delimiters-depth-4">(</span>todo-nodes <span class="org-rainbow-delimiters-depth-5">(</span>seq-filter <span class="org-rainbow-delimiters-depth-6">(</span><span class="org-keyword">lambda</span> <span class="org-rainbow-delimiters-depth-7">(</span>n<span class="org-rainbow-delimiters-depth-7">)</span>
                                  <span class="org-rainbow-delimiters-depth-7">(</span>seq-contains-p <span class="org-rainbow-delimiters-depth-8">(</span>org-roam-node-tags n<span class="org-rainbow-delimiters-depth-8">)</span> <span class="org-string">"</span><span class="org-string"><span class="custom">todo</span></span><span class="org-string">"</span><span class="org-rainbow-delimiters-depth-7">)</span><span class="org-rainbow-delimiters-depth-6">)</span>
                                 <span class="org-rainbow-delimiters-depth-6">(</span>org-roam-node-list<span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>
    <span class="org-rainbow-delimiters-depth-3">(</span>seq-uniq <span class="org-rainbow-delimiters-depth-4">(</span>seq-map #'org-roam-node-file todo-nodes<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<p>
With that in place it turns out that also <code>roam-extra:update-todo-files</code> worked
without any changes. I'm including it here for easy reference as well.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defun</span> <span class="org-function-name">roam-extra:update-todo-files</span> <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">&amp;rest</span> _<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-doc">"Update the value of `</span><span class="org-doc"><span class="org-constant">org-agenda-files</span></span><span class="org-doc">'."</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">setq</span> org-agenda-files <span class="org-rainbow-delimiters-depth-3">(</span>roam-extra:todo-files<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org317e364" class="outline-2">
<h2 id="org317e364">Hooking it up</h2>
<div class="outline-text-2" id="text-org317e364">
<p>
The variable <code>org-roam-file-setup-hook</code> is gone, so the the more general
<code>find-file-hook</code> will have to be used instead.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span>add-hook 'find-file-hook #'roam-extra:update-todo-tag<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span>add-hook 'before-save-hook #'roam-extra:update-todo-tag<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span>advice-add 'org-agenda <span class="org-builtin">:before</span> #'roam-extra:update-todo-files<span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>
</div>
</div>
<div class="taglist"><a href="https://magnus.therning.org/tags.html">Tags</a>: <a href="https://magnus.therning.org/tag-emacs.html">emacs</a> <a href="https://magnus.therning.org/tag-org-mode.html">org-mode</a> <a href="https://magnus.therning.org/tag-org-roam.html">org-roam</a> <a href="https://magnus.therning.org/tag-spacemacs.html">spacemacs</a> </div>
<div class="post-date">21 Mar 2021</div><h1 class="post-title"><a href="https://magnus.therning.org/2021-03-21-todo-items-in-org-roam,-an-update.html">Todo items in org-roam, an update</a></h1>
<p>
I got an email from Mr Z with a nice modification to the code in my post on
<a href="2021-03-14-keeping-todo-items-in-org-roam.html">keeping todo items in org-roam</a>.
</p>

<p>
He already had a bunch of agenda files that he wanted to keep using (I had so
few of them that I'd simply converted them to roam files). Here's the solution
he shared with me:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defvar</span> <span class="org-variable-name">roam-extra-original-org-agenda-files</span> nil
  <span class="org-doc">"Original value of  `</span><span class="org-doc"><span class="org-constant">org-agenda-files</span></span><span class="org-doc">'."</span><span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defun</span> <span class="org-function-name">roam-extra:update-todo-files</span> <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">&amp;rest</span> _<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-doc">"Update the value of `</span><span class="org-doc"><span class="org-constant">org-agenda-files</span></span><span class="org-doc">'."</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">unless</span> roam-extra-original-org-agenda-files
    <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-keyword">setq</span> roam-extra-original-org-agenda-files org-agenda-files<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">setq</span> org-agenda-files
        <span class="org-rainbow-delimiters-depth-3">(</span>append roam-extra-original-org-agenda-files
                <span class="org-rainbow-delimiters-depth-4">(</span>roam-extra:todo-files<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<p>
It's a rather nice modification I think. Thanks to Mr Z for agreeing to let me
share it here.
</p>
<div class="taglist"><a href="https://magnus.therning.org/tags.html">Tags</a>: <a href="https://magnus.therning.org/tag-emacs.html">emacs</a> <a href="https://magnus.therning.org/tag-org-mode.html">org-mode</a> <a href="https://magnus.therning.org/tag-org-roam.html">org-roam</a> </div>
<div class="post-date">14 Mar 2021</div><h1 class="post-title"><a href="https://magnus.therning.org/2021-03-14-keeping-todo-items-in-org-roam.html">Keeping todo items in org-roam</a></h1>
<p>
A while ago I made an attempt to improve my work habits by keeping a document
with TODO items. It lasted only for a while, and I've since had the intention to
make another attempt. Since then I've started using <a href="https://github.com/org-roam/org-roam">org-roam</a> and I've managed to
create a habit of writing daily journal notes using <a href="https://www.orgroam.com/manual.html#Daily_002dnotes">org-roam's daily-notes</a>. A
few times I've thought that it might fit me well to put TODO items in the notes,
but that would mean that I'd have to somehow keep track of them. At first I
manually added a tag to each journal fily containing a TODO item. That didn't
work very well at all, which should have been obvious up front. Then I added the
folders where I keep roam files and journals to <code>org-agenda-files</code>, that worked
a lot better. I'd still be using that, even if I expected it to slow down
considerably as the number of files grow, but then I found a post on <a href="https://d12frosted.io/posts/2021-01-16-task-management-with-roam-vol5.html">dynamic and
fast agenda with org-roam</a>.
</p>

<p>
I adjusted it slightly to fit my own setup a bit better, i.e. I made a Spacemacs
layer, <code>roam-extra</code>, I use the tag <code>todo</code>, and I use a different hook to get the
tag added on opening an org-roam file.
</p>

<p>
The layer consists of a single file, <code>layers/roam-extra/funcs.el</code>. In it I
define 4 functions (they are pretty much copies of the functions in the post
linked above):
</p>

<ol class="org-ol">
<li><code>roam-extra:todo-p</code> - returns non-<code>nil</code> if the current current buffer contains
a TODO item.</li>
<li><code>roam-extra:update-todo-tag</code> - updates the tags of the current buffer to
reflect the presence of TODO items, i.e. ensure the the tag <code>todo</code> is present
iff there's a TODO item.</li>
<li><code>roam-extra:todo-files</code> - uses the org-roam DB to return a list of all files
containing the tag <code>todo</code>.</li>
<li><code>roam-extra:update-todo-files</code> - adjusts <code>'org-agenda-files</code> to contain only
the files with TODO items.</li>
</ol>

<p>
I've put the full contents of the file at the <a href="#org6641697">end of the post</a>.
</p>

<p>
To ensure that the <code>todo</code> tag is correct in all org-mode files I've added
<code>roam-extra:update-todo-tag</code> to hooks that are invoked on opening an org-ram
file and when saving a file. (I would love to find a more specialise hook than
<code>before-save-hook</code>, but it works for now.)
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span>add-hook 'org-roam-file-setup-hook #'roam-extra:update-todo-tag<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span>add-hook 'before-save-hook #'roam-extra:update-todo-tag<span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<p>
To ensure that the list of files with TODO items is kept up to date when I open
I also wrap <code>org-agenda</code> in an advice so <code>roam-extra:update-todo-files</code> is
called prior to the agenda being opened.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span>advice-add 'org-agenda <span class="org-builtin">:before</span> #'roam-extra:update-todo-files<span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<div id="outline-container-org6641697" class="outline-2">
<h2 id="org6641697">The layer, <code>layers/roam-extra/funcs.el</code></h2>
<div class="outline-text-2" id="text-org6641697">
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defun</span> <span class="org-function-name">roam-extra:todo-p</span> <span class="org-rainbow-delimiters-depth-2">()</span>
  <span class="org-doc">"Return non-nil if current buffer has any </span><span class="custom">TODO</span><span class="org-doc"> entry.</span>

<span class="custom">TODO</span><span class="org-doc"> entries marked as done are ignored, meaning the this</span>
<span class="org-doc">function returns nil if current buffer contains only completed</span>
<span class="org-doc">tasks."</span>
  <span class="org-rainbow-delimiters-depth-2">(</span>org-element-map
      <span class="org-rainbow-delimiters-depth-3">(</span>org-element-parse-buffer 'headline<span class="org-rainbow-delimiters-depth-3">)</span>
      'headline
    <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-keyword">lambda</span> <span class="org-rainbow-delimiters-depth-4">(</span>h<span class="org-rainbow-delimiters-depth-4">)</span>
      <span class="org-rainbow-delimiters-depth-4">(</span>eq <span class="org-rainbow-delimiters-depth-5">(</span>org-element-property <span class="org-builtin">:todo-type</span> h<span class="org-rainbow-delimiters-depth-5">)</span>
          'todo<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>
    nil 'first-match<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defun</span> <span class="org-function-name">roam-extra:update-todo-tag</span> <span class="org-rainbow-delimiters-depth-2">()</span>
  <span class="org-doc">"Update </span><span class="custom">TODO</span><span class="org-doc"> tag in the current buffer."</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">when</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-keyword">and</span> <span class="org-rainbow-delimiters-depth-4">(</span>not <span class="org-rainbow-delimiters-depth-5">(</span>active-minibuffer-window<span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span>
             <span class="org-rainbow-delimiters-depth-4">(</span>org-roam--org-file-p buffer-file-name<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>
    <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-keyword">let*</span> <span class="org-rainbow-delimiters-depth-4">(</span><span class="org-rainbow-delimiters-depth-5">(</span>file <span class="org-rainbow-delimiters-depth-6">(</span>buffer-file-name <span class="org-rainbow-delimiters-depth-7">(</span>buffer-base-buffer<span class="org-rainbow-delimiters-depth-7">)</span><span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span>
           <span class="org-rainbow-delimiters-depth-5">(</span>all-tags <span class="org-rainbow-delimiters-depth-6">(</span>org-roam--extract-tags file<span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span>
           <span class="org-rainbow-delimiters-depth-5">(</span>prop-tags <span class="org-rainbow-delimiters-depth-6">(</span>org-roam--extract-tags-prop file<span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span>
           <span class="org-rainbow-delimiters-depth-5">(</span>tags prop-tags<span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span>
      <span class="org-rainbow-delimiters-depth-4">(</span><span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-5">(</span>roam-extra:todo-p<span class="org-rainbow-delimiters-depth-5">)</span>
          <span class="org-rainbow-delimiters-depth-5">(</span><span class="org-keyword">setq</span> tags <span class="org-rainbow-delimiters-depth-6">(</span>seq-uniq <span class="org-rainbow-delimiters-depth-7">(</span>cons <span class="org-string">"</span><span class="custom">todo</span><span class="org-string">"</span> tags<span class="org-rainbow-delimiters-depth-7">)</span><span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span>
        <span class="org-rainbow-delimiters-depth-5">(</span><span class="org-keyword">setq</span> tags <span class="org-rainbow-delimiters-depth-6">(</span>remove <span class="org-string">"</span><span class="custom">todo</span><span class="org-string">"</span> tags<span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span>
      <span class="org-rainbow-delimiters-depth-4">(</span><span class="org-keyword">unless</span> <span class="org-rainbow-delimiters-depth-5">(</span>equal prop-tags tags<span class="org-rainbow-delimiters-depth-5">)</span>
        <span class="org-rainbow-delimiters-depth-5">(</span>org-roam--set-global-prop
         <span class="org-string">"roam_tags"</span>
         <span class="org-rainbow-delimiters-depth-6">(</span>combine-and-quote-strings tags<span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defun</span> <span class="org-function-name">roam-extra:todo-files</span> <span class="org-rainbow-delimiters-depth-2">()</span>
  <span class="org-doc">"Return a list of note files containing </span><span class="custom">todo</span><span class="org-doc"> tag."</span>
  <span class="org-rainbow-delimiters-depth-2">(</span>seq-map
   #'car
   <span class="org-rainbow-delimiters-depth-3">(</span>org-roam-db-query
    <span class="org-rainbow-delimiters-depth-4">[</span><span class="org-builtin">:select</span> file
             <span class="org-builtin">:from</span> tags
             <span class="org-builtin">:where</span> <span class="org-rainbow-delimiters-depth-5">(</span>like tags <span class="org-rainbow-delimiters-depth-6">(</span><span class="org-keyword">quote</span> <span class="org-string">"%\"</span><span class="custom">todo</span><span class="org-string">\"%"</span><span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">]</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defun</span> <span class="org-function-name">roam-extra:update-todo-files</span> <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">&amp;rest</span> _<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-doc">"Update the value of `</span><span class="org-doc"><span class="org-constant">org-agenda-files</span></span><span class="org-doc">'."</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">setq</span> org-agenda-files <span class="org-rainbow-delimiters-depth-3">(</span>roam-extra:todo-files<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>
</div>
</div>
<div class="taglist"><a href="https://magnus.therning.org/tags.html">Tags</a>: <a href="https://magnus.therning.org/tag-emacs.html">emacs</a> <a href="https://magnus.therning.org/tag-org-mode.html">org-mode</a> <a href="https://magnus.therning.org/tag-org-roam.html">org-roam</a> <a href="https://magnus.therning.org/tag-spacemacs.html">spacemacs</a> </div>
<div class="post-date">05 Mar 2021</div><h1 class="post-title"><a href="https://magnus.therning.org/2021-03-05-000-flycheck-and-hls.html">Flycheck and HLS</a></h1>
<p>
I've been using LSP for most programming languages for a while now. HLS is
really very good now, but I've found that it doesn't warn on quite all things
I'd like it to so I find myself having to swap between the <code>'lsp</code> and
<code>'haskell-ghc</code> checkers. However, since <a href="https://www.flycheck.org/en/latest/">flycheck</a> supports chaining checkers I
thought there must be a way to have both checkers active at the same time.
</p>

<p>
The naive approach didn't work due to load order of things in Spacemacs so I had
to experiment a bit to find something that works.
</p>

<p>
The first issue was to make sure that HLS is available at all. I use <code>shell.nix</code>
together with <a href="https://direnv.net/">direnv</a> extensively and I had noticed that <code>lsp-mode</code> tried to load
HLS before <code>direnv</code> had put it in the <code>$PATH</code>. I think the
<code>'lsp-beforeinitialize-hook</code> is the hook to use for this:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span>add-hook 'lsp-before-initialize-hook #'direnv-update-environment<span class="org-rainbow-delimiters-depth-1">)</span><span class="org-rainbow-delimiters-unmatched">)</span>
</pre>
</div>

<p>
I made a several attempt to chain the checkers but kept on getting
errors due to the <code>'lsp</code> checker not being defined yet. Another problem
I ran into was that the checkers were chained too late, resulting in
having to manually run <code>flycheck-buffer</code> on the first file I opened.
(Deferred loading is a brilliant thing, but make some things really
difficult to debug.) After quite a bit of experimenting and reading the
description of various hooks I did find something that works:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">with-eval-after-load</span> 'lsp-mode
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">defun</span> <span class="org-function-name">magthe:lsp-next-checker</span> <span class="org-rainbow-delimiters-depth-3">()</span>
    <span class="org-rainbow-delimiters-depth-3">(</span>flycheck-add-next-checker 'lsp '<span class="org-rainbow-delimiters-depth-4">(</span>warning . haskell-ghc<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">(</span>add-hook 'lsp-lsp-haskell-after-open-hook
            #'magthe:lsp-next-checker<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<p>
Of course I have no idea if this is the easiest or most elegant solution but it
does work for my testcases:
</p>

<ol class="org-ol">
<li>Open a file in a project, <code>SPC p l</code> - choose project - choose a Haskell file.</li>
<li>Open a project, <code>SPC p l</code> followed by <code>C-d</code>, and then open a Haskell file.</li>
</ol>

<p>
Suggestions for improvements are more than welcome, of course.
</p>
<div class="taglist"><a href="https://magnus.therning.org/tags.html">Tags</a>: <a href="https://magnus.therning.org/tag-emacs.html">emacs</a> <a href="https://magnus.therning.org/tag-haskell.html">haskell</a> <a href="https://magnus.therning.org/tag-flycheck.html">flycheck</a> </div>
<div class="post-date">22 Jun 2020</div><h1 class="post-title"><a href="https://magnus.therning.org/2020-06-22-000-better-nix-setup-for-spacemacs.html">Better Nix setup for Spacemacs</a></h1>
<p>
In an <a href="2019-12-07-000-nix-setup-for-spacemacs.html">earlier post</a> I documented my setup for getting <a href="https://www.spacemacs.org/">Spacemacs</a>/Emacs to work
with <a href="https://nixos.org/nix/">Nix</a>. I've since found a much more elegant solution based on
</p>

<ul class="org-ul">
<li><a href="https://github.com/direnv/direnv/">direnv</a>, and</li>
<li><a href="https://github.com/wbolster/emacs-direnv">emacs-direnv</a></li>
</ul>

<p>
No more Emacs packages for Nix and no need to defining functions that wrap
executables in an invocation of <code>nix-shell</code>.
</p>

<p>
There's a nice bonus too, with this setup I don't need to run <code>nix-shell</code>, which
always drops me at a bash prompt, instead I get a working setup in my shell of
choice.
</p>

<div id="outline-container-orgd063368" class="outline-2">
<h2 id="orgd063368">Setting up <code>direnv</code></h2>
<div class="outline-text-2" id="text-orgd063368">
<p>
The steps for setting up <code>direnv</code> depends a bit on your setup, but luckily I
found the <a href="https://direnv.net/#basic-installation">official instructions for installing <code>direnv</code></a> to be very clear and
easy to follow. There's not much I can add to that.
</p>
</div>
</div>

<div id="outline-container-org9ce9cc2" class="outline-2">
<h2 id="org9ce9cc2">Setting up Spacemacs</h2>
<div class="outline-text-2" id="text-org9ce9cc2">
<p>
Since <code>emacs-direnv</code> isn't included by default in Spacemacs I needed to do a bit
of setup. I opted to create a layer for it, rather than just drop it in the list
<code>dotspacemacs-additional-packages</code>. Yes, a little more complicated, but not
difficult and I nurture an intention of submitting the layer for inclusion in
Spacemacs itself at some point. I'll see where that goes.
</p>

<p>
For now, I put the following in the file
<code>~/.emacs.d/private/layers/direnv/packages.el</code>:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defconst</span> <span class="org-variable-name">direnv-packages</span>
      '<span class="org-rainbow-delimiters-depth-2">(</span>direnv<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defun</span> <span class="org-function-name">direnv/init-direnv</span> <span class="org-rainbow-delimiters-depth-2">()</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">use-package</span> <span class="org-constant">direnv</span>
    <span class="org-builtin">:init</span>
    <span class="org-rainbow-delimiters-depth-3">(</span>direnv-mode<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org6002225" class="outline-2">
<h2 id="org6002225">Setting up the project folders</h2>
<div class="outline-text-2" id="text-org6002225">
<p>
In each project folder I then add the file <code>.envrc</code> containing a single line:
</p>

<div class="org-src-container">
<pre class="src src-shell">use_nix
</pre>
</div>

<p>
Then I either run <code>direnv allow</code> from the command line, or run the
function <code>direnv-allow</code> after opening the folder in Emacs.
</p>
</div>
</div>

<div id="outline-container-orgbcb33a0" class="outline-2">
<h2 id="orgbcb33a0">Using it</h2>
<div class="outline-text-2" id="text-orgbcb33a0">
<p>
It's as simple as moving into the folder in a shell &#x2013; all required envvars are
set up on entry and unset on exit.
</p>

<p>
In Emacs it's just as simple, just open a file in a project and the envvars are
set. When switching to a buffer outside the project the envvars are unset.
</p>

<p>
There is only one little caveat, <code>nix-build</code> doesn't work inside a Nix shell. I
found out that running
</p>

<div class="org-src-container">
<pre class="src src-shell"><span class="org-variable-name">IN_NIX_SHELL</span>= nix-build
</pre>
</div>

<p>
does work though.
</p>
</div>
</div>
<div class="taglist"><a href="https://magnus.therning.org/tags.html">Tags</a>: <a href="https://magnus.therning.org/tag-emacs.html">emacs</a> <a href="https://magnus.therning.org/tag-nix.html">nix</a> <a href="https://magnus.therning.org/tag-spacemacs.html">spacemacs</a> </div>
<div class="post-date">07 Dec 2019</div><h1 class="post-title"><a href="https://magnus.therning.org/2019-12-07-000-nix-setup-for-spacemacs.html">Nix setup for Spacemacs</a></h1>
<p>
<i>Edit 2020-06-22: I've since found a <a href="2020-06-22-000-better-nix-setup-for-spacemacs.html">better setup for this</a>.</i>
</p>

<p>
When using <code>ghcide</code> and LSP, as I wrote about in my post on <a href="2019-09-19-000-haskell--ghcide--and-spacemacs.html">Haskell, ghcide, and
Spacemacs</a>, I found myself ending up recompiling a little too often. This pushed
me to finally start looking at <a href="https://nixos.org/nix/">Nix</a>. After a bit of a fight I managed to
<a href="https://discourse.nixos.org/t/import-and-use-ghide-nix">get ghcide from Nix</a>,
which brought me the issue of setting up Spacemacs. Inspired by <a href="https://gist.github.com/sevanspowell/23b0135dae2834e59904a502b8a0eb5d">a gist from
Samuel Evans-Powell</a> and a guide to <a href="https://github.com/thalesmg/reflex-skeleton/blob/master/Readme.org#setting-up-editor-integration-with-emacs">setting up an environment for Reflex by
Thales Macedo Garitezi</a> I ended up with the following setup:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defun</span> <span class="org-function-name">dotspacemacs/layers</span> <span class="org-rainbow-delimiters-depth-2">()</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">setq-default</span>
   ...
   dotspacemacs-additional-packages
   '<span class="org-rainbow-delimiters-depth-3">(</span>
     nix-sandbox
     nix-haskell-mode
     ...
     <span class="org-rainbow-delimiters-depth-3">)</span>
   ...
   <span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defun</span> <span class="org-function-name">dotspacemacs/user-config</span> <span class="org-rainbow-delimiters-depth-2">()</span>
  ...
  <span class="org-rainbow-delimiters-depth-2">(</span>add-hook 'haskell-mode-hook #'lsp<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">(</span>add-hook 'haskell-mode-hook 'nix-haskell-mode<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">(</span>add-hook 'haskell-mode-hook
            <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-keyword">lambda</span> <span class="org-rainbow-delimiters-depth-4">()</span>
              <span class="org-rainbow-delimiters-depth-4">(</span><span class="org-keyword">setq-local</span> flycheck-executable-find
                          <span class="org-rainbow-delimiters-depth-5">(</span><span class="org-keyword">lambda</span> <span class="org-rainbow-delimiters-depth-6">(</span>cmd<span class="org-rainbow-delimiters-depth-6">)</span>
                            <span class="org-rainbow-delimiters-depth-6">(</span>nix-executable-find <span class="org-rainbow-delimiters-depth-7">(</span>nix-current-sandbox<span class="org-rainbow-delimiters-depth-7">)</span> cmd<span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span>
              <span class="org-rainbow-delimiters-depth-4">(</span><span class="org-keyword">setq-local</span> flycheck-command-wrapper-function
                          <span class="org-rainbow-delimiters-depth-5">(</span><span class="org-keyword">lambda</span> <span class="org-rainbow-delimiters-depth-6">(</span>argv<span class="org-rainbow-delimiters-depth-6">)</span>
                            <span class="org-rainbow-delimiters-depth-6">(</span>apply 'nix-shell-command <span class="org-rainbow-delimiters-depth-7">(</span>nix-current-sandbox<span class="org-rainbow-delimiters-depth-7">)</span> argv<span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span>
              <span class="org-rainbow-delimiters-depth-4">(</span><span class="org-keyword">setq-local</span> haskell-process-wrapper-function
                          <span class="org-rainbow-delimiters-depth-5">(</span><span class="org-keyword">lambda</span> <span class="org-rainbow-delimiters-depth-6">(</span>argv<span class="org-rainbow-delimiters-depth-6">)</span>
                            <span class="org-rainbow-delimiters-depth-6">(</span>apply 'nix-shell-command <span class="org-rainbow-delimiters-depth-7">(</span>nix-current-sandbox<span class="org-rainbow-delimiters-depth-7">)</span> argv<span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span>
              <span class="org-rainbow-delimiters-depth-4">(</span><span class="org-keyword">setq-local</span> lsp-haskell-process-wrapper-function
                          <span class="org-rainbow-delimiters-depth-5">(</span><span class="org-keyword">lambda</span> <span class="org-rainbow-delimiters-depth-6">(</span>argv<span class="org-rainbow-delimiters-depth-6">)</span>
                            `<span class="org-rainbow-delimiters-depth-6">(</span><span class="org-string">"nix-shell"</span> <span class="org-string">"-I"</span> <span class="org-string">"."</span> <span class="org-string">"--command"</span> <span class="org-string">"ghcide --lsp"</span> ,<span class="org-rainbow-delimiters-depth-7">(</span>nix-current-sandbox<span class="org-rainbow-delimiters-depth-7">)</span><span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">(</span>add-hook 'haskell-mode-hook
            <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-keyword">lambda</span> <span class="org-rainbow-delimiters-depth-4">()</span>
              <span class="org-rainbow-delimiters-depth-4">(</span>flycheck-add-next-checker 'lsp-ui '<span class="org-rainbow-delimiters-depth-5">(</span>warning . haskell-stack-ghc<span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>
  ...
  <span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<p>
It seems to work, but please let me know if you have suggestions for
improvements.
</p>
<div class="taglist"><a href="https://magnus.therning.org/tags.html">Tags</a>: <a href="https://magnus.therning.org/tag-emacs.html">emacs</a> <a href="https://magnus.therning.org/tag-nix.html">nix</a> <a href="https://magnus.therning.org/tag-spacemacs.html">spacemacs</a> </div>
<div class="post-date">05 Nov 2019</div><h1 class="post-title"><a href="https://magnus.therning.org/2019-11-05-000-populating-projectile-s-cache.html">Populating Projectile's cache</a></h1>
<p>
As I track the <i>develop</i> branch of <a href="https://github.com/syl20bnr/spacemacs/">Spacemacs</a> I occasionally clean out my cache
of projects known to Projectile. Every time it takes a while before I'm back at
a stage where I very rarely have to visit something that isn't already in the
cache.
</p>

<p>
However, today I found the function <code>projectile-add-known-project</code>, which
prompted me to write the following function that'll help me quickly re-building
the cache the next time I need to reset Spacemacs to a known state again.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defun</span> <span class="org-function-name">projectile-extra-add-projects-in-subfolders</span> <span class="org-rainbow-delimiters-depth-2">(</span>projects-root<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">interactive</span> <span class="org-rainbow-delimiters-depth-3">(</span>list <span class="org-rainbow-delimiters-depth-4">(</span>read-directory-name <span class="org-string">"Add to known projects: "</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">(</span>message <span class="org-string">"Searching for projects in %s..."</span> projects-root<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">let</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-rainbow-delimiters-depth-4">(</span>dirs <span class="org-rainbow-delimiters-depth-5">(</span>seq-map 'file-name-directory <span class="org-rainbow-delimiters-depth-6">(</span>directory-files-recursively projects-root <span class="org-string">"^.git$"</span> t<span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>
    <span class="org-rainbow-delimiters-depth-3">(</span>seq-do 'projectile-add-known-project dirs<span class="org-rainbow-delimiters-depth-3">)</span>
    <span class="org-rainbow-delimiters-depth-3">(</span>message <span class="org-string">"Added %d projects"</span> <span class="org-rainbow-delimiters-depth-4">(</span>length dirs<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>
<div class="taglist"><a href="https://magnus.therning.org/tags.html">Tags</a>: <a href="https://magnus.therning.org/tag-emacs.html">emacs</a> <a href="https://magnus.therning.org/tag-elisp.html">elisp</a> <a href="https://magnus.therning.org/tag-projectile.html">projectile</a> </div>
<div class="post-date">20 Oct 2019</div><h1 class="post-title"><a href="https://magnus.therning.org/2019-10-20-000-ditaa-in-org-mode.html">Ditaa in Org mode</a></h1>
<p>
Just found out that Emacs ships with Babel support for <a href="https://writequit.org/denver-emacs/presentations/2016-04-19-whats-new-emacs25-ditaa-artist.html#orgheadline15">ditaa</a> (yes, I'm late to
the party).
</p>

<p>
Sweet! That is yet another argument for converting all our <code>README.md</code> into
<code>README.org</code> at work.
</p>

<p>
<img src="https://media.giphy.com/media/xl5QdxfNonh3q/giphy.gif" alt="giphy.gif">\
</p>

<p>
The changes I made to my Spacemacs config are
</p>

<div class="org-src-container">
<pre class="src src-lisp"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defun</span> <span class="org-function-name">dotspacemacs/user-config</span> <span class="org-rainbow-delimiters-depth-2">()</span>
  ...
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">with-eval-after-load</span> 'org
    ...
    <span class="org-rainbow-delimiters-depth-3">(</span>add-to-list 'org-babel-load-languages '<span class="org-rainbow-delimiters-depth-4">(</span>ditaa . t<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>
    <span class="org-rainbow-delimiters-depth-3">(</span>setq org-ditaa-jar-path <span class="org-string">"/usr/share/java/ditaa/ditaa-0.11.jar"</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>
  ...<span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>
<div class="taglist"><a href="https://magnus.therning.org/tags.html">Tags</a>: <a href="https://magnus.therning.org/tag-emacs.html">emacs</a> <a href="https://magnus.therning.org/tag-org-mode.html">org-mode</a> </div>
<div class="post-date">19 Sep 2019</div><h1 class="post-title"><a href="https://magnus.therning.org/2019-09-19-000-haskell--ghcide--and-spacemacs.html">Haskell, ghcide, and Spacemacs</a></h1>
<p>
The other day I read Chris Penner's post on <a href="https://chrispenner.ca/posts/hie-core">Haskell IDE Support</a> and thought I'd
make an attempt to use it with Spacemacs.
</p>

<p>
After running <code>stack build hie-bios ghcide haskell-lsp --copy-compiler-tool</code> I
had a look at the <a href="https://github.com/haskell/haskell-ide-engine#using-hie-with-spacemacs">instructions on using <code>haskell-ide-engine</code> with Spacemacs</a>.
After a bit of trial and error I came up with these changes to my
<code>~/.spacemacs</code>:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defun</span> <span class="org-function-name">dotspacemacs/layers</span> <span class="org-rainbow-delimiters-depth-2">()</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">setq-default</span>
   dotspacemacs-configuration-layers
   '<span class="org-rainbow-delimiters-depth-3">(</span>
    ...
    lsp
    <span class="org-rainbow-delimiters-depth-4">(</span>haskell <span class="org-builtin">:variables</span>
             haskell-completion-backend 'lsp
             <span class="org-rainbow-delimiters-depth-4">)</span>
    ...<span class="org-rainbow-delimiters-depth-3">)</span>
  <span class="org-rainbow-delimiters-depth-2">)</span>
<span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defun</span> <span class="org-function-name">dotspacemacs/user-config</span> <span class="org-rainbow-delimiters-depth-2">()</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">setq</span> lsp-haskell-process-args-hie '<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"exec"</span> <span class="org-string">"ghcide"</span> <span class="org-string">"--"</span> <span class="org-string">"--lsp"</span><span class="org-rainbow-delimiters-depth-3">)</span>
        lsp-haskell-process-path-hie <span class="org-string">"stack"</span>
        lsp-haskell-process-wrapper-function <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-keyword">lambda</span> <span class="org-rainbow-delimiters-depth-4">(</span>argv<span class="org-rainbow-delimiters-depth-4">)</span> <span class="org-rainbow-delimiters-depth-4">(</span>cons <span class="org-rainbow-delimiters-depth-5">(</span>car argv<span class="org-rainbow-delimiters-depth-5">)</span> <span class="org-rainbow-delimiters-depth-5">(</span>cddr argv<span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">(</span>add-hook 'haskell-mode-hook
            #'lsp<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<p>
The slightly weird looking <code>lsp-haskell-process-wrapper-function</code> is removing
the pesky <code>--lsp</code> inserted by <a href="https://github.com/emacs-lsp/lsp-haskell/blob/64106be79350f9ce6903d22c66b29761dadb5001/lsp-haskell.el#L179">this line</a>.
</p>

<p>
That seems to work. Though I have to say I'm not ready to switch from <a href="https://hackage.haskell.org/package/intero">intero</a>
just yet. Two things in particular didn't work with =ghcide=/LSP:
</p>

<ol class="org-ol">
<li>Switching from one the <code>Main.hs</code> in one executable to the <code>Main.hs</code> of
another executable in the same project didn't work as expected &#x2013; I had hints
and types in the first, but nothing in the second.</li>
<li>Jump to the definition of a function defined in the package didn't work &#x2013;
I'm not willing to use <a href="https://www.gnu.org/software/global/">GNU GLOBAL</a> or some other source tagging system.</li>
</ol>
<div class="taglist"><a href="https://magnus.therning.org/tags.html">Tags</a>: <a href="https://magnus.therning.org/tag-emacs.html">emacs</a> <a href="https://magnus.therning.org/tag-haskell.html">haskell</a> <a href="https://magnus.therning.org/tag-lsp.html">lsp</a> <a href="https://magnus.therning.org/tag-spacemacs.html">spacemacs</a> </div>
<div class="post-date">07 May 2019</div><h1 class="post-title"><a href="https://magnus.therning.org/2019-05-07-000-some-orgmode-stuff.html">Some OrgMode stuff</a></h1>
<p>
The last few days I've watched <a href="https://www.youtube.com/user/koenighaunstetten">Rainer König's OrgMode videos</a>. It's resulted in a
few new settings that makes <a href="https://orgmode.org/">Org</a> a little more useful.
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Variable</th>
<th scope="col" class="org-left">Value</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>calendar-week-start-day</code></td>
<td class="org-left"><code>1</code></td>
<td class="org-left">Weeks start on Monday!</td>
</tr>

<tr>
<td class="org-left"><code>org-modules</code> (list)</td>
<td class="org-left"><code>org-habit</code></td>
<td class="org-left">Support for tracking habits</td>
</tr>

<tr>
<td class="org-left"><code>org-modules</code> (list)</td>
<td class="org-left"><code>org-id</code></td>
<td class="org-left">Improved support for <code>ID</code> property</td>
</tr>

<tr>
<td class="org-left"><code>org-agenda-start-on-weekday</code></td>
<td class="org-left"><code>1</code></td>
<td class="org-left">Weeks start on Monday, again!</td>
</tr>

<tr>
<td class="org-left"><code>org-log-into-drawer</code></td>
<td class="org-left"><code>t</code></td>
<td class="org-left">Put notes (logs) into a drawer</td>
</tr>

<tr>
<td class="org-left"><code>org-enforce-todo-checkbox-dependencies</code></td>
<td class="org-left"><code>t</code></td>
<td class="org-left">Checkboxes must be checked before a <i>TODO</i> can become <i>DONE</i></td>
</tr>

<tr>
<td class="org-left"><code>org-id-link-to-org-use-id</code></td>
<td class="org-left"><code>t</code></td>
<td class="org-left">Prefer use of <code>ID</code> property for links</td>
</tr>
</tbody>
</table>
<div class="taglist"><a href="https://magnus.therning.org/tags.html">Tags</a>: <a href="https://magnus.therning.org/tag-emacs.html">emacs</a> <a href="https://magnus.therning.org/tag-org-mode.html">org-mode</a> </div>
<div class="post-date">16 Mar 2019</div><h1 class="post-title"><a href="https://magnus.therning.org/2019-03-16-000-til--prompt-matters-to-org-mode.html">TIL: prompt matters to org-mode</a></h1>
<p>
A workmate just embellished some shell code blocks I'd put in a shared <a href="https://orgmode.org/">org-mode</a>
file with <code>:session s</code>. When I tried to run the blocks with sessions my emacs
just froze up though. I found a <a href="https://emacs.stackexchange.com/questions/19735/emacs-freezes-with-any-org-babel-snippet-using-session">post on the emacs StackExchange</a> that offered a
possible cause for it: the prompt.
</p>

<p>
I'm using <a href="https://github.com/Bash-it/bash-it">bash-it</a> so my prompt is rather far from the default.
</p>

<p>
After inspecting the session buffer simply added the following to my <code>~/.bashrc</code>
</p>

<div class="org-src-container">
<pre class="src src-shell"><span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-1">[</span><span class="org-rainbow-delimiters-depth-2">[</span> $<span class="org-rainbow-delimiters-depth-3">{</span><span class="org-variable-name">TERM</span><span class="org-rainbow-delimiters-depth-3">}</span> == <span class="org-string">"dumb"</span> <span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">]</span>; <span class="org-keyword">then</span>
    <span class="org-builtin">export</span> <span class="org-variable-name">BASH_IT_THEME</span>=<span class="org-string">'standard'</span>
<span class="org-keyword">else</span>
    <span class="org-builtin">export</span> <span class="org-variable-name">BASH_IT_THEME</span>=<span class="org-string">'simple'</span>
<span class="org-keyword">fi</span>
</pre>
</div>

<p>
and now I can finally run shell code blocks in sessions.
</p>
<div class="taglist"><a href="https://magnus.therning.org/tags.html">Tags</a>: <a href="https://magnus.therning.org/tag-emacs.html">emacs</a> <a href="https://magnus.therning.org/tag-org-mode.html">org-mode</a> </div>
<div class="post-date">28 Jan 2019</div><h1 class="post-title"><a href="https://magnus.therning.org/2019-01-28-000-a-missing-piece-in-my-emacs-spacemacs-setup-for-haskell-development.html">A missing piece in my Emacs/Spacemacs setup for Haskell development</a></h1>
<p>
With the help of a work mate I've finally found this gem that's been missing
from my Spacemacs setup
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">with-eval-after-load</span> 'intero
  <span class="org-rainbow-delimiters-depth-2">(</span>flycheck-add-next-checker 'intero '<span class="org-rainbow-delimiters-depth-3">(</span>warning . haskell-hlint<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">(</span>flycheck-add-next-checker 'intero '<span class="org-rainbow-delimiters-depth-3">(</span>warning . haskell-stack-ghc<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>
<div class="taglist"><a href="https://magnus.therning.org/tags.html">Tags</a>: <a href="https://magnus.therning.org/tag-haskell.html">haskell</a> <a href="https://magnus.therning.org/tag-emacs.html">emacs</a> <a href="https://magnus.therning.org/tag-spacemacs.html">spacemacs</a> </div>
<div class="post-date">14 Jul 2018</div><h1 class="post-title"><a href="https://magnus.therning.org/2018-07-14-000-quickcheck-on-a-rest-api.html">QuickCheck on a REST API</a></h1>
<p>
Since I'm working with web stuff nowadays I thought I'd play a little with
translating my old post on <a href="2015-06-15-000-using-quickcheck-to-test-c-apis.html">using QuickCheck to test C APIs</a> to the web.
</p>

<div id="outline-container-orgd2e8eeb" class="outline-2">
<h2 id="orgd2e8eeb">The goal and how to reach it</h2>
<div class="outline-text-2" id="text-orgd2e8eeb">
<p>
I want to use <a href="https://hackage.haskell.org/package/QuickCheck">QuickCheck</a> to test a REST API, just like in the case of the C API
the idea is to
</p>

<ol class="org-ol">
<li>generate a sequence of API calls (a <i>program</i>), then</li>
<li>run the sequence against a model, as well as</li>
<li>run the sequence against the web service, and finally</li>
<li>compare the resulting model against reality.</li>
</ol>
</div>
</div>

<div id="outline-container-org776189d" class="outline-2">
<h2 id="org776189d">The REST API</h2>
<div class="outline-text-2" id="text-org776189d">
<p>
I'll use a small web service I'm working on, and then concentrate on only a
small part of the API to begin with.
</p>

<p>
The parts of the API I'll use for the programs at this stage are
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Method</th>
<th scope="col" class="org-left">Route</th>
<th scope="col" class="org-left">Example in</th>
<th scope="col" class="org-left">Example out</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>POST</code></td>
<td class="org-left"><code>/users</code></td>
<td class="org-left"><code>{"userId": 0, "userName": "Yogi Berra"}</code></td>
<td class="org-left"><code>{"userId": 42, "userName": "Yogi Berra"}</code></td>
</tr>

<tr>
<td class="org-left"><code>DELETE</code></td>
<td class="org-left"><code>/users/:id</code></td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>

<p>
The following API calls will also be used, but not in the programs
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Method</th>
<th scope="col" class="org-left">Route</th>
<th scope="col" class="org-left">Example in</th>
<th scope="col" class="org-left">Example out</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>GET</code></td>
<td class="org-left"><code>/users</code></td>
<td class="org-left">&#xa0;</td>
<td class="org-left"><code>[0,3,7]</code></td>
</tr>

<tr>
<td class="org-left"><code>GET</code></td>
<td class="org-left"><code>/users/:id</code></td>
<td class="org-left">&#xa0;</td>
<td class="org-left"><code>{"userId": 42, "userName": "Yogi Berra"}</code></td>
</tr>

<tr>
<td class="org-left"><code>POST</code></td>
<td class="org-left"><code>/reset</code></td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-org45a80a7" class="outline-2">
<h2 id="org45a80a7">Representing API calls</h2>
<div class="outline-text-2" id="text-org45a80a7">
<p>
Given the information about the API above it seems the following is enough to
represent the two calls of interest together with a constructor representing the
end of a program
</p>

<div class="org-src-container">
<pre class="src src-haskell"><span class="org-haskell-keyword">data</span> <span class="org-haskell-type">ApiCall</span> <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">AddUser</span> <span class="org-haskell-constructor">Text</span>
             <span class="org-haskell-operator">|</span> <span class="org-haskell-constructor">DeleteUser</span> <span class="org-haskell-constructor">Int</span>
             <span class="org-haskell-operator">|</span> <span class="org-haskell-constructor">EndProgram</span>
             <span class="org-haskell-keyword">deriving</span> <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-haskell-constructor">Show</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<p>
and a program is just a sequence of calls, so list of <code>ApiCall</code> will do.
However, since I want to generate sequences of calls, i.e. implement
<code>Arbitrary</code>, I'll wrap it in a <code>newtype</code>
</p>

<div class="org-src-container">
<pre class="src src-haskell"><span class="org-haskell-keyword">newtype</span> <span class="org-haskell-type">Program</span> <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">Prog</span> <span class="org-rainbow-delimiters-depth-1">[</span><span class="org-haskell-constructor">ApiCall</span><span class="org-rainbow-delimiters-depth-1">]</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org8734229" class="outline-2">
<h2 id="org8734229">Running against a model (simulation)</h2>
<div class="outline-text-2" id="text-org8734229">
<p>
First of all I need to decide what model to use. Based on the part of the API
I'm using I'll use an ordinary dictionary of <code>Int</code> and <code>Text</code>
</p>

<div class="org-src-container">
<pre class="src src-haskell"><span class="org-haskell-keyword">type</span> <span class="org-haskell-type">Model</span> <span class="org-haskell-operator">=</span> <span class="org-haskell-type">M.Map</span> <span class="org-haskell-type">Int</span> <span class="org-haskell-type">Text</span>
</pre>
</div>

<p>
Simulating execution of a program is simulating each call against a
model that's updated with each step. I expect the final model to
correspond to the state of the real service after the program is run for
real. The simulation begins with an empty dictionary.
</p>

<div class="org-src-container">
<pre class="src src-haskell"><span class="org-haskell-definition">simulateProgram</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-type">Program</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-type">Model</span>
<span class="org-haskell-definition">simulateProgram</span> <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-haskell-constructor">Prog</span> cs<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-haskell-operator">=</span> foldl simulateCall M.empty cs
</pre>
</div>

<p>
The simulation of the API calls must then be a function taking a model and a
call, returning an updated model
</p>

<div class="org-src-container">
<pre class="src src-haskell"><span class="org-haskell-definition">simulateCall</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-type">Model</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-type">ApiCall</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-type">Model</span>
<span class="org-haskell-definition">simulateCall</span> m <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-haskell-constructor">AddUser</span> t<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-haskell-operator">=</span> M.insert k t m
  <span class="org-haskell-keyword">where</span>
    k <span class="org-haskell-operator">=</span> succ <span class="org-haskell-operator">$</span> foldl max <span class="org-highlight-numbers-number">0</span> <span class="org-rainbow-delimiters-depth-1">(</span>M.keys m<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-haskell-definition">simulateCall</span> m <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-haskell-constructor">DeleteUser</span> k<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-haskell-operator">=</span> M.delete k m
<span class="org-haskell-definition">simulateCall</span> m <span class="org-haskell-constructor">EndProgram</span> <span class="org-haskell-operator">=</span> m
</pre>
</div>

<p>
Here I have to make a few assumptions. First, I assume the indeces for the users
start on <code>1</code>. Second, that the next index used always is the successor of
highest currently used index. We'll see how well this holds up to reality later
on.
</p>
</div>
</div>

<div id="outline-container-org9c8cb3a" class="outline-2">
<h2 id="org9c8cb3a">Running against the web service</h2>
<div class="outline-text-2" id="text-org9c8cb3a">
<p>
Running the program against the actual web service follows the same pattern, but
here I'm dealing with the real world, so it's a little more messy, i.e. <code>IO</code> is
involved. First the running of a single call
</p>

<div class="org-src-container">
<pre class="src src-haskell"><span class="org-haskell-definition">runCall</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-type">Manager</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-type">ApiCall</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-type">IO</span> <span class="org-haskell-constructor"><span class="org-rainbow-delimiters-depth-1">()</span></span>
<span class="org-haskell-definition">runCall</span> mgr <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-haskell-constructor">AddUser</span> t<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-haskell-operator">=</span> <span class="org-haskell-keyword">do</span>
  ireq <span class="org-haskell-operator">&lt;-</span> parseRequest <span class="org-string">"POST http://localhost:3000/users"</span>
  <span class="org-haskell-keyword">let</span> req <span class="org-haskell-operator">=</span> ireq <span class="org-rainbow-delimiters-depth-1">{</span> requestBody <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">RequestBodyLBS</span> <span class="org-rainbow-delimiters-depth-2">(</span>encode <span class="org-haskell-operator">$</span> <span class="org-haskell-constructor">User</span> <span class="org-highlight-numbers-number">0</span> t<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">}</span>
  resp <span class="org-haskell-operator">&lt;-</span> httpLbs req mgr
  guard <span class="org-rainbow-delimiters-depth-1">(</span>status201 <span class="org-haskell-operator">==</span> responseStatus resp<span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-haskell-definition">runCall</span> mgr <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-haskell-constructor">DeleteUser</span> k<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-haskell-operator">=</span> <span class="org-haskell-keyword">do</span>
  req <span class="org-haskell-operator">&lt;-</span> parseRequest <span class="org-haskell-operator">$</span> <span class="org-string">"DELETE http://localhost:3000/users/"</span> <span class="org-haskell-operator">++</span> show k
  resp <span class="org-haskell-operator">&lt;-</span> httpNoBody req mgr
  guard <span class="org-rainbow-delimiters-depth-1">(</span>status200 <span class="org-haskell-operator">==</span> responseStatus resp<span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-haskell-definition">runCall</span> <span class="org-haskell-keyword">_</span> <span class="org-haskell-constructor">EndProgram</span> <span class="org-haskell-operator">=</span> return <span class="org-haskell-constructor"><span class="org-rainbow-delimiters-depth-1">()</span></span>
</pre>
</div>

<p>
The running of a program is slightly more involved. Of course I have to set up
the <code>Manager</code> needed for the HTTP calls, but I also need to
</p>

<ol class="org-ol">
<li>ensure that the web service is in a well-known state before starting, and</li>
<li>extract the state of the web service after running the program, so I can
compare it to the model</li>
</ol>

<div class="org-src-container">
<pre class="src src-haskell"><span class="org-haskell-definition">runProgram</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-type">Program</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-type">IO</span> <span class="org-haskell-type">Model</span>
<span class="org-haskell-definition">runProgram</span> <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-haskell-constructor">Prog</span> cs<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-haskell-operator">=</span> <span class="org-haskell-keyword">do</span>
  mgr <span class="org-haskell-operator">&lt;-</span> newManager defaultManagerSettings
  resetReq <span class="org-haskell-operator">&lt;-</span> parseRequest <span class="org-string">"POST http://localhost:3000/reset"</span>
  httpNoBody resetReq mgr
  mapM_ <span class="org-rainbow-delimiters-depth-1">(</span>runCall mgr<span class="org-rainbow-delimiters-depth-1">)</span> cs
  model <span class="org-haskell-operator">&lt;-</span> extractModel mgr
  return model
</pre>
</div>

<p>
The call to <code>POST /reset</code> resets the web service. I would have liked to simply
restart the service completely, but I failed in automating it. I think I'll have
to take a closer look at the implementation of <a href="http://hackage.haskell.org/package/scotty">scotty</a> to find a way.
</p>

<p>
Extracting the web service state and packaging it in a <code>Model</code> is a matter of
calling <code>GET /users</code> and then repeatedly calling <code>GET /users/:id</code> with each <code>id</code>
gotten from the first call
</p>

<div class="org-src-container">
<pre class="src src-haskell"><span class="org-haskell-definition">extractModel</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-type">Manager</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-type">IO</span> <span class="org-haskell-type">Model</span>
<span class="org-haskell-definition">extractModel</span> mgr <span class="org-haskell-operator">=</span> <span class="org-haskell-keyword">do</span>
  req <span class="org-haskell-operator">&lt;-</span> parseRequest <span class="org-string">"http://localhost:3000/users"</span>
  resp <span class="org-haskell-operator">&lt;-</span> httpLbs req mgr
  <span class="org-haskell-keyword">let</span> <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-haskell-constructor">Just</span> ids<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-haskell-operator">=</span> decode <span class="org-rainbow-delimiters-depth-1">(</span>responseBody resp<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-type">Maybe</span> <span class="org-rainbow-delimiters-depth-1">[</span><span class="org-haskell-type">Int</span><span class="org-rainbow-delimiters-depth-1">]</span>
  users <span class="org-haskell-operator">&lt;-</span> forM ids <span class="org-haskell-operator">$</span> <span class="org-haskell-operator">\</span> id <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-keyword">do</span>
    req <span class="org-haskell-operator">&lt;-</span> parseRequest <span class="org-haskell-operator">$</span> <span class="org-string">"http://localhost:3000/users/"</span> <span class="org-haskell-operator">++</span> show id
    resp <span class="org-haskell-operator">&lt;-</span> httpLbs req mgr
    <span class="org-haskell-keyword">let</span> <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-haskell-constructor">Just</span> <span class="org-rainbow-delimiters-depth-2">(</span>user<span class="org-haskell-constructor">:</span><span class="org-haskell-keyword">_</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-haskell-operator">=</span> decode <span class="org-rainbow-delimiters-depth-1">(</span>responseBody resp<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-type">Maybe</span> <span class="org-rainbow-delimiters-depth-1">[</span><span class="org-haskell-type">User</span><span class="org-rainbow-delimiters-depth-1">]</span>
    return user
  return <span class="org-haskell-operator">$</span> foldl <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-haskell-operator">\</span> map <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-haskell-constructor">User</span> id name<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-haskell-operator">-&gt;</span> M.insert id name map<span class="org-rainbow-delimiters-depth-1">)</span> M.empty users
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf418a26" class="outline-2">
<h2 id="orgf418a26">Generating programs</h2>
<div class="outline-text-2" id="text-orgf418a26">
<p>
My approach to generating a program is based on the idea that given a certain
state there is only a limited number of possible calls that make sense. Given a
model <code>m</code> it makes sense to make one of the following calls:
</p>

<ul class="org-ul">
<li>add a new user</li>
<li>delete an existing user</li>
<li>end the program</li>
</ul>

<p>
Based on this writing <code>genProgram</code> is rather straight forward
</p>

<div class="org-src-container">
<pre class="src src-haskell"><span class="org-haskell-definition">genProgram</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-type">Gen</span> <span class="org-haskell-type">Program</span>
<span class="org-haskell-definition">genProgram</span> <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">Prog</span> <span class="org-haskell-operator">&lt;$&gt;</span> go M.empty
  <span class="org-haskell-keyword">where</span>
    possibleAddUser <span class="org-haskell-keyword">_</span> <span class="org-haskell-operator">=</span> <span class="org-rainbow-delimiters-depth-1">[</span><span class="org-haskell-constructor">AddUser</span> <span class="org-haskell-operator">&lt;$&gt;</span> arbitrary<span class="org-rainbow-delimiters-depth-1">]</span>
    possibleDeleteUser m <span class="org-haskell-operator">=</span> map <span class="org-rainbow-delimiters-depth-1">(</span>return <span class="org-haskell-operator">.</span> <span class="org-haskell-constructor">DeleteUser</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-rainbow-delimiters-depth-1">(</span>M.keys m<span class="org-rainbow-delimiters-depth-1">)</span>
    possibleEndProgram <span class="org-haskell-keyword">_</span> <span class="org-haskell-operator">=</span> <span class="org-rainbow-delimiters-depth-1">[</span>return <span class="org-haskell-constructor">EndProgram</span><span class="org-rainbow-delimiters-depth-1">]</span>

    go m <span class="org-haskell-operator">=</span> <span class="org-haskell-keyword">do</span>
      <span class="org-haskell-keyword">let</span> possibles <span class="org-haskell-operator">=</span> possibleDeleteUser m <span class="org-haskell-operator">++</span> possibleAddUser m <span class="org-haskell-operator">++</span> possibleEndProgram m
      s <span class="org-haskell-operator">&lt;-</span> oneof possibles
      <span class="org-haskell-keyword">let</span> m' <span class="org-haskell-operator">=</span> simulateCall m s
      <span class="org-haskell-keyword">case</span> s <span class="org-haskell-keyword">of</span>
        <span class="org-haskell-constructor">EndProgram</span> <span class="org-haskell-operator">-&gt;</span> return <span class="org-haskell-constructor"><span class="org-rainbow-delimiters-depth-1">[]</span></span>
        <span class="org-haskell-keyword">_</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-rainbow-delimiters-depth-1">(</span>s<span class="org-haskell-constructor">:</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-haskell-operator">&lt;$&gt;</span> go m'
</pre>
</div>

<p>
Armed with that the <code>Arbitrary</code> instance for <code>Program</code> can be implemented as<sup><a id="fnr.1" class="footref" href="#fn.1">1</a></sup>
</p>

<div class="org-src-container">
<pre class="src src-haskell"><span class="org-haskell-keyword">instance</span> <span class="org-haskell-type">Arbitrary</span> <span class="org-haskell-type">Program</span> <span class="org-haskell-keyword">where</span>
  arbitrary <span class="org-haskell-operator">=</span> genProgram
  shrink p <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor"><span class="org-rainbow-delimiters-depth-1">[]</span></span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orge02a7fa" class="outline-2">
<h2 id="orge02a7fa">The property of an API</h2>
<div class="outline-text-2" id="text-orge02a7fa">
<p>
The steps in the <a href="#orgd2e8eeb">first section</a> can be used as a recipe for writing the property
</p>

<div class="org-src-container">
<pre class="src src-haskell"><span class="org-haskell-definition">prop_progCorrectness</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-type">Program</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-type">Property</span>
<span class="org-haskell-definition">prop_progCorrectness</span> program <span class="org-haskell-operator">=</span> monadicIO <span class="org-haskell-operator">$</span> <span class="org-haskell-keyword">do</span>
  <span class="org-haskell-keyword">let</span> simulatedModel <span class="org-haskell-operator">=</span> simulateProgram program
  runModel <span class="org-haskell-operator">&lt;-</span> run <span class="org-haskell-operator">$</span> runProgram program
  assert <span class="org-haskell-operator">$</span> simulatedModel <span class="org-haskell-operator">==</span> runModel
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd44c20f" class="outline-2">
<h2 id="orgd44c20f">What next?</h2>
<div class="outline-text-2" id="text-orgd44c20f">
<p>
There are some improvements that I'd like to make:
</p>

<ul class="org-ul">
<li>Make the generation of <code>Program</code> better in the sense that the programs become
longer. I think this is important as I start tackling larger APIs.</li>
<li>Write an implementation of <code>shrink</code> for <code>Program</code>. With longer programs it's
of course more important to actually implement <code>shrink</code>.</li>
</ul>

<p>
I'd love to hear if others are using <a href="https://hackage.haskell.org/package/QuickCheck">QuickCheck</a> to test REST APIs in some way,
if anyone has suggestions for improvements, and of course ideas for how to
implement <code>shrink</code> in a nice way.
</p>
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" class="footnum" href="#fnr.1">1</a></sup> <div class="footpara"><p class="footpara">
Yes, I completely skip the issue of shrinking programs at this point.
This is OK at this point though, because the generated =Programs=s do end up to
be very short indeed.
</p></div></div>


</div>
</div><div class="taglist"><a href="https://magnus.therning.org/tags.html">Tags</a>: <a href="https://magnus.therning.org/tag-emacs.html">emacs</a> <a href="https://magnus.therning.org/tag-haskell.html">haskell</a> <a href="https://magnus.therning.org/tag-flycheck.html">flycheck</a> </div><div id="archive">
<a href="https://magnus.therning.org/archive.html">Other posts</a>
</div>
</div>
<div id="postamble" class="status"><!-- org-static-blog-page-postamble --></div>
</body>
</html>
