<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<link rel="alternate"
      type="application/rss+xml"
      href="https://magnus.therning.org/feed.xml"
      title="RSS feed for https://magnus.therning.org/">
<title>Magnus web site</title>
<meta name="author" content="Magnus Therning"><meta name="referrer" content="no-referrer"><link href= "static/style.css" rel="stylesheet" type="text/css" /><link href= "static/htmlize.css" rel="stylesheet" type="text/css" /><link href= "static/extra_style.css" rel="stylesheet" type="text/css" /></head>
<body>
<div id="preamble" class="status"><div class="nav-bar"><a class="nav-link" href="./index.html">Top</a><a class="nav-link" href="./archive.html">Archive</a><a class="nav-link align-right" href="./feed.xml"><img src="static/rss-feed-icon.png" style="height: 24px;" /></a></div></div>
<div id="content">
<h1 class="title">Posts tagged "emacs":</h1>
<div class="post-date">14 Mar 2021</div><h1 class="post-title"><a href="https://magnus.therning.org/2021-03-14-keeping-todo-items-in-org-roam.html">Keeping todo items in org-roam</a></h1>
<p>
A while ago I made an attempt to improve my work habits by keeping a document
with TODO items. It lasted only for a while, and I've since had the intention to
make another attempt. Since then I've started using <a href="https://github.com/org-roam/org-roam">org-roam</a> and I've managed to
create a habit of writing daily journal notes using <a href="https://www.orgroam.com/manual.html#Daily_002dnotes">org-roam's daily-notes</a>. A
few times I've thought that it might fit me well to put TODO items in the notes,
but that would mean that I'd have to somehow keep track of them. At first I
manually added a tag to each journal fily containing a TODO item. That didn't
work very well at all, which should have been obvious up front. Then I added the
folders where I keep roam files and journals to <code>org-agenda-files</code>, that worked
a lot better. I'd still be using that, even if I expected it to slow down
considerably as the number of files grow, but then I found a post on <a href="https://d12frosted.io/posts/2021-01-16-task-management-with-roam-vol5.html">dynamic and
fast agenda with org-roam</a>.
</p>

<p>
I adjusted it slightly to fit my own setup a bit better, i.e. I made a Spacemacs
layer, <code>roam-extra</code>, I use the tag <code>todo</code>, and I use a different hook to get the
tag added on opening an org-roam file.
</p>

<p>
The layer consists of a single file, <code>layers/roam-extra/funcs.el</code>. In it I
define 4 functions (they are pretty much copies of the functions in the post
linked above):
</p>

<ol class="org-ol">
<li><code>roam-extra:todo-p</code> - returns non-<code>nil</code> if the current current buffer contains
a TODO item.</li>
<li><code>roam-extra:update-todo-tag</code> - updates the tags of the current buffer to
reflect the presence of TODO items, i.e. ensure the the tag <code>todo</code> is present
iff there's a TODO item.</li>
<li><code>roam-extra:todo-files</code> - uses the org-roam DB to return a list of all files
containing the tag <code>todo</code>.</li>
<li><code>roam-extra:update-todo-files</code> - adjusts <code>'org-agenda-files</code> to contain only
the files with TODO items.</li>
</ol>

<p>
I've put the full contents of the file at the <a href="#org6641697">end of the post</a>.
</p>

<p>
To ensure that the <code>todo</code> tag is correct in all org-mode files I've added
<code>roam-extra:update-todo-tag</code> to hooks that are invoked on opening an org-ram
file and when saving a file. (I would love to find a more specialise hook than
<code>before-save-hook</code>, but it works for now.)
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span>add-hook 'org-roam-file-setup-hook #'roam-extra:update-todo-tag<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span>add-hook 'before-save-hook #'roam-extra:update-todo-tag<span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<p>
To ensure that the list of files with TODO items is kept up to date when I open
I also wrap <code>org-agenda</code> in an advice so <code>roam-extra:update-todo-files</code> is
called prior to the agenda being opened.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span>advice-add 'org-agenda <span class="org-builtin">:before</span> #'roam-extra:update-todo-files<span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<div id="outline-container-org6641697" class="outline-2">
<h2 id="org6641697">The layer, <code>layers/roam-extra/funcs.el</code></h2>
<div class="outline-text-2" id="text-org6641697">
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defun</span> <span class="org-function-name">roam-extra:todo-p</span> <span class="org-rainbow-delimiters-depth-2">()</span>
  <span class="org-doc">"Return non-nil if current buffer has any </span><span class="custom">TODO</span><span class="org-doc"> entry.</span>

<span class="custom">TODO</span><span class="org-doc"> entries marked as done are ignored, meaning the this</span>
<span class="org-doc">function returns nil if current buffer contains only completed</span>
<span class="org-doc">tasks."</span>
  <span class="org-rainbow-delimiters-depth-2">(</span>org-element-map
      <span class="org-rainbow-delimiters-depth-3">(</span>org-element-parse-buffer 'headline<span class="org-rainbow-delimiters-depth-3">)</span>
      'headline
    <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-keyword">lambda</span> <span class="org-rainbow-delimiters-depth-4">(</span>h<span class="org-rainbow-delimiters-depth-4">)</span>
      <span class="org-rainbow-delimiters-depth-4">(</span>eq <span class="org-rainbow-delimiters-depth-5">(</span>org-element-property <span class="org-builtin">:todo-type</span> h<span class="org-rainbow-delimiters-depth-5">)</span>
          'todo<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>
    nil 'first-match<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defun</span> <span class="org-function-name">roam-extra:update-todo-tag</span> <span class="org-rainbow-delimiters-depth-2">()</span>
  <span class="org-doc">"Update </span><span class="custom">TODO</span><span class="org-doc"> tag in the current buffer."</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">when</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-keyword">and</span> <span class="org-rainbow-delimiters-depth-4">(</span>not <span class="org-rainbow-delimiters-depth-5">(</span>active-minibuffer-window<span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span>
             <span class="org-rainbow-delimiters-depth-4">(</span>org-roam--org-file-p buffer-file-name<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>
    <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-keyword">let*</span> <span class="org-rainbow-delimiters-depth-4">(</span><span class="org-rainbow-delimiters-depth-5">(</span>file <span class="org-rainbow-delimiters-depth-6">(</span>buffer-file-name <span class="org-rainbow-delimiters-depth-7">(</span>buffer-base-buffer<span class="org-rainbow-delimiters-depth-7">)</span><span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span>
           <span class="org-rainbow-delimiters-depth-5">(</span>all-tags <span class="org-rainbow-delimiters-depth-6">(</span>org-roam--extract-tags file<span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span>
           <span class="org-rainbow-delimiters-depth-5">(</span>prop-tags <span class="org-rainbow-delimiters-depth-6">(</span>org-roam--extract-tags-prop file<span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span>
           <span class="org-rainbow-delimiters-depth-5">(</span>tags prop-tags<span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span>
      <span class="org-rainbow-delimiters-depth-4">(</span><span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-5">(</span>roam-extra:todo-p<span class="org-rainbow-delimiters-depth-5">)</span>
          <span class="org-rainbow-delimiters-depth-5">(</span><span class="org-keyword">setq</span> tags <span class="org-rainbow-delimiters-depth-6">(</span>seq-uniq <span class="org-rainbow-delimiters-depth-7">(</span>cons <span class="org-string">"</span><span class="custom">todo</span><span class="org-string">"</span> tags<span class="org-rainbow-delimiters-depth-7">)</span><span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span>
        <span class="org-rainbow-delimiters-depth-5">(</span><span class="org-keyword">setq</span> tags <span class="org-rainbow-delimiters-depth-6">(</span>remove <span class="org-string">"</span><span class="custom">todo</span><span class="org-string">"</span> tags<span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span>
      <span class="org-rainbow-delimiters-depth-4">(</span><span class="org-keyword">unless</span> <span class="org-rainbow-delimiters-depth-5">(</span>equal prop-tags tags<span class="org-rainbow-delimiters-depth-5">)</span>
        <span class="org-rainbow-delimiters-depth-5">(</span>org-roam--set-global-prop
         <span class="org-string">"roam_tags"</span>
         <span class="org-rainbow-delimiters-depth-6">(</span>combine-and-quote-strings tags<span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defun</span> <span class="org-function-name">roam-extra:todo-files</span> <span class="org-rainbow-delimiters-depth-2">()</span>
  <span class="org-doc">"Return a list of note files containing </span><span class="custom">todo</span><span class="org-doc"> tag."</span>
  <span class="org-rainbow-delimiters-depth-2">(</span>seq-map
   #'car
   <span class="org-rainbow-delimiters-depth-3">(</span>org-roam-db-query
    <span class="org-rainbow-delimiters-depth-4">[</span><span class="org-builtin">:select</span> file
             <span class="org-builtin">:from</span> tags
             <span class="org-builtin">:where</span> <span class="org-rainbow-delimiters-depth-5">(</span>like tags <span class="org-rainbow-delimiters-depth-6">(</span><span class="org-keyword">quote</span> <span class="org-string">"%\"</span><span class="custom">todo</span><span class="org-string">\"%"</span><span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">]</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defun</span> <span class="org-function-name">roam-extra:update-todo-files</span> <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">&amp;rest</span> _<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-doc">"Update the value of `</span><span class="org-doc"><span class="org-constant">org-agenda-files</span></span><span class="org-doc">'."</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">setq</span> org-agenda-files <span class="org-rainbow-delimiters-depth-3">(</span>roam-extra:todo-files<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>
</div>
</div>
<div class="taglist"><a href="https://magnus.therning.org/tags.html">Tags</a>: <a href="https://magnus.therning.org/tag-emacs.html">emacs</a> <a href="https://magnus.therning.org/tag-org-mode.html">org-mode</a> <a href="https://magnus.therning.org/tag-org-roam.html">org-roam</a> <a href="https://magnus.therning.org/tag-spacemacs.html">spacemacs</a> </div>
<div class="post-date">05 Mar 2021</div><h1 class="post-title"><a href="https://magnus.therning.org/2021-03-05-000-flycheck-and-hls.html">Flycheck and HLS</a></h1>
<p>
I've been using LSP for most programming languages for a while now. HLS is
really very good now, but I've found that it doesn't warn on quite all things
I'd like it to so I find myself having to swap between the <code>'lsp</code> and
<code>'haskell-ghc</code> checkers. However, since <a href="https://www.flycheck.org/en/latest/">flycheck</a> supports chaining checkers I
thought there must be a way to have both checkers active at the same time.
</p>

<p>
The naive approach didn't work due to load order of things in Spacemacs so I had
to experiment a bit to find something that works.
</p>

<p>
The first issue was to make sure that HLS is available at all. I use <code>shell.nix</code>
together with <a href="https://direnv.net/">direnv</a> extensively and I had noticed that <code>lsp-mode</code> tried to load
HLS before <code>direnv</code> had put it in the <code>$PATH</code>. I think the
<code>'lsp-beforeinitialize-hook</code> is the hook to use for this:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span>add-hook 'lsp-before-initialize-hook #'direnv-update-environment<span class="org-rainbow-delimiters-depth-1">)</span><span class="org-rainbow-delimiters-unmatched">)</span>
</pre>
</div>

<p>
I made a several attempt to chain the checkers but kept on getting
errors due to the <code>'lsp</code> checker not being defined yet. Another problem
I ran into was that the checkers were chained too late, resulting in
having to manually run <code>flycheck-buffer</code> on the first file I opened.
(Deferred loading is a brilliant thing, but make some things really
difficult to debug.) After quite a bit of experimenting and reading the
description of various hooks I did find something that works:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">with-eval-after-load</span> 'lsp-mode
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">defun</span> <span class="org-function-name">magthe:lsp-next-checker</span> <span class="org-rainbow-delimiters-depth-3">()</span>
    <span class="org-rainbow-delimiters-depth-3">(</span>flycheck-add-next-checker 'lsp '<span class="org-rainbow-delimiters-depth-4">(</span>warning . haskell-ghc<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">(</span>add-hook 'lsp-lsp-haskell-after-open-hook
            #'magthe:lsp-next-checker<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<p>
Of course I have no idea if this is the easiest or most elegant solution but it
does work for my testcases:
</p>

<ol class="org-ol">
<li>Open a file in a project, <code>SPC p l</code> - choose project - choose a Haskell file.</li>
<li>Open a project, <code>SPC p l</code> followed by <code>C-d</code>, and then open a Haskell file.</li>
</ol>

<p>
Suggestions for improvements are more than welcome, of course.
</p>
<div class="taglist"><a href="https://magnus.therning.org/tags.html">Tags</a>: <a href="https://magnus.therning.org/tag-emacs.html">emacs</a> <a href="https://magnus.therning.org/tag-haskell.html">haskell</a> <a href="https://magnus.therning.org/tag-flycheck.html">flycheck</a> </div>
<div class="post-date">22 Jun 2020</div><h1 class="post-title"><a href="https://magnus.therning.org/2020-06-22-000-better-nix-setup-for-spacemacs.html">Better Nix setup for Spacemacs</a></h1>
<p>
In an <a href="2019-12-07-000-nix-setup-for-spacemacs.html">earlier post</a> I documented my setup for getting <a href="https://www.spacemacs.org/">Spacemacs</a>/Emacs to work
with <a href="https://nixos.org/nix/">Nix</a>. I've since found a much more elegant solution based on
</p>

<ul class="org-ul">
<li><a href="https://github.com/direnv/direnv/">direnv</a>, and</li>
<li><a href="https://github.com/wbolster/emacs-direnv">emacs-direnv</a></li>
</ul>

<p>
No more Emacs packages for Nix and no need to defining functions that wrap
executables in an invocation of <code>nix-shell</code>.
</p>

<p>
There's a nice bonus too, with this setup I don't need to run <code>nix-shell</code>, which
always drops me at a bash prompt, instead I get a working setup in my shell of
choice.
</p>

<div id="outline-container-orgd063368" class="outline-2">
<h2 id="orgd063368">Setting up <code>direnv</code></h2>
<div class="outline-text-2" id="text-orgd063368">
<p>
The steps for setting up <code>direnv</code> depends a bit on your setup, but luckily I
found the <a href="https://direnv.net/#basic-installation">official instructions for installing <code>direnv</code></a> to be very clear and
easy to follow. There's not much I can add to that.
</p>
</div>
</div>

<div id="outline-container-org9ce9cc2" class="outline-2">
<h2 id="org9ce9cc2">Setting up Spacemacs</h2>
<div class="outline-text-2" id="text-org9ce9cc2">
<p>
Since <code>emacs-direnv</code> isn't included by default in Spacemacs I needed to do a bit
of setup. I opted to create a layer for it, rather than just drop it in the list
<code>dotspacemacs-additional-packages</code>. Yes, a little more complicated, but not
difficult and I nurture an intention of submitting the layer for inclusion in
Spacemacs itself at some point. I'll see where that goes.
</p>

<p>
For now, I put the following in the file
<code>~/.emacs.d/private/layers/direnv/packages.el</code>:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defconst</span> <span class="org-variable-name">direnv-packages</span>
      '<span class="org-rainbow-delimiters-depth-2">(</span>direnv<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defun</span> <span class="org-function-name">direnv/init-direnv</span> <span class="org-rainbow-delimiters-depth-2">()</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">use-package</span> <span class="org-constant">direnv</span>
    <span class="org-builtin">:init</span>
    <span class="org-rainbow-delimiters-depth-3">(</span>direnv-mode<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org6002225" class="outline-2">
<h2 id="org6002225">Setting up the project folders</h2>
<div class="outline-text-2" id="text-org6002225">
<p>
In each project folder I then add the file <code>.envrc</code> containing a single line:
</p>

<div class="org-src-container">
<pre class="src src-shell">use_nix
</pre>
</div>

<p>
Then I either run <code>direnv allow</code> from the command line, or run the
function <code>direnv-allow</code> after opening the folder in Emacs.
</p>
</div>
</div>

<div id="outline-container-orgbcb33a0" class="outline-2">
<h2 id="orgbcb33a0">Using it</h2>
<div class="outline-text-2" id="text-orgbcb33a0">
<p>
It's as simple as moving into the folder in a shell &#x2013; all required envvars are
set up on entry and unset on exit.
</p>

<p>
In Emacs it's just as simple, just open a file in a project and the envvars are
set. When switching to a buffer outside the project the envvars are unset.
</p>

<p>
There is only one little caveat, <code>nix-build</code> doesn't work inside a Nix shell. I
found out that running
</p>

<div class="org-src-container">
<pre class="src src-shell"><span class="org-variable-name">IN_NIX_SHELL</span>= nix-build
</pre>
</div>

<p>
does work though.
</p>
</div>
</div>
<div class="taglist"><a href="https://magnus.therning.org/tags.html">Tags</a>: <a href="https://magnus.therning.org/tag-emacs.html">emacs</a> <a href="https://magnus.therning.org/tag-nix.html">nix</a> <a href="https://magnus.therning.org/tag-spacemacs.html">spacemacs</a> </div>
<div class="post-date">07 Dec 2019</div><h1 class="post-title"><a href="https://magnus.therning.org/2019-12-07-000-nix-setup-for-spacemacs.html">Nix setup for Spacemacs</a></h1>
<p>
<i>Edit 2020-06-22: I've since found a <a href="2020-06-22-000-better-nix-setup-for-spacemacs.html">better setup for this</a>.</i>
</p>

<p>
When using <code>ghcide</code> and LSP, as I wrote about in my post on <a href="2019-09-19-000-haskell--ghcide--and-spacemacs.html">Haskell, ghcide, and
Spacemacs</a>, I found myself ending up recompiling a little too often. This pushed
me to finally start looking at <a href="https://nixos.org/nix/">Nix</a>. After a bit of a fight I managed to
<a href="https://discourse.nixos.org/t/import-and-use-ghide-nix">get ghcide from Nix</a>,
which brought me the issue of setting up Spacemacs. Inspired by <a href="https://gist.github.com/sevanspowell/23b0135dae2834e59904a502b8a0eb5d">a gist from
Samuel Evans-Powell</a> and a guide to <a href="https://github.com/thalesmg/reflex-skeleton/blob/master/Readme.org#setting-up-editor-integration-with-emacs">setting up an environment for Reflex by
Thales Macedo Garitezi</a> I ended up with the following setup:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defun</span> <span class="org-function-name">dotspacemacs/layers</span> <span class="org-rainbow-delimiters-depth-2">()</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">setq-default</span>
   ...
   dotspacemacs-additional-packages
   '<span class="org-rainbow-delimiters-depth-3">(</span>
     nix-sandbox
     nix-haskell-mode
     ...
     <span class="org-rainbow-delimiters-depth-3">)</span>
   ...
   <span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defun</span> <span class="org-function-name">dotspacemacs/user-config</span> <span class="org-rainbow-delimiters-depth-2">()</span>
  ...
  <span class="org-rainbow-delimiters-depth-2">(</span>add-hook 'haskell-mode-hook #'lsp<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">(</span>add-hook 'haskell-mode-hook 'nix-haskell-mode<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">(</span>add-hook 'haskell-mode-hook
            <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-keyword">lambda</span> <span class="org-rainbow-delimiters-depth-4">()</span>
              <span class="org-rainbow-delimiters-depth-4">(</span><span class="org-keyword">setq-local</span> flycheck-executable-find
                          <span class="org-rainbow-delimiters-depth-5">(</span><span class="org-keyword">lambda</span> <span class="org-rainbow-delimiters-depth-6">(</span>cmd<span class="org-rainbow-delimiters-depth-6">)</span>
                            <span class="org-rainbow-delimiters-depth-6">(</span>nix-executable-find <span class="org-rainbow-delimiters-depth-7">(</span>nix-current-sandbox<span class="org-rainbow-delimiters-depth-7">)</span> cmd<span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span>
              <span class="org-rainbow-delimiters-depth-4">(</span><span class="org-keyword">setq-local</span> flycheck-command-wrapper-function
                          <span class="org-rainbow-delimiters-depth-5">(</span><span class="org-keyword">lambda</span> <span class="org-rainbow-delimiters-depth-6">(</span>argv<span class="org-rainbow-delimiters-depth-6">)</span>
                            <span class="org-rainbow-delimiters-depth-6">(</span>apply 'nix-shell-command <span class="org-rainbow-delimiters-depth-7">(</span>nix-current-sandbox<span class="org-rainbow-delimiters-depth-7">)</span> argv<span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span>
              <span class="org-rainbow-delimiters-depth-4">(</span><span class="org-keyword">setq-local</span> haskell-process-wrapper-function
                          <span class="org-rainbow-delimiters-depth-5">(</span><span class="org-keyword">lambda</span> <span class="org-rainbow-delimiters-depth-6">(</span>argv<span class="org-rainbow-delimiters-depth-6">)</span>
                            <span class="org-rainbow-delimiters-depth-6">(</span>apply 'nix-shell-command <span class="org-rainbow-delimiters-depth-7">(</span>nix-current-sandbox<span class="org-rainbow-delimiters-depth-7">)</span> argv<span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span>
              <span class="org-rainbow-delimiters-depth-4">(</span><span class="org-keyword">setq-local</span> lsp-haskell-process-wrapper-function
                          <span class="org-rainbow-delimiters-depth-5">(</span><span class="org-keyword">lambda</span> <span class="org-rainbow-delimiters-depth-6">(</span>argv<span class="org-rainbow-delimiters-depth-6">)</span>
                            `<span class="org-rainbow-delimiters-depth-6">(</span><span class="org-string">"nix-shell"</span> <span class="org-string">"-I"</span> <span class="org-string">"."</span> <span class="org-string">"--command"</span> <span class="org-string">"ghcide --lsp"</span> ,<span class="org-rainbow-delimiters-depth-7">(</span>nix-current-sandbox<span class="org-rainbow-delimiters-depth-7">)</span><span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">(</span>add-hook 'haskell-mode-hook
            <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-keyword">lambda</span> <span class="org-rainbow-delimiters-depth-4">()</span>
              <span class="org-rainbow-delimiters-depth-4">(</span>flycheck-add-next-checker 'lsp-ui '<span class="org-rainbow-delimiters-depth-5">(</span>warning . haskell-stack-ghc<span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>
  ...
  <span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<p>
It seems to work, but please let me know if you have suggestions for
improvements.
</p>
<div class="taglist"><a href="https://magnus.therning.org/tags.html">Tags</a>: <a href="https://magnus.therning.org/tag-emacs.html">emacs</a> <a href="https://magnus.therning.org/tag-nix.html">nix</a> <a href="https://magnus.therning.org/tag-spacemacs.html">spacemacs</a> </div>
<div class="post-date">05 Nov 2019</div><h1 class="post-title"><a href="https://magnus.therning.org/2019-11-05-000-populating-projectile-s-cache.html">Populating Projectile's cache</a></h1>
<p>
As I track the <i>develop</i> branch of <a href="https://github.com/syl20bnr/spacemacs/">Spacemacs</a> I occasionally clean out my cache
of projects known to Projectile. Every time it takes a while before I'm back at
a stage where I very rarely have to visit something that isn't already in the
cache.
</p>

<p>
However, today I found the function <code>projectile-add-known-project</code>, which
prompted me to write the following function that'll help me quickly re-building
the cache the next time I need to reset Spacemacs to a known state again.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defun</span> <span class="org-function-name">projectile-extra-add-projects-in-subfolders</span> <span class="org-rainbow-delimiters-depth-2">(</span>projects-root<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">interactive</span> <span class="org-rainbow-delimiters-depth-3">(</span>list <span class="org-rainbow-delimiters-depth-4">(</span>read-directory-name <span class="org-string">"Add to known projects: "</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">(</span>message <span class="org-string">"Searching for projects in %s..."</span> projects-root<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">let</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-rainbow-delimiters-depth-4">(</span>dirs <span class="org-rainbow-delimiters-depth-5">(</span>seq-map 'file-name-directory <span class="org-rainbow-delimiters-depth-6">(</span>directory-files-recursively projects-root <span class="org-string">"^.git$"</span> t<span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>
    <span class="org-rainbow-delimiters-depth-3">(</span>seq-do 'projectile-add-known-project dirs<span class="org-rainbow-delimiters-depth-3">)</span>
    <span class="org-rainbow-delimiters-depth-3">(</span>message <span class="org-string">"Added %d projects"</span> <span class="org-rainbow-delimiters-depth-4">(</span>length dirs<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>
<div class="taglist"><a href="https://magnus.therning.org/tags.html">Tags</a>: <a href="https://magnus.therning.org/tag-emacs.html">emacs</a> <a href="https://magnus.therning.org/tag-elisp.html">elisp</a> </div>
<div class="post-date">20 Oct 2019</div><h1 class="post-title"><a href="https://magnus.therning.org/2019-10-20-000-ditaa-in-org-mode.html">Ditaa in Org mode</a></h1>
<p>
Just found out that Emacs ships with Babel support for <a href="https://writequit.org/denver-emacs/presentations/2016-04-19-whats-new-emacs25-ditaa-artist.html#orgheadline15">ditaa</a> (yes, I'm late to
the party).
</p>

<p>
Sweet! That is yet another argument for converting all our <code>README.md</code> into
<code>README.org</code> at work.
</p>

<p>
<img src="https://media.giphy.com/media/xl5QdxfNonh3q/giphy.gif" alt="giphy.gif">\
</p>

<p>
The changes I made to my Spacemacs config are
</p>

<div class="org-src-container">
<pre class="src src-lisp"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defun</span> <span class="org-function-name">dotspacemacs/user-config</span> <span class="org-rainbow-delimiters-depth-2">()</span>
  ...
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">with-eval-after-load</span> 'org
    ...
    <span class="org-rainbow-delimiters-depth-3">(</span>add-to-list 'org-babel-load-languages '<span class="org-rainbow-delimiters-depth-4">(</span>ditaa . t<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>
    <span class="org-rainbow-delimiters-depth-3">(</span>setq org-ditaa-jar-path <span class="org-string">"/usr/share/java/ditaa/ditaa-0.11.jar"</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>
  ...<span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>
<div class="taglist"><a href="https://magnus.therning.org/tags.html">Tags</a>: <a href="https://magnus.therning.org/tag-emacs.html">emacs</a> <a href="https://magnus.therning.org/tag-orgmode.html">orgmode</a> </div>
<div class="post-date">19 Sep 2019</div><h1 class="post-title"><a href="https://magnus.therning.org/2019-09-19-000-haskell--ghcide--and-spacemacs.html">Haskell, ghcide, and Spacemacs</a></h1>
<p>
The other day I read Chris Penner's post on <a href="https://chrispenner.ca/posts/hie-core">Haskell IDE Support</a> and thought I'd
make an attempt to use it with Spacemacs.
</p>

<p>
After running <code>stack build hie-bios ghcide haskell-lsp --copy-compiler-tool</code> I
had a look at the <a href="https://github.com/haskell/haskell-ide-engine#using-hie-with-spacemacs">instructions on using <code>haskell-ide-engine</code> with Spacemacs</a>.
After a bit of trial and error I came up with these changes to my
<code>~/.spacemacs</code>:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defun</span> <span class="org-function-name">dotspacemacs/layers</span> <span class="org-rainbow-delimiters-depth-2">()</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">setq-default</span>
   dotspacemacs-configuration-layers
   '<span class="org-rainbow-delimiters-depth-3">(</span>
    ...
    lsp
    <span class="org-rainbow-delimiters-depth-4">(</span>haskell <span class="org-builtin">:variables</span>
             haskell-completion-backend 'lsp
             <span class="org-rainbow-delimiters-depth-4">)</span>
    ...<span class="org-rainbow-delimiters-depth-3">)</span>
  <span class="org-rainbow-delimiters-depth-2">)</span>
<span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defun</span> <span class="org-function-name">dotspacemacs/user-config</span> <span class="org-rainbow-delimiters-depth-2">()</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">setq</span> lsp-haskell-process-args-hie '<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"exec"</span> <span class="org-string">"ghcide"</span> <span class="org-string">"--"</span> <span class="org-string">"--lsp"</span><span class="org-rainbow-delimiters-depth-3">)</span>
        lsp-haskell-process-path-hie <span class="org-string">"stack"</span>
        lsp-haskell-process-wrapper-function <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-keyword">lambda</span> <span class="org-rainbow-delimiters-depth-4">(</span>argv<span class="org-rainbow-delimiters-depth-4">)</span> <span class="org-rainbow-delimiters-depth-4">(</span>cons <span class="org-rainbow-delimiters-depth-5">(</span>car argv<span class="org-rainbow-delimiters-depth-5">)</span> <span class="org-rainbow-delimiters-depth-5">(</span>cddr argv<span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">(</span>add-hook 'haskell-mode-hook
            #'lsp<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<p>
The slightly weird looking <code>lsp-haskell-process-wrapper-function</code> is removing
the pesky <code>--lsp</code> inserted by <a href="https://github.com/emacs-lsp/lsp-haskell/blob/64106be79350f9ce6903d22c66b29761dadb5001/lsp-haskell.el#L179">this line</a>.
</p>

<p>
That seems to work. Though I have to say I'm not ready to switch from <a href="https://hackage.haskell.org/package/intero">intero</a>
just yet. Two things in particular didn't work with =ghcide=/LSP:
</p>

<ol class="org-ol">
<li>Switching from one the <code>Main.hs</code> in one executable to the <code>Main.hs</code> of
another executable in the same project didn't work as expected &#x2013; I had hints
and types in the first, but nothing in the second.</li>
<li>Jump to the definition of a function defined in the package didn't work &#x2013;
I'm not willing to use <a href="https://www.gnu.org/software/global/">GNU GLOBAL</a> or some other source tagging system.</li>
</ol>
<div class="taglist"><a href="https://magnus.therning.org/tags.html">Tags</a>: <a href="https://magnus.therning.org/tag-emacs.html">emacs</a> <a href="https://magnus.therning.org/tag-haskell.html">haskell</a> <a href="https://magnus.therning.org/tag-lsp.html">lsp</a> <a href="https://magnus.therning.org/tag-spacemacs.html">spacemacs</a> </div>
<div class="post-date">07 May 2019</div><h1 class="post-title"><a href="https://magnus.therning.org/2019-05-07-000-some-orgmode-stuff.html">Some OrgMode stuff</a></h1>
<p>
The last few days I've watched <a href="https://www.youtube.com/user/koenighaunstetten">Rainer König's OrgMode videos</a>. It's resulted in a
few new settings that makes <a href="https://orgmode.org/">Org</a> a little more useful.
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Variable</th>
<th scope="col" class="org-left">Value</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>calendar-week-start-day</code></td>
<td class="org-left"><code>1</code></td>
<td class="org-left">Weeks start on Monday!</td>
</tr>

<tr>
<td class="org-left"><code>org-modules</code> (list)</td>
<td class="org-left"><code>org-habit</code></td>
<td class="org-left">Support for tracking habits</td>
</tr>

<tr>
<td class="org-left"><code>org-modules</code> (list)</td>
<td class="org-left"><code>org-id</code></td>
<td class="org-left">Improved support for <code>ID</code> property</td>
</tr>

<tr>
<td class="org-left"><code>org-agenda-start-on-weekday</code></td>
<td class="org-left"><code>1</code></td>
<td class="org-left">Weeks start on Monday, again!</td>
</tr>

<tr>
<td class="org-left"><code>org-log-into-drawer</code></td>
<td class="org-left"><code>t</code></td>
<td class="org-left">Put notes (logs) into a drawer</td>
</tr>

<tr>
<td class="org-left"><code>org-enforce-todo-checkbox-dependencies</code></td>
<td class="org-left"><code>t</code></td>
<td class="org-left">Checkboxes must be checked before a <i>TODO</i> can become <i>DONE</i></td>
</tr>

<tr>
<td class="org-left"><code>org-id-link-to-org-use-id</code></td>
<td class="org-left"><code>t</code></td>
<td class="org-left">Prefer use of <code>ID</code> property for links</td>
</tr>
</tbody>
</table>
<div class="taglist"><a href="https://magnus.therning.org/tags.html">Tags</a>: <a href="https://magnus.therning.org/tag-emacs.html">emacs</a> <a href="https://magnus.therning.org/tag-orgmode.html">orgmode</a> </div>
<div class="post-date">16 Mar 2019</div><h1 class="post-title"><a href="https://magnus.therning.org/2019-03-16-000-til--prompt-matters-to-org-mode.html">TIL: prompt matters to org-mode</a></h1>
<p>
A workmate just embellished some shell code blocks I'd put in a shared <a href="https://orgmode.org/">org-mode</a>
file with <code>:session s</code>. When I tried to run the blocks with sessions my emacs
just froze up though. I found a <a href="https://emacs.stackexchange.com/questions/19735/emacs-freezes-with-any-org-babel-snippet-using-session">post on the emacs StackExchange</a> that offered a
possible cause for it: the prompt.
</p>

<p>
I'm using <a href="https://github.com/Bash-it/bash-it">bash-it</a> so my prompt is rather far from the default.
</p>

<p>
After inspecting the session buffer simply added the following to my <code>~/.bashrc</code>
</p>

<div class="org-src-container">
<pre class="src src-shell"><span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-1">[</span><span class="org-rainbow-delimiters-depth-2">[</span> $<span class="org-rainbow-delimiters-depth-3">{</span><span class="org-variable-name">TERM</span><span class="org-rainbow-delimiters-depth-3">}</span> == <span class="org-string">"dumb"</span> <span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">]</span>; <span class="org-keyword">then</span>
    <span class="org-builtin">export</span> <span class="org-variable-name">BASH_IT_THEME</span>=<span class="org-string">'standard'</span>
<span class="org-keyword">else</span>
    <span class="org-builtin">export</span> <span class="org-variable-name">BASH_IT_THEME</span>=<span class="org-string">'simple'</span>
<span class="org-keyword">fi</span>
</pre>
</div>

<p>
and now I can finally run shell code blocks in sessions.
</p>
<div class="taglist"><a href="https://magnus.therning.org/tags.html">Tags</a>: <a href="https://magnus.therning.org/tag-emacs.html">emacs</a> <a href="https://magnus.therning.org/tag-orgmode.html">orgmode</a> </div>
<div class="post-date">28 Jan 2019</div><h1 class="post-title"><a href="https://magnus.therning.org/2019-01-28-000-a-missing-piece-in-my-emacs-spacemacs-setup-for-haskell-development.html">A missing piece in my Emacs/Spacemacs setup for Haskell development</a></h1>
<p>
With the help of a work mate I've finally found this gem that's been missing
from my Spacemacs setup
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">with-eval-after-load</span> 'intero
  <span class="org-rainbow-delimiters-depth-2">(</span>flycheck-add-next-checker 'intero '<span class="org-rainbow-delimiters-depth-3">(</span>warning . haskell-hlint<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">(</span>flycheck-add-next-checker 'intero '<span class="org-rainbow-delimiters-depth-3">(</span>warning . haskell-stack-ghc<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>
<div class="taglist"><a href="https://magnus.therning.org/tags.html">Tags</a>: <a href="https://magnus.therning.org/tag-haskell.html">haskell</a> <a href="https://magnus.therning.org/tag-emacs.html">emacs</a> <a href="https://magnus.therning.org/tag-spacemacs.html">spacemacs</a> </div>
<div class="post-date">14 Jul 2018</div><h1 class="post-title"><a href="https://magnus.therning.org/2018-07-14-000-quickcheck-on-a-rest-api.html">QuickCheck on a REST API</a></h1>
<p>
Since I'm working with web stuff nowadays I thought I'd play a little with
translating my old post on <a href="2015-06-15-000-using-quickcheck-to-test-c-apis.html">using QuickCheck to test C APIs</a> to the web.
</p>

<div id="outline-container-orgd2e8eeb" class="outline-2">
<h2 id="orgd2e8eeb">The goal and how to reach it</h2>
<div class="outline-text-2" id="text-orgd2e8eeb">
<p>
I want to use <a href="https://hackage.haskell.org/package/QuickCheck">QuickCheck</a> to test a REST API, just like in the case of the C API
the idea is to
</p>

<ol class="org-ol">
<li>generate a sequence of API calls (a <i>program</i>), then</li>
<li>run the sequence against a model, as well as</li>
<li>run the sequence against the web service, and finally</li>
<li>compare the resulting model against reality.</li>
</ol>
</div>
</div>

<div id="outline-container-org776189d" class="outline-2">
<h2 id="org776189d">The REST API</h2>
<div class="outline-text-2" id="text-org776189d">
<p>
I'll use a small web service I'm working on, and then concentrate on only a
small part of the API to begin with.
</p>

<p>
The parts of the API I'll use for the programs at this stage are
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Method</th>
<th scope="col" class="org-left">Route</th>
<th scope="col" class="org-left">Example in</th>
<th scope="col" class="org-left">Example out</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>POST</code></td>
<td class="org-left"><code>/users</code></td>
<td class="org-left"><code>{"userId": 0, "userName": "Yogi Berra"}</code></td>
<td class="org-left"><code>{"userId": 42, "userName": "Yogi Berra"}</code></td>
</tr>

<tr>
<td class="org-left"><code>DELETE</code></td>
<td class="org-left"><code>/users/:id</code></td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>

<p>
The following API calls will also be used, but not in the programs
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Method</th>
<th scope="col" class="org-left">Route</th>
<th scope="col" class="org-left">Example in</th>
<th scope="col" class="org-left">Example out</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>GET</code></td>
<td class="org-left"><code>/users</code></td>
<td class="org-left">&#xa0;</td>
<td class="org-left"><code>[0,3,7]</code></td>
</tr>

<tr>
<td class="org-left"><code>GET</code></td>
<td class="org-left"><code>/users/:id</code></td>
<td class="org-left">&#xa0;</td>
<td class="org-left"><code>{"userId": 42, "userName": "Yogi Berra"}</code></td>
</tr>

<tr>
<td class="org-left"><code>POST</code></td>
<td class="org-left"><code>/reset</code></td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-org45a80a7" class="outline-2">
<h2 id="org45a80a7">Representing API calls</h2>
<div class="outline-text-2" id="text-org45a80a7">
<p>
Given the information about the API above it seems the following is enough to
represent the two calls of interest together with a constructor representing the
end of a program
</p>

<div class="org-src-container">
<pre class="src src-haskell"><span class="org-haskell-keyword">data</span> <span class="org-haskell-type">ApiCall</span> <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">AddUser</span> <span class="org-haskell-constructor">Text</span>
             <span class="org-haskell-operator">|</span> <span class="org-haskell-constructor">DeleteUser</span> <span class="org-haskell-constructor">Int</span>
             <span class="org-haskell-operator">|</span> <span class="org-haskell-constructor">EndProgram</span>
             <span class="org-haskell-keyword">deriving</span> <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-haskell-constructor">Show</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<p>
and a program is just a sequence of calls, so list of <code>ApiCall</code> will do.
However, since I want to generate sequences of calls, i.e. implement
<code>Arbitrary</code>, I'll wrap it in a <code>newtype</code>
</p>

<div class="org-src-container">
<pre class="src src-haskell"><span class="org-haskell-keyword">newtype</span> <span class="org-haskell-type">Program</span> <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">Prog</span> <span class="org-rainbow-delimiters-depth-1">[</span><span class="org-haskell-constructor">ApiCall</span><span class="org-rainbow-delimiters-depth-1">]</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org8734229" class="outline-2">
<h2 id="org8734229">Running against a model (simulation)</h2>
<div class="outline-text-2" id="text-org8734229">
<p>
First of all I need to decide what model to use. Based on the part of the API
I'm using I'll use an ordinary dictionary of <code>Int</code> and <code>Text</code>
</p>

<div class="org-src-container">
<pre class="src src-haskell"><span class="org-haskell-keyword">type</span> <span class="org-haskell-type">Model</span> <span class="org-haskell-operator">=</span> <span class="org-haskell-type">M.Map</span> <span class="org-haskell-type">Int</span> <span class="org-haskell-type">Text</span>
</pre>
</div>

<p>
Simulating execution of a program is simulating each call against a
model that's updated with each step. I expect the final model to
correspond to the state of the real service after the program is run for
real. The simulation begins with an empty dictionary.
</p>

<div class="org-src-container">
<pre class="src src-haskell"><span class="org-haskell-definition">simulateProgram</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-type">Program</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-type">Model</span>
<span class="org-haskell-definition">simulateProgram</span> <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-haskell-constructor">Prog</span> cs<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-haskell-operator">=</span> foldl simulateCall M.empty cs
</pre>
</div>

<p>
The simulation of the API calls must then be a function taking a model and a
call, returning an updated model
</p>

<div class="org-src-container">
<pre class="src src-haskell"><span class="org-haskell-definition">simulateCall</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-type">Model</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-type">ApiCall</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-type">Model</span>
<span class="org-haskell-definition">simulateCall</span> m <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-haskell-constructor">AddUser</span> t<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-haskell-operator">=</span> M.insert k t m
  <span class="org-haskell-keyword">where</span>
    k <span class="org-haskell-operator">=</span> succ <span class="org-haskell-operator">$</span> foldl max <span class="org-highlight-numbers-number">0</span> <span class="org-rainbow-delimiters-depth-1">(</span>M.keys m<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-haskell-definition">simulateCall</span> m <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-haskell-constructor">DeleteUser</span> k<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-haskell-operator">=</span> M.delete k m
<span class="org-haskell-definition">simulateCall</span> m <span class="org-haskell-constructor">EndProgram</span> <span class="org-haskell-operator">=</span> m
</pre>
</div>

<p>
Here I have to make a few assumptions. First, I assume the indeces for the users
start on <code>1</code>. Second, that the next index used always is the successor of
highest currently used index. We'll see how well this holds up to reality later
on.
</p>
</div>
</div>

<div id="outline-container-org9c8cb3a" class="outline-2">
<h2 id="org9c8cb3a">Running against the web service</h2>
<div class="outline-text-2" id="text-org9c8cb3a">
<p>
Running the program against the actual web service follows the same pattern, but
here I'm dealing with the real world, so it's a little more messy, i.e. <code>IO</code> is
involved. First the running of a single call
</p>

<div class="org-src-container">
<pre class="src src-haskell"><span class="org-haskell-definition">runCall</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-type">Manager</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-type">ApiCall</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-type">IO</span> <span class="org-haskell-constructor"><span class="org-rainbow-delimiters-depth-1">()</span></span>
<span class="org-haskell-definition">runCall</span> mgr <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-haskell-constructor">AddUser</span> t<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-haskell-operator">=</span> <span class="org-haskell-keyword">do</span>
  ireq <span class="org-haskell-operator">&lt;-</span> parseRequest <span class="org-string">"POST http://localhost:3000/users"</span>
  <span class="org-haskell-keyword">let</span> req <span class="org-haskell-operator">=</span> ireq <span class="org-rainbow-delimiters-depth-1">{</span> requestBody <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">RequestBodyLBS</span> <span class="org-rainbow-delimiters-depth-2">(</span>encode <span class="org-haskell-operator">$</span> <span class="org-haskell-constructor">User</span> <span class="org-highlight-numbers-number">0</span> t<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">}</span>
  resp <span class="org-haskell-operator">&lt;-</span> httpLbs req mgr
  guard <span class="org-rainbow-delimiters-depth-1">(</span>status201 <span class="org-haskell-operator">==</span> responseStatus resp<span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-haskell-definition">runCall</span> mgr <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-haskell-constructor">DeleteUser</span> k<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-haskell-operator">=</span> <span class="org-haskell-keyword">do</span>
  req <span class="org-haskell-operator">&lt;-</span> parseRequest <span class="org-haskell-operator">$</span> <span class="org-string">"DELETE http://localhost:3000/users/"</span> <span class="org-haskell-operator">++</span> show k
  resp <span class="org-haskell-operator">&lt;-</span> httpNoBody req mgr
  guard <span class="org-rainbow-delimiters-depth-1">(</span>status200 <span class="org-haskell-operator">==</span> responseStatus resp<span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-haskell-definition">runCall</span> <span class="org-haskell-keyword">_</span> <span class="org-haskell-constructor">EndProgram</span> <span class="org-haskell-operator">=</span> return <span class="org-haskell-constructor"><span class="org-rainbow-delimiters-depth-1">()</span></span>
</pre>
</div>

<p>
The running of a program is slightly more involved. Of course I have to set up
the <code>Manager</code> needed for the HTTP calls, but I also need to
</p>

<ol class="org-ol">
<li>ensure that the web service is in a well-known state before starting, and</li>
<li>extract the state of the web service after running the program, so I can
compare it to the model</li>
</ol>

<div class="org-src-container">
<pre class="src src-haskell"><span class="org-haskell-definition">runProgram</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-type">Program</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-type">IO</span> <span class="org-haskell-type">Model</span>
<span class="org-haskell-definition">runProgram</span> <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-haskell-constructor">Prog</span> cs<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-haskell-operator">=</span> <span class="org-haskell-keyword">do</span>
  mgr <span class="org-haskell-operator">&lt;-</span> newManager defaultManagerSettings
  resetReq <span class="org-haskell-operator">&lt;-</span> parseRequest <span class="org-string">"POST http://localhost:3000/reset"</span>
  httpNoBody resetReq mgr
  mapM_ <span class="org-rainbow-delimiters-depth-1">(</span>runCall mgr<span class="org-rainbow-delimiters-depth-1">)</span> cs
  model <span class="org-haskell-operator">&lt;-</span> extractModel mgr
  return model
</pre>
</div>

<p>
The call to <code>POST /reset</code> resets the web service. I would have liked to simply
restart the service completely, but I failed in automating it. I think I'll have
to take a closer look at the implementation of <a href="http://hackage.haskell.org/package/scotty">scotty</a> to find a way.
</p>

<p>
Extracting the web service state and packaging it in a <code>Model</code> is a matter of
calling <code>GET /users</code> and then repeatedly calling <code>GET /users/:id</code> with each <code>id</code>
gotten from the first call
</p>

<div class="org-src-container">
<pre class="src src-haskell"><span class="org-haskell-definition">extractModel</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-type">Manager</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-type">IO</span> <span class="org-haskell-type">Model</span>
<span class="org-haskell-definition">extractModel</span> mgr <span class="org-haskell-operator">=</span> <span class="org-haskell-keyword">do</span>
  req <span class="org-haskell-operator">&lt;-</span> parseRequest <span class="org-string">"http://localhost:3000/users"</span>
  resp <span class="org-haskell-operator">&lt;-</span> httpLbs req mgr
  <span class="org-haskell-keyword">let</span> <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-haskell-constructor">Just</span> ids<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-haskell-operator">=</span> decode <span class="org-rainbow-delimiters-depth-1">(</span>responseBody resp<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-type">Maybe</span> <span class="org-rainbow-delimiters-depth-1">[</span><span class="org-haskell-type">Int</span><span class="org-rainbow-delimiters-depth-1">]</span>
  users <span class="org-haskell-operator">&lt;-</span> forM ids <span class="org-haskell-operator">$</span> <span class="org-haskell-operator">\</span> id <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-keyword">do</span>
    req <span class="org-haskell-operator">&lt;-</span> parseRequest <span class="org-haskell-operator">$</span> <span class="org-string">"http://localhost:3000/users/"</span> <span class="org-haskell-operator">++</span> show id
    resp <span class="org-haskell-operator">&lt;-</span> httpLbs req mgr
    <span class="org-haskell-keyword">let</span> <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-haskell-constructor">Just</span> <span class="org-rainbow-delimiters-depth-2">(</span>user<span class="org-haskell-constructor">:</span><span class="org-haskell-keyword">_</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-haskell-operator">=</span> decode <span class="org-rainbow-delimiters-depth-1">(</span>responseBody resp<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-type">Maybe</span> <span class="org-rainbow-delimiters-depth-1">[</span><span class="org-haskell-type">User</span><span class="org-rainbow-delimiters-depth-1">]</span>
    return user
  return <span class="org-haskell-operator">$</span> foldl <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-haskell-operator">\</span> map <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-haskell-constructor">User</span> id name<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-haskell-operator">-&gt;</span> M.insert id name map<span class="org-rainbow-delimiters-depth-1">)</span> M.empty users
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf418a26" class="outline-2">
<h2 id="orgf418a26">Generating programs</h2>
<div class="outline-text-2" id="text-orgf418a26">
<p>
My approach to generating a program is based on the idea that given a certain
state there is only a limited number of possible calls that make sense. Given a
model <code>m</code> it makes sense to make one of the following calls:
</p>

<ul class="org-ul">
<li>add a new user</li>
<li>delete an existing user</li>
<li>end the program</li>
</ul>

<p>
Based on this writing <code>genProgram</code> is rather straight forward
</p>

<div class="org-src-container">
<pre class="src src-haskell"><span class="org-haskell-definition">genProgram</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-type">Gen</span> <span class="org-haskell-type">Program</span>
<span class="org-haskell-definition">genProgram</span> <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">Prog</span> <span class="org-haskell-operator">&lt;$&gt;</span> go M.empty
  <span class="org-haskell-keyword">where</span>
    possibleAddUser <span class="org-haskell-keyword">_</span> <span class="org-haskell-operator">=</span> <span class="org-rainbow-delimiters-depth-1">[</span><span class="org-haskell-constructor">AddUser</span> <span class="org-haskell-operator">&lt;$&gt;</span> arbitrary<span class="org-rainbow-delimiters-depth-1">]</span>
    possibleDeleteUser m <span class="org-haskell-operator">=</span> map <span class="org-rainbow-delimiters-depth-1">(</span>return <span class="org-haskell-operator">.</span> <span class="org-haskell-constructor">DeleteUser</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-rainbow-delimiters-depth-1">(</span>M.keys m<span class="org-rainbow-delimiters-depth-1">)</span>
    possibleEndProgram <span class="org-haskell-keyword">_</span> <span class="org-haskell-operator">=</span> <span class="org-rainbow-delimiters-depth-1">[</span>return <span class="org-haskell-constructor">EndProgram</span><span class="org-rainbow-delimiters-depth-1">]</span>

    go m <span class="org-haskell-operator">=</span> <span class="org-haskell-keyword">do</span>
      <span class="org-haskell-keyword">let</span> possibles <span class="org-haskell-operator">=</span> possibleDeleteUser m <span class="org-haskell-operator">++</span> possibleAddUser m <span class="org-haskell-operator">++</span> possibleEndProgram m
      s <span class="org-haskell-operator">&lt;-</span> oneof possibles
      <span class="org-haskell-keyword">let</span> m' <span class="org-haskell-operator">=</span> simulateCall m s
      <span class="org-haskell-keyword">case</span> s <span class="org-haskell-keyword">of</span>
        <span class="org-haskell-constructor">EndProgram</span> <span class="org-haskell-operator">-&gt;</span> return <span class="org-haskell-constructor"><span class="org-rainbow-delimiters-depth-1">[]</span></span>
        <span class="org-haskell-keyword">_</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-rainbow-delimiters-depth-1">(</span>s<span class="org-haskell-constructor">:</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-haskell-operator">&lt;$&gt;</span> go m'
</pre>
</div>

<p>
Armed with that the <code>Arbitrary</code> instance for <code>Program</code> can be implemented as<sup><a id="fnr.1" class="footref" href="#fn.1">1</a></sup>
</p>

<div class="org-src-container">
<pre class="src src-haskell"><span class="org-haskell-keyword">instance</span> <span class="org-haskell-type">Arbitrary</span> <span class="org-haskell-type">Program</span> <span class="org-haskell-keyword">where</span>
  arbitrary <span class="org-haskell-operator">=</span> genProgram
  shrink p <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor"><span class="org-rainbow-delimiters-depth-1">[]</span></span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orge02a7fa" class="outline-2">
<h2 id="orge02a7fa">The property of an API</h2>
<div class="outline-text-2" id="text-orge02a7fa">
<p>
The steps in the <a href="#orgd2e8eeb">first section</a> can be used as a recipe for writing the property
</p>

<div class="org-src-container">
<pre class="src src-haskell"><span class="org-haskell-definition">prop_progCorrectness</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-type">Program</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-type">Property</span>
<span class="org-haskell-definition">prop_progCorrectness</span> program <span class="org-haskell-operator">=</span> monadicIO <span class="org-haskell-operator">$</span> <span class="org-haskell-keyword">do</span>
  <span class="org-haskell-keyword">let</span> simulatedModel <span class="org-haskell-operator">=</span> simulateProgram program
  runModel <span class="org-haskell-operator">&lt;-</span> run <span class="org-haskell-operator">$</span> runProgram program
  assert <span class="org-haskell-operator">$</span> simulatedModel <span class="org-haskell-operator">==</span> runModel
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd44c20f" class="outline-2">
<h2 id="orgd44c20f">What next?</h2>
<div class="outline-text-2" id="text-orgd44c20f">
<p>
There are some improvements that I'd like to make:
</p>

<ul class="org-ul">
<li>Make the generation of <code>Program</code> better in the sense that the programs become
longer. I think this is important as I start tackling larger APIs.</li>
<li>Write an implementation of <code>shrink</code> for <code>Program</code>. With longer programs it's
of course more important to actually implement <code>shrink</code>.</li>
</ul>

<p>
I'd love to hear if others are using <a href="https://hackage.haskell.org/package/QuickCheck">QuickCheck</a> to test REST APIs in some way,
if anyone has suggestions for improvements, and of course ideas for how to
implement <code>shrink</code> in a nice way.
</p>
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" class="footnum" href="#fnr.1">1</a></sup> <div class="footpara"><p class="footpara">
Yes, I completely skip the issue of shrinking programs at this point.
This is OK at this point though, because the generated =Programs=s do end up to
be very short indeed.
</p></div></div>


</div>
</div><div class="taglist"><a href="https://magnus.therning.org/tags.html">Tags</a>: <a href="https://magnus.therning.org/tag-emacs.html">emacs</a> <a href="https://magnus.therning.org/tag-haskell.html">haskell</a> <a href="https://magnus.therning.org/tag-flycheck.html">flycheck</a> </div><div id="archive">
<a href="https://magnus.therning.org/archive.html">Other posts</a>
</div>
</div>
<div id="postamble" class="status"><!-- org-static-blog-page-postamble --></div>
</body>
</html>
